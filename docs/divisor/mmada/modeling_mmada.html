<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>divisor.mmada.modeling_mmada API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../mmada.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;divisor.mmada</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#dtype_by_device">dtype_by_device</a>
            </li>
            <li>
                    <a class="variable" href="#device_dtype">device_dtype</a>
            </li>
            <li>
                    <a class="function" href="#add_gumbel_noise">add_gumbel_noise</a>
            </li>
            <li>
                    <a class="function" href="#get_num_transfer_tokens">get_num_transfer_tokens</a>
            </li>
            <li>
                    <a class="class" href="#MMadaConfig">MMadaConfig</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MMadaConfig.__init__">MMadaConfig</a>
                        </li>
                        <li>
                                <a class="variable" href="#MMadaConfig.model_type">model_type</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MMadaModelLM">MMadaModelLM</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MMadaModelLM.__init__">MMadaModelLM</a>
                        </li>
                        <li>
                                <a class="variable" href="#MMadaModelLM.config_class">config_class</a>
                        </li>
                        <li>
                                <a class="variable" href="#MMadaModelLM.base_model_prefix">base_model_prefix</a>
                        </li>
                        <li>
                                <a class="function" href="#MMadaModelLM.from_pretrained">from_pretrained</a>
                        </li>
                        <li>
                                <a class="function" href="#MMadaModelLM.t2i_generate">t2i_generate</a>
                        </li>
                        <li>
                                <a class="function" href="#MMadaModelLM.forward_process">forward_process</a>
                        </li>
                        <li>
                                <a class="function" href="#MMadaModelLM.forward_process_with_r2i">forward_process_with_r2i</a>
                        </li>
                        <li>
                                <a class="function" href="#MMadaModelLM.forward_t2i">forward_t2i</a>
                        </li>
                        <li>
                                <a class="function" href="#MMadaModelLM.mmu_generate">mmu_generate</a>
                        </li>
                        <li>
                                <a class="function" href="#MMadaModelLM.mmu_generate_fast">mmu_generate_fast</a>
                        </li>
                        <li>
                                <a class="function" href="#MMadaModelLM.t2i_generate_decoding_stepwise">t2i_generate_decoding_stepwise</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../divisor.html">divisor</a><wbr>.<a href="./../mmada.html">mmada</a><wbr>.modeling_mmada    </h1>

                
                        <input id="mod-modeling_mmada-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-modeling_mmada-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1"># SPDX-License-Identifier: MIT</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="c1"># Adapted from https://github.com/Gen-Verse/MMaDA</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">nnll.init_gpu</span><span class="w"> </span><span class="kn">import</span> <span class="n">device</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.models.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoConfig</span><span class="p">,</span> <span class="n">AutoModel</span><span class="p">,</span> <span class="n">AutoModelForCausalLM</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.configuration_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">PretrainedConfig</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">divisor.mmada.modeling_llada</span><span class="w"> </span><span class="kn">import</span> <span class="n">LLaDAModelLM</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">divisor.mmada.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_schedule</span><span class="p">,</span> <span class="n">mask_by_random_topk</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="n">dtype_by_device</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>    <span class="s2">&quot;cuda&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="s2">&quot;mps&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>    <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="p">}</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="n">device_dtype</span> <span class="o">=</span> <span class="n">dtype_by_device</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="k">def</span><span class="w"> </span><span class="nf">add_gumbel_noise</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">    The Gumbel max is a method for sampling categorical distributions.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">    According to arXiv:2409.02908, for MDM, low-precision Gumbel Max improves perplexity score but reduces generation quality.</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    Thus, we use float64.</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    ... Unless we are mps, in which case we use float32.</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>    <span class="k">if</span> <span class="n">temperature</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>        <span class="k">return</span> <span class="n">logits</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device_dtype</span><span class="p">)</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">device_dtype</span><span class="p">)</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="n">gumbel_noise</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">noise</span><span class="p">))</span> <span class="o">**</span> <span class="n">temperature</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="k">return</span> <span class="n">logits</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">/</span> <span class="n">gumbel_noise</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_num_transfer_tokens</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">    In the reverse process, the interval [0, 1] is uniformly discretized into steps intervals.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">    Furthermore, because LLaDA employs a linear noise schedule (as defined in Eq. (8)),</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    the expected number of tokens transitioned at each step should be consistent.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    This function is designed to precompute the number of tokens that need to be transitioned at each step.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>    <span class="n">mask_num</span> <span class="o">=</span> <span class="n">mask_index</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="n">base</span> <span class="o">=</span> <span class="n">mask_num</span> <span class="o">//</span> <span class="n">steps</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    <span class="n">remainder</span> <span class="o">=</span> <span class="n">mask_num</span> <span class="o">%</span> <span class="n">steps</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>    <span class="n">num_transfer_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mask_num</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">steps</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">mask_index</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">base</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask_num</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="n">num_transfer_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="n">remainder</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>    <span class="k">return</span> <span class="n">num_transfer_tokens</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MMadaConfig</span><span class="p">(</span><span class="n">PretrainedConfig</span><span class="p">):</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;mmada&quot;</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="n">allowed_keys</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="s2">&quot;vocab_size&quot;</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>            <span class="s2">&quot;llm_vocab_size&quot;</span><span class="p">,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>            <span class="s2">&quot;llm_model_path&quot;</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>            <span class="s2">&quot;codebook_size&quot;</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>            <span class="s2">&quot;num_vq_tokens&quot;</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>            <span class="s2">&quot;num_new_special_tokens&quot;</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="s2">&quot;gradient_checkpointing&quot;</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="s2">&quot;new_vocab_size&quot;</span><span class="p">,</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="p">]</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MMadaModelLM</span><span class="p">(</span><span class="n">LLaDAModelLM</span><span class="p">):</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="n">config_class</span> <span class="o">=</span> <span class="n">MMadaConfig</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>    <span class="n">base_model_prefix</span> <span class="o">=</span> <span class="s2">&quot;model&quot;</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_pretrained</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="o">*</span><span class="n">model_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Override from_pretrained to inject repo_id into config.&quot;&quot;&quot;</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="n">repo_id</span> <span class="o">=</span> <span class="n">pretrained_model_name_or_path</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="c1"># Load config first and inject repo_id BEFORE calling super().from_pretrained</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="c1"># This ensures repo_id is available during __init__</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_class</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config_kwargs&quot;</span><span class="p">,</span> <span class="p">{}))</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;repo_id&quot;</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">)</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="c1"># Update kwargs to pass the modified config</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="c1"># Now call parent&#39;s from_pretrained with the modified config</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="o">*</span><span class="n">model_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">MMadaConfig</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing MMadaModelLM with config: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="c1"># # resize token embeddings</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="c1"># print(f&quot;Resizing token embeddings to {config.new_vocab_size}&quot;)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="c1"># self.resize_token_embeddings(config.new_vocab_size)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">t2i_generate</span><span class="p">(</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="n">uncond_input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="n">uncond_attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="n">timesteps</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>  <span class="c1"># ideal number of steps is 18 in maskgit paper</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="n">guidance_scale</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="n">noise_schedule</span><span class="o">=</span><span class="n">cosine_schedule</span><span class="p">,</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="n">generator</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="n">seq_len</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="n">mask_token_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="n">resolution</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="n">codebook_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="p">):</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        Generate 1:1 similar to the original MaskGit repo</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="c1"># begin with all image token ids masked</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="c1"># mask token</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="n">mask_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_ids</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="n">num_vq_tokens</span> <span class="o">=</span> <span class="n">seq_len</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="n">num_new_special_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="n">uni_prompting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uni_prompting&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="c1"># print(f&quot;config.model.mmada.llm_vocab_size: {config.model.mmada.llm_vocab_size}, {len(uni_prompting.text_tokenizer)}&quot;)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_new_special_tokens</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="c1"># for classifier-free guidance</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="n">uncond_prefix</span> <span class="o">=</span> <span class="n">uncond_input_ids</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span><span class="p">):</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">guidance_scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>                <span class="n">uncond_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">uncond_prefix</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                <span class="n">model_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">uncond_input_ids</span><span class="p">])</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>                <span class="n">all_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">uncond_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">all_attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>                <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                <span class="n">cond_logits</span><span class="p">,</span> <span class="n">uncond_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                <span class="c1"># logits = uncond_logits + guidance_scale * (cond_logits - uncond_logits)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                <span class="c1"># it seems that muse has a different cfg setting</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">guidance_scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond_logits</span> <span class="o">-</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="n">uncond_logits</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>                    <span class="p">:,</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>                <span class="p">]</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>                    <span class="p">:,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>                <span class="p">]</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="c1"># logits: 1, 1024, 8192</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="c1"># print(f&quot;probs: {probs}, probs.shape: {probs.shape}, sampled: {sampled}, sampled.shape: {sampled.shape}&quot;)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">sampled</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 1, 1024</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="n">unknown_map</span> <span class="o">=</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            <span class="c1"># print(f&quot;unknown_map.sum(dim=-1, keepdim=True): {unknown_map.sum(dim=-1, keepdim=True)}&quot;)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span><span class="p">)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>            <span class="c1"># Defines the mask ratio for the next round. The number to mask out is</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>            <span class="c1"># determined by mask_ratio * unknown_number_in_the_beginning.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">timesteps</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="n">mask_ratio</span> <span class="o">=</span> <span class="n">noise_schedule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="c1"># Computes the probabilities of each selected tokens.</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="o">.</span><span class="n">long</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">selected_probs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="c1"># Ignores the tokens given in the input by overwriting their confidence.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">selected_probs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>            <span class="c1"># Gets mask lens for each sample in the batch according to the mask ratio.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">*</span> <span class="n">mask_ratio</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>            <span class="c1"># Keeps at least one of prediction in this round and also masks out at least</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>            <span class="c1"># one and for the next iteration</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">unknown_map</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">))</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>            <span class="c1"># print(f&quot;mask_len: {mask_len}, mask_len.shape: {mask_len.shape}&quot;)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>            <span class="c1"># Adds noise for randomness</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>            <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>            <span class="n">masking</span> <span class="o">=</span> <span class="n">mask_by_random_topk</span><span class="p">(</span><span class="n">mask_len</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="c1"># Masks tokens with lower confidence.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">return</span> <span class="n">sampled_ids</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_process</span><span class="p">(</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="n">input_ids</span><span class="p">,</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="n">labels</span><span class="p">,</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="n">batch_size_lm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="n">batch_size_mmu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>        <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="n">p_mask_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="n">p_mask_mmu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="n">answer_lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="n">answer_lengths_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>    <span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>        <span class="c1"># attention bias, True for batch_size, 1, seq_len, seq_len</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="n">attention_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="n">attention_bias_t2i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2i_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">t2i_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="n">attention_bias</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_bias_t2i</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="k">if</span> <span class="n">batch_size_t2i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="n">logits</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                <span class="n">labels</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="n">masked_indices</span> <span class="o">=</span> <span class="n">input_ids</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mask_token_id</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="n">masked_indices_lm</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="n">masked_indices_mmu</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:]</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="n">p_mask_lm</span> <span class="o">=</span> <span class="n">p_mask_lm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_lm</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="n">p_mask_mmu</span> <span class="o">=</span> <span class="n">p_mask_mmu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="n">answer_lengths</span> <span class="o">=</span> <span class="n">answer_lengths</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="n">loss_lm</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="o">/</span> <span class="n">p_mask_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">]</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>        <span class="k">if</span> <span class="n">answer_lengths_lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_lm</span> <span class="o">/</span> <span class="n">answer_lengths_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">loss_lm</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                <span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                <span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            <span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="o">/</span> <span class="n">p_mask_mmu</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">]</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="p">)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_mmu</span> <span class="o">/</span> <span class="n">answer_lengths</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">loss_t2i</span><span class="p">,</span> <span class="n">loss_lm</span><span class="p">,</span> <span class="n">loss_mmu</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_process_with_r2i</span><span class="p">(</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="n">input_ids</span><span class="p">,</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="n">labels</span><span class="p">,</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="n">batch_size_lm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="n">batch_size_mmu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="n">batch_size_r2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>        <span class="n">p_mask_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="n">p_mask_mmu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="n">p_mask_r2i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="n">answer_lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="n">answer_lengths_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="n">answer_lengths_r2i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>    <span class="p">):</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="c1"># attention bias, True for batch_size, 1, seq_len, seq_len</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="n">attention_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="n">attention_bias_t2i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2i_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">t2i_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="n">attention_bias</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_bias_t2i</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="c1"># logits = self(input_ids).logits</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="n">batch_size_t2i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="c1"># t2i loss</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                <span class="n">logits</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="n">labels</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="c1"># llada loss</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="n">start_lm</span> <span class="o">=</span> <span class="n">batch_size_t2i</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="n">end_lm</span> <span class="o">=</span> <span class="n">start_lm</span> <span class="o">+</span> <span class="n">batch_size_lm</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="n">start_mmu</span> <span class="o">=</span> <span class="n">end_lm</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="n">end_mmu</span> <span class="o">=</span> <span class="n">start_mmu</span> <span class="o">+</span> <span class="n">batch_size_mmu</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="n">start_r2i</span> <span class="o">=</span> <span class="n">end_mmu</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="n">end_r2i</span> <span class="o">=</span> <span class="n">start_r2i</span> <span class="o">+</span> <span class="n">batch_size_r2i</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        <span class="n">masked_indices</span> <span class="o">=</span> <span class="n">input_ids</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mask_token_id</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="n">masked_indices_lm</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="n">masked_indices_mmu</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">]</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="n">masked_indices_r2i</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">]</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="n">p_mask_lm</span> <span class="o">=</span> <span class="n">p_mask_lm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_lm</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="n">p_mask_mmu</span> <span class="o">=</span> <span class="n">p_mask_mmu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="n">p_mask_r2i</span> <span class="o">=</span> <span class="n">p_mask_r2i</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_r2i</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="n">answer_lengths</span> <span class="o">=</span> <span class="n">answer_lengths</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="n">answer_lengths_lm</span> <span class="o">=</span> <span class="n">answer_lengths_lm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_lm</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="n">answer_lengths_r2i</span> <span class="o">=</span> <span class="n">answer_lengths_r2i</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_r2i</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="n">loss_lm</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            <span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>            <span class="o">/</span> <span class="n">p_mask_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">]</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>        <span class="p">)</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="k">if</span> <span class="n">answer_lengths_lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_lm</span> <span class="o">/</span> <span class="n">answer_lengths_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">loss_lm</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>            <span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            <span class="o">/</span> <span class="n">p_mask_mmu</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">]</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_mmu</span> <span class="o">/</span> <span class="n">answer_lengths</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="n">loss_r2i</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">][</span><span class="n">masked_indices_r2i</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">][</span><span class="n">masked_indices_r2i</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="o">/</span> <span class="n">p_mask_r2i</span><span class="p">[</span><span class="n">masked_indices_r2i</span><span class="p">]</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="n">loss_r2i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_r2i</span> <span class="o">/</span> <span class="n">answer_lengths_r2i</span><span class="p">[</span><span class="n">masked_indices_r2i</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">loss_t2i</span><span class="p">,</span> <span class="n">loss_lm</span><span class="p">,</span> <span class="n">loss_mmu</span><span class="p">,</span> <span class="n">loss_r2i</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_t2i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="c1"># attention bias, True for batch_size, 1, seq_len, seq_len</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="n">attention_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="n">attention_bias_t2i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2i_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">t2i_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="n">attention_bias</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_bias_t2i</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="c1"># logits = self(input_ids).logits</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="c1"># print(f&quot;logits shape: {logits.shape}&quot;) B, 359, vocab_size</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            <span class="n">logits</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="n">labels</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="k">return</span> <span class="n">loss_t2i</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mmu_generate</span><span class="p">(</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="n">input_embeddings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="n">steps</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>        <span class="n">block_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="n">top_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="n">eot_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>        <span class="n">cfg_scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>        <span class="n">remasking</span><span class="o">=</span><span class="s2">&quot;low_confidence&quot;</span><span class="p">,</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="n">mask_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>    <span class="p">):</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="sd">        Take a conditioning sequence of indices idx (LongTensor of shape (b,t)) and complete</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">        the sequence max_new_tokens times, feeding the predictions back into the model each time.</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">        Most likely you&#39;ll want to make sure to be in model.eval() mode of operation for this.</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="ow">in</span> <span class="n">attention_mask</span><span class="p">:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="c1"># print(f&quot;attention_bias: {attention_bias}&quot;)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">input_embeddings</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_new_tokens</span><span class="p">),</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="n">prompt_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">mask_id</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="k">assert</span> <span class="n">max_new_tokens</span> <span class="o">%</span> <span class="n">block_length</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">max_new_tokens</span> <span class="o">//</span> <span class="n">block_length</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="k">assert</span> <span class="n">steps</span> <span class="o">%</span> <span class="n">num_blocks</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">//</span> <span class="n">num_blocks</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="c1"># print(f&quot;num_blocks: {num_blocks}, steps: {steps}&quot;)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="c1"># num_transfer_tokens = get_num_transfer_tokens(prompt_index, steps)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="k">for</span> <span class="n">num_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="n">block_mask_index</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_block</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="n">num_transfer_tokens</span> <span class="o">=</span> <span class="n">get_num_transfer_tokens</span><span class="p">(</span><span class="n">block_mask_index</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="c1"># num_transfer_tokens = get_num_transfer_tokens(prompt_index, steps)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="c1"># print(f&quot;num_transfer_tokens: {num_transfer_tokens}, num_transfer_tokens.shape: {num_transfer_tokens.shape}&quot;)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>                <span class="n">mask_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>                <span class="k">if</span> <span class="n">cfg_scale</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>                    <span class="n">un_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                    <span class="n">un_x</span><span class="p">[</span><span class="n">prompt_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                    <span class="n">x_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">un_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>                    <span class="n">logits</span><span class="p">,</span> <span class="n">un_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="n">un_logits</span> <span class="o">+</span> <span class="p">(</span><span class="n">cfg_scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="n">un_logits</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                <span class="n">logits_with_noise</span> <span class="o">=</span> <span class="n">add_gumbel_noise</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits_with_noise</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>                <span class="k">if</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;low_confidence&quot;</span><span class="p">:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                    <span class="n">p</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device_dtype</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>                <span class="k">elif</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">remasking</span><span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                <span class="n">x0_p</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0_p</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="n">transfer_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">confidence</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">select_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">confidence</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">num_transfer_tokens</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                    <span class="n">transfer_index</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">select_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                <span class="n">x</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>            <span class="c1"># logits = logits[:, -1, :] / temperature</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="c1"># # optionally crop the logits to only the top k options</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>            <span class="c1"># if top_k is not None:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>            <span class="c1">#     v, _ = torch.topk(logits, min(top_k, logits.size(-1)))</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="c1">#     logits[logits &lt; v[:, [-1]]] = -float(&#39;Inf&#39;)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="c1"># # apply softmax to convert logits to (normalized) probabilities</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            <span class="c1"># probs = F.softmax(logits, dim=-1)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="c1"># # sample from the distribution</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="c1"># idx_next = torch.multinomial(probs, num_samples=1)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>            <span class="c1"># result.append(idx_next[0][0])</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>            <span class="c1"># # append sampled index to the running sequence and continue</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="c1"># if self.config.w_clip_vit:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="c1">#     idx_next_embeddings = self.mmada.model.embed_tokens(idx_next)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>            <span class="c1">#     input_embeddings = torch.cat([input_embeddings, idx_next_embeddings], dim=1)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>            <span class="c1"># else:</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>            <span class="c1">#     idx = torch.cat((idx, idx_next), dim=1)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>            <span class="c1"># if eot_token is not None and idx_next.cpu() == eot_token:</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="c1">#     break</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mmu_generate_fast</span><span class="p">(</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="n">input_embeddings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="n">steps</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="n">block_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>        <span class="n">top_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>        <span class="n">eot_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="n">cfg_scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>        <span class="n">remasking</span><span class="o">=</span><span class="s2">&quot;low_confidence&quot;</span><span class="p">,</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>        <span class="n">mask_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>    <span class="p">):</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">        Take a conditioning sequence of indices idx (LongTensor of shape (b,t)) and complete</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">        the sequence max_new_tokens times, feeding the predictions back into the model each time.</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">        Most likely you&#39;ll want to make sure to be in model.eval() mode of operation for this.</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="ow">in</span> <span class="n">attention_mask</span><span class="p">:</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="c1"># print(f&quot;attention_bias: {attention_bias}&quot;)</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">input_embeddings</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_new_tokens</span><span class="p">),</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="n">prompt_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">mask_id</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="k">assert</span> <span class="n">max_new_tokens</span> <span class="o">%</span> <span class="n">block_length</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>        <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">max_new_tokens</span> <span class="o">//</span> <span class="n">block_length</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="k">assert</span> <span class="n">steps</span> <span class="o">%</span> <span class="n">num_blocks</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>        <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">//</span> <span class="n">num_blocks</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="k">for</span> <span class="n">num_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="n">block_mask_index</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_block</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="n">num_transfer_tokens</span> <span class="o">=</span> <span class="n">get_num_transfer_tokens</span><span class="p">(</span><span class="n">block_mask_index</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>                <span class="n">mask_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>                <span class="k">if</span> <span class="n">cfg_scale</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>                    <span class="n">un_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>                    <span class="n">un_x</span><span class="p">[</span><span class="n">prompt_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>                    <span class="n">x_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">un_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                    <span class="n">logits</span><span class="p">,</span> <span class="n">un_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="n">un_logits</span> <span class="o">+</span> <span class="p">(</span><span class="n">cfg_scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="n">un_logits</span><span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                <span class="n">logits_with_noise</span> <span class="o">=</span> <span class="n">add_gumbel_noise</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits_with_noise</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>                <span class="k">if</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;low_confidence&quot;</span><span class="p">:</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                    <span class="n">p</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device_dtype</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>                <span class="k">elif</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">remasking</span><span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>                <span class="n">x0_p</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0_p</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>                <span class="n">transfer_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">confidence</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">select_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">confidence</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">num_transfer_tokens</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>                    <span class="n">transfer_index</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">select_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>                <span class="n">x</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>            <span class="k">if</span> <span class="n">eot_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>                <span class="n">last_token_index_in_current_block</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>                <span class="k">if</span> <span class="n">last_token_index_in_current_block</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>                    <span class="n">tokens_at_block_end</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">last_token_index_in_current_block</span><span class="p">]</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>                    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">tokens_at_block_end</span> <span class="o">==</span> <span class="n">eot_token</span><span class="p">):</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                        <span class="k">break</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">t2i_generate_decoding_stepwise</span><span class="p">(</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>        <span class="n">uncond_input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>        <span class="n">uncond_attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>        <span class="n">timesteps</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>  <span class="c1"># ideal number of steps is 18 in maskgit paper</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>        <span class="n">guidance_scale</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>        <span class="n">noise_schedule</span><span class="o">=</span><span class="n">cosine_schedule</span><span class="p">,</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>        <span class="n">generator</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        <span class="n">seq_len</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>        <span class="n">mask_token_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="n">resolution</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>        <span class="n">codebook_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="n">vq_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>    <span class="p">):</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a><span class="sd">        Generate 1:1 similar to the original MaskGit repo</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a><span class="sd">        https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>        <span class="c1"># begin with all image token ids masked</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>        <span class="c1"># mask token</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>        <span class="n">mask_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_ids</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>        <span class="n">num_vq_tokens</span> <span class="o">=</span> <span class="n">seq_len</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>        <span class="n">num_new_special_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>        <span class="n">uni_prompting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uni_prompting&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        <span class="c1"># print(f&quot;config.model.mmada.llm_vocab_size: {config.model.mmada.llm_vocab_size}, {len(uni_prompting.text_tokenizer)}&quot;)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_new_special_tokens</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="c1"># for classifier-free guidance</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>        <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>            <span class="n">uncond_prefix</span> <span class="o">=</span> <span class="n">uncond_input_ids</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span><span class="p">):</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">guidance_scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>                <span class="n">uncond_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">uncond_prefix</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>                <span class="n">model_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">uncond_input_ids</span><span class="p">])</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>                <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">uncond_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>                <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>                <span class="n">cond_logits</span><span class="p">,</span> <span class="n">uncond_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                <span class="c1"># logits = uncond_logits + guidance_scale * (cond_logits - uncond_logits)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                <span class="c1"># it seems that muse has a different cfg setting</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">guidance_scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond_logits</span> <span class="o">-</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="n">uncond_logits</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>                    <span class="p">:,</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>                <span class="p">]</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>                    <span class="p">:,</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>                <span class="p">]</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>            <span class="c1"># logits: 1, 1024, 8192</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>            <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="c1"># print(f&quot;probs: {probs}, probs.shape: {probs.shape}, sampled: {sampled}, sampled.shape: {sampled.shape}&quot;)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">sampled</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 1, 1024</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>            <span class="n">unknown_map</span> <span class="o">=</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>            <span class="c1"># print(f&quot;unknown_map.sum(dim=-1, keepdim=True): {unknown_map.sum(dim=-1, keepdim=True)}&quot;)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span><span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>            <span class="c1"># Defines the mask ratio for the next round. The number to mask out is</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>            <span class="n">current_image_vq_indices</span> <span class="o">=</span> <span class="n">sampled_ids</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>            <span class="c1"># print(f&quot;current_image_vq_indices: {current_image_vq_indices}&quot;)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>            <span class="n">current_image_vq_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">current_image_vq_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8192</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>            <span class="n">current_image</span> <span class="o">=</span> <span class="n">vq_model</span><span class="o">.</span><span class="n">decode_code</span><span class="p">(</span><span class="n">current_image_vq_indices</span><span class="p">)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">current_image</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>            <span class="n">images</span> <span class="o">*=</span> <span class="mf">255.0</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>            <span class="n">pil_images</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>            <span class="k">yield</span> <span class="n">pil_images</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">timesteps</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>            <span class="c1"># determined by mask_ratio * unknown_number_in_the_beginning.</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">timesteps</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>            <span class="n">mask_ratio</span> <span class="o">=</span> <span class="n">noise_schedule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="c1"># Computes the probabilities of each selected tokens.</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="o">.</span><span class="n">long</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">selected_probs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>            <span class="c1"># Ignores the tokens given in the input by overwriting their confidence.</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">selected_probs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>            <span class="c1"># Gets mask lens for each sample in the batch according to the mask ratio.</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">*</span> <span class="n">mask_ratio</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="c1"># Keeps at least one of prediction in this round and also masks out at least</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="c1"># one and for the next iteration</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">unknown_map</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">))</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>            <span class="c1"># print(f&quot;mask_len: {mask_len}, mask_len.shape: {mask_len.shape}&quot;)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>            <span class="c1"># Adds noise for randomness</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>            <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>            <span class="n">masking</span> <span class="o">=</span> <span class="n">mask_by_random_topk</span><span class="p">(</span><span class="n">mask_len</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>            <span class="c1"># Masks tokens with lower confidence.</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>            <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span><span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>        <span class="k">return</span> <span class="n">sampled_ids</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a><span class="n">AutoConfig</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;mmada&quot;</span><span class="p">,</span> <span class="n">MMadaConfig</span><span class="p">)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a><span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MMadaConfig</span><span class="p">,</span> <span class="n">MMadaModelLM</span><span class="p">)</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a><span class="n">AutoModel</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MMadaConfig</span><span class="p">,</span> <span class="n">MMadaModelLM</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="dtype_by_device">
                    <div class="attr variable">
            <span class="name">dtype_by_device</span>        =
<span class="default_value">{&#39;cuda&#39;: torch.bfloat16, &#39;mps&#39;: torch.float32, &#39;cpu&#39;: torch.float32}</span>

        
    </div>
    <a class="headerlink" href="#dtype_by_device"></a>
    
    

                </section>
                <section id="device_dtype">
                    <div class="attr variable">
            <span class="name">device_dtype</span>        =
<span class="default_value">torch.float32</span>

        
    </div>
    <a class="headerlink" href="#device_dtype"></a>
    
    

                </section>
                <section id="add_gumbel_noise">
                            <input id="add_gumbel_noise-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_gumbel_noise</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">logits</span>, </span><span class="param"><span class="n">temperature</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="add_gumbel_noise-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#add_gumbel_noise"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="add_gumbel_noise-26"><a href="#add_gumbel_noise-26"><span class="linenos">26</span></a><span class="k">def</span><span class="w"> </span><span class="nf">add_gumbel_noise</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>
</span><span id="add_gumbel_noise-27"><a href="#add_gumbel_noise-27"><span class="linenos">27</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="add_gumbel_noise-28"><a href="#add_gumbel_noise-28"><span class="linenos">28</span></a><span class="sd">    The Gumbel max is a method for sampling categorical distributions.</span>
</span><span id="add_gumbel_noise-29"><a href="#add_gumbel_noise-29"><span class="linenos">29</span></a><span class="sd">    According to arXiv:2409.02908, for MDM, low-precision Gumbel Max improves perplexity score but reduces generation quality.</span>
</span><span id="add_gumbel_noise-30"><a href="#add_gumbel_noise-30"><span class="linenos">30</span></a><span class="sd">    Thus, we use float64.</span>
</span><span id="add_gumbel_noise-31"><a href="#add_gumbel_noise-31"><span class="linenos">31</span></a><span class="sd">    ... Unless we are mps, in which case we use float32.</span>
</span><span id="add_gumbel_noise-32"><a href="#add_gumbel_noise-32"><span class="linenos">32</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="add_gumbel_noise-33"><a href="#add_gumbel_noise-33"><span class="linenos">33</span></a>    <span class="k">if</span> <span class="n">temperature</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="add_gumbel_noise-34"><a href="#add_gumbel_noise-34"><span class="linenos">34</span></a>        <span class="k">return</span> <span class="n">logits</span>
</span><span id="add_gumbel_noise-35"><a href="#add_gumbel_noise-35"><span class="linenos">35</span></a>    <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device_dtype</span><span class="p">)</span>
</span><span id="add_gumbel_noise-36"><a href="#add_gumbel_noise-36"><span class="linenos">36</span></a>    <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand_like</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">device_dtype</span><span class="p">)</span>
</span><span id="add_gumbel_noise-37"><a href="#add_gumbel_noise-37"><span class="linenos">37</span></a>    <span class="n">gumbel_noise</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">noise</span><span class="p">))</span> <span class="o">**</span> <span class="n">temperature</span>
</span><span id="add_gumbel_noise-38"><a href="#add_gumbel_noise-38"><span class="linenos">38</span></a>    <span class="k">return</span> <span class="n">logits</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">/</span> <span class="n">gumbel_noise</span>
</span></pre></div>


            <div class="docstring"><p>The Gumbel max is a method for sampling categorical distributions.
According to arXiv:2409.02908, for MDM, low-precision Gumbel Max improves perplexity score but reduces generation quality.
Thus, we use float64.
... Unless we are mps, in which case we use float32.</p>
</div>


                </section>
                <section id="get_num_transfer_tokens">
                            <input id="get_num_transfer_tokens-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_num_transfer_tokens</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mask_index</span>, </span><span class="param"><span class="n">steps</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_num_transfer_tokens-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_num_transfer_tokens"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_num_transfer_tokens-41"><a href="#get_num_transfer_tokens-41"><span class="linenos">41</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_num_transfer_tokens</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
</span><span id="get_num_transfer_tokens-42"><a href="#get_num_transfer_tokens-42"><span class="linenos">42</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_num_transfer_tokens-43"><a href="#get_num_transfer_tokens-43"><span class="linenos">43</span></a><span class="sd">    In the reverse process, the interval [0, 1] is uniformly discretized into steps intervals.</span>
</span><span id="get_num_transfer_tokens-44"><a href="#get_num_transfer_tokens-44"><span class="linenos">44</span></a><span class="sd">    Furthermore, because LLaDA employs a linear noise schedule (as defined in Eq. (8)),</span>
</span><span id="get_num_transfer_tokens-45"><a href="#get_num_transfer_tokens-45"><span class="linenos">45</span></a><span class="sd">    the expected number of tokens transitioned at each step should be consistent.</span>
</span><span id="get_num_transfer_tokens-46"><a href="#get_num_transfer_tokens-46"><span class="linenos">46</span></a>
</span><span id="get_num_transfer_tokens-47"><a href="#get_num_transfer_tokens-47"><span class="linenos">47</span></a><span class="sd">    This function is designed to precompute the number of tokens that need to be transitioned at each step.</span>
</span><span id="get_num_transfer_tokens-48"><a href="#get_num_transfer_tokens-48"><span class="linenos">48</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_num_transfer_tokens-49"><a href="#get_num_transfer_tokens-49"><span class="linenos">49</span></a>    <span class="n">mask_num</span> <span class="o">=</span> <span class="n">mask_index</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="get_num_transfer_tokens-50"><a href="#get_num_transfer_tokens-50"><span class="linenos">50</span></a>
</span><span id="get_num_transfer_tokens-51"><a href="#get_num_transfer_tokens-51"><span class="linenos">51</span></a>    <span class="n">base</span> <span class="o">=</span> <span class="n">mask_num</span> <span class="o">//</span> <span class="n">steps</span>
</span><span id="get_num_transfer_tokens-52"><a href="#get_num_transfer_tokens-52"><span class="linenos">52</span></a>    <span class="n">remainder</span> <span class="o">=</span> <span class="n">mask_num</span> <span class="o">%</span> <span class="n">steps</span>
</span><span id="get_num_transfer_tokens-53"><a href="#get_num_transfer_tokens-53"><span class="linenos">53</span></a>
</span><span id="get_num_transfer_tokens-54"><a href="#get_num_transfer_tokens-54"><span class="linenos">54</span></a>    <span class="n">num_transfer_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mask_num</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">steps</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">mask_index</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">+</span> <span class="n">base</span>
</span><span id="get_num_transfer_tokens-55"><a href="#get_num_transfer_tokens-55"><span class="linenos">55</span></a>
</span><span id="get_num_transfer_tokens-56"><a href="#get_num_transfer_tokens-56"><span class="linenos">56</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask_num</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
</span><span id="get_num_transfer_tokens-57"><a href="#get_num_transfer_tokens-57"><span class="linenos">57</span></a>        <span class="n">num_transfer_tokens</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="n">remainder</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="get_num_transfer_tokens-58"><a href="#get_num_transfer_tokens-58"><span class="linenos">58</span></a>
</span><span id="get_num_transfer_tokens-59"><a href="#get_num_transfer_tokens-59"><span class="linenos">59</span></a>    <span class="k">return</span> <span class="n">num_transfer_tokens</span>
</span></pre></div>


            <div class="docstring"><p>In the reverse process, the interval [0, 1] is uniformly discretized into steps intervals.
Furthermore, because LLaDA employs a linear noise schedule (as defined in Eq. (8)),
the expected number of tokens transitioned at each step should be consistent.</p>

<p>This function is designed to precompute the number of tokens that need to be transitioned at each step.</p>
</div>


                </section>
                <section id="MMadaConfig">
                            <input id="MMadaConfig-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MMadaConfig</span><wbr>(<span class="base">transformers.configuration_utils.PretrainedConfig</span>):

                <label class="view-source-button" for="MMadaConfig-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaConfig"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaConfig-62"><a href="#MMadaConfig-62"><span class="linenos">62</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MMadaConfig</span><span class="p">(</span><span class="n">PretrainedConfig</span><span class="p">):</span>
</span><span id="MMadaConfig-63"><a href="#MMadaConfig-63"><span class="linenos">63</span></a>    <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;mmada&quot;</span>
</span><span id="MMadaConfig-64"><a href="#MMadaConfig-64"><span class="linenos">64</span></a>
</span><span id="MMadaConfig-65"><a href="#MMadaConfig-65"><span class="linenos">65</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MMadaConfig-66"><a href="#MMadaConfig-66"><span class="linenos">66</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MMadaConfig-67"><a href="#MMadaConfig-67"><span class="linenos">67</span></a>
</span><span id="MMadaConfig-68"><a href="#MMadaConfig-68"><span class="linenos">68</span></a>        <span class="n">allowed_keys</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MMadaConfig-69"><a href="#MMadaConfig-69"><span class="linenos">69</span></a>            <span class="s2">&quot;vocab_size&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig-70"><a href="#MMadaConfig-70"><span class="linenos">70</span></a>            <span class="s2">&quot;llm_vocab_size&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig-71"><a href="#MMadaConfig-71"><span class="linenos">71</span></a>            <span class="s2">&quot;llm_model_path&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig-72"><a href="#MMadaConfig-72"><span class="linenos">72</span></a>            <span class="s2">&quot;codebook_size&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig-73"><a href="#MMadaConfig-73"><span class="linenos">73</span></a>            <span class="s2">&quot;num_vq_tokens&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig-74"><a href="#MMadaConfig-74"><span class="linenos">74</span></a>            <span class="s2">&quot;num_new_special_tokens&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig-75"><a href="#MMadaConfig-75"><span class="linenos">75</span></a>            <span class="s2">&quot;gradient_checkpointing&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig-76"><a href="#MMadaConfig-76"><span class="linenos">76</span></a>            <span class="s2">&quot;new_vocab_size&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig-77"><a href="#MMadaConfig-77"><span class="linenos">77</span></a>        <span class="p">]</span>
</span><span id="MMadaConfig-78"><a href="#MMadaConfig-78"><span class="linenos">78</span></a>
</span><span id="MMadaConfig-79"><a href="#MMadaConfig-79"><span class="linenos">79</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
</span><span id="MMadaConfig-80"><a href="#MMadaConfig-80"><span class="linenos">80</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="MMadaConfig-81"><a href="#MMadaConfig-81"><span class="linenos">81</span></a>                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Base class for all configuration classes. Handles a few parameters common to all models' configurations as well as
methods for loading/downloading/saving configurations.</p>

<p><Tip></p>

<p>A configuration file can be loaded and saved to disk. Loading the configuration file and using this file to
initialize a model does <strong>not</strong> load the model weights. It only affects the model's configuration.</p>

<p></Tip></p>

<p>Class attributes (overridden by derived classes):</p>

<ul>
<li><strong>model_type</strong> (<code>str</code>) -- An identifier for the model type, serialized into the JSON file, and used to recreate
the correct object in [<code>~transformers.AutoConfig</code>].</li>
<li><strong>has_no_defaults_at_init</strong> (<code>bool</code>) -- Whether the config class can be initialized without providing input arguments.
Some configurations requires inputs to be defined at init and have no default values, usually these are composite configs,
(but not necessarily) such as [<code>~transformers.EncoderDecoderConfig</code>] or [<code>~RagConfig</code>]. They have to be initialized from
two or more configs of type [<code>~transformers.PretrainedConfig</code>].</li>
<li><strong>keys_to_ignore_at_inference</strong> (<code>list[str]</code>) -- A list of keys to ignore by default when looking at dictionary
outputs of the model during inference.</li>
<li><strong>attribute_map</strong> (<code>dict[str, str]</code>) -- A dict that maps model specific attribute names to the standardized
naming of attributes.</li>
<li><strong>base_model_tp_plan</strong> (<code>dict[str, Any]</code>) -- A dict that maps sub-modules FQNs of a base model to a tensor
parallel plan applied to the sub-module when <code>model.tensor_parallel</code> is called.</li>
<li><strong>base_model_pp_plan</strong> (<code>dict[str, tuple[list[str]]]</code>) -- A dict that maps child-modules of a base model to a
pipeline parallel plan that enables users to place the child-module on the appropriate device.</li>
</ul>

<p>Common attributes (present in all subclasses):</p>

<ul>
<li><strong>vocab_size</strong> (<code>int</code>) -- The number of tokens in the vocabulary, which is also the first dimension of the
embeddings matrix (this attribute may be missing for models that don't have a text modality like ViT).</li>
<li><strong>hidden_size</strong> (<code>int</code>) -- The hidden size of the model.</li>
<li><strong>num_attention_heads</strong> (<code>int</code>) -- The number of attention heads used in the multi-head attention layers of the
model.</li>
<li><strong>num_hidden_layers</strong> (<code>int</code>) -- The number of blocks in the model.</li>
</ul>

<p><Tip warning={true}&gt;</p>

<p>Setting parameters for sequence generation in the model config is deprecated. For backward compatibility, loading
some of them will still be possible, but attempting to overwrite them will throw an exception -- you should set
them in a [~transformers.GenerationConfig]. Check the documentation of [~transformers.GenerationConfig] for more
information about the individual parameters.</p>

<p></Tip></p>

<p>Arg:
    name_or_path (<code>str</code>, <em>optional</em>, defaults to <code>""</code>):
        Store the string that was passed to [<code>PreTrainedModel.from_pretrained</code>] or
        [<code>TFPreTrainedModel.from_pretrained</code>] as <code>pretrained_model_name_or_path</code> if the configuration was created
        with such a method.
    output_hidden_states (<code>bool</code>, <em>optional</em>, defaults to <code>False</code>):
        Whether or not the model should return all hidden-states.
    output_attentions (<code>bool</code>, *optional*, defaults to <code>False</code>):
        Whether or not the model should returns all attentions.
    return_dict (<code>bool</code>, <em>optional</em>, defaults to <code>True</code>):
        Whether or not the model should return a [<code>~transformers.utils.ModelOutput</code>] instead of a plain tuple.
    is_encoder_decoder (<code>bool</code>, <em>optional</em>, defaults to <code>False</code>):
        Whether the model is used as an encoder/decoder or not.
    is_decoder (<code>bool</code>, *optional*, defaults to <code>False</code>):
        Whether to only use the decoder in an encoder-decoder architecture, otherwise it has no effect on
        decoder-only or encoder-only architectures.
    cross_attention_hidden_size (<code>bool</code>, <em>optional</em>):
        The hidden size of the cross-attention layer in case the model is used as a decoder in an encoder-decoder
        setting and the cross-attention hidden dimension differs from <code>self.config.hidden_size</code>.
    add_cross_attention (<code>bool</code>, <em>optional</em>, defaults to <code>False</code>):
        Whether cross-attention layers should be added to the model. Note, this option is only relevant for models
        that can be used as decoder models within the [<code>EncoderDecoderModel</code>] class, which consists of all models
        in <code>AUTO_MODELS_FOR_CAUSAL_LM</code>.
    tie_encoder_decoder (<code>bool</code>, <em>optional</em>, defaults to <code>False</code>):
        Whether all encoder weights should be tied to their equivalent decoder weights. This requires the encoder
        and decoder model to have the exact same parameter names.
    prune_heads (<code>dict[int, list[int]]</code>, <em>optional</em>, defaults to <code>{}</code>):
        Pruned heads of the model. The keys are the selected layer indices and the associated values, the list of
        heads to prune in said layer.</p>

<pre><code>    For instance `{1: [0, 2], 2: [2, 3]}` will prune heads 0 and 2 on layer 1 and heads 2 and 3 on layer 2.
chunk_size_feed_forward (`int`, *optional*, defaults to `0`):
    The chunk size of all feed forward layers in the residual attention blocks. A chunk size of `0` means that
    the feed forward layer is not chunked. A chunk size of n means that the feed forward layer processes `n` &lt;
    sequence_length embeddings at a time. For more information on feed forward chunking, see [How does Feed
    Forward Chunking work?](../glossary.html#feed-forward-chunking).

&gt; Parameters for fine-tuning tasks

architectures (`list[str]`, *optional*):
    Model architectures that can be used with the model pretrained weights.
finetuning_task (`str`, *optional*):
    Name of the task used to fine-tune the model. This can be used when converting from an original (TensorFlow
    or PyTorch) checkpoint.
id2label (`dict[int, str]`, *optional*):
    A map from index (for instance prediction index, or target index) to label.
label2id (`dict[str, int]`, *optional*):
    A map from label to index for the model.
num_labels (`int`, *optional*):
    Number of labels to use in the last layer added to the model, typically for a classification task.
task_specific_params (`dict[str, Any]`, *optional*):
    Additional keyword arguments to store for the current task.
problem_type (`str`, *optional*):
    Problem type for `XxxForSequenceClassification` models. Can be one of `"regression"`,
    `"single_label_classification"` or `"multi_label_classification"`.

&gt; Parameters linked to the tokenizer

tokenizer_class (`str`, *optional*):
    The name of the associated tokenizer class to use (if none is set, will use the tokenizer associated to the
    model by default).
prefix (`str`, *optional*):
    A specific prompt that should be added at the beginning of each text before calling the model.
bos_token_id (`int`, *optional*):
    The id of the _beginning-of-stream_ token.
pad_token_id (`int`, *optional*):
    The id of the _padding_ token.
eos_token_id (`int`, *optional*):
    The id of the _end-of-stream_ token.
decoder_start_token_id (`int`, *optional*):
    If an encoder-decoder model starts decoding with a different token than _bos_, the id of that token.
sep_token_id (`int`, *optional*):
    The id of the _separation_ token.

&gt; PyTorch specific parameters

torchscript (`bool`, *optional*, defaults to `False`):
    Whether or not the model should be used with Torchscript.
tie_word_embeddings (`bool`, *optional*, defaults to `True`):
    Whether the model's input and output word embeddings should be tied. Note that this is only relevant if the
    model has a output word embedding layer.
dtype (`str`, *optional*):
    The `dtype` of the weights. This attribute can be used to initialize the model to a non-default `dtype`
    (which is normally `float32`) and thus allow for optimal storage allocation. For example, if the saved
    model is `float16`, ideally we want to load it back using the minimal amount of memory needed to load
    `float16` weights.
</code></pre>
</div>


                            <div id="MMadaConfig.__init__" class="classattr">
                                        <input id="MMadaConfig.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MMadaConfig</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="MMadaConfig.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaConfig.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaConfig.__init__-65"><a href="#MMadaConfig.__init__-65"><span class="linenos">65</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MMadaConfig.__init__-66"><a href="#MMadaConfig.__init__-66"><span class="linenos">66</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MMadaConfig.__init__-67"><a href="#MMadaConfig.__init__-67"><span class="linenos">67</span></a>
</span><span id="MMadaConfig.__init__-68"><a href="#MMadaConfig.__init__-68"><span class="linenos">68</span></a>        <span class="n">allowed_keys</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MMadaConfig.__init__-69"><a href="#MMadaConfig.__init__-69"><span class="linenos">69</span></a>            <span class="s2">&quot;vocab_size&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig.__init__-70"><a href="#MMadaConfig.__init__-70"><span class="linenos">70</span></a>            <span class="s2">&quot;llm_vocab_size&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig.__init__-71"><a href="#MMadaConfig.__init__-71"><span class="linenos">71</span></a>            <span class="s2">&quot;llm_model_path&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig.__init__-72"><a href="#MMadaConfig.__init__-72"><span class="linenos">72</span></a>            <span class="s2">&quot;codebook_size&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig.__init__-73"><a href="#MMadaConfig.__init__-73"><span class="linenos">73</span></a>            <span class="s2">&quot;num_vq_tokens&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig.__init__-74"><a href="#MMadaConfig.__init__-74"><span class="linenos">74</span></a>            <span class="s2">&quot;num_new_special_tokens&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig.__init__-75"><a href="#MMadaConfig.__init__-75"><span class="linenos">75</span></a>            <span class="s2">&quot;gradient_checkpointing&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig.__init__-76"><a href="#MMadaConfig.__init__-76"><span class="linenos">76</span></a>            <span class="s2">&quot;new_vocab_size&quot;</span><span class="p">,</span>
</span><span id="MMadaConfig.__init__-77"><a href="#MMadaConfig.__init__-77"><span class="linenos">77</span></a>        <span class="p">]</span>
</span><span id="MMadaConfig.__init__-78"><a href="#MMadaConfig.__init__-78"><span class="linenos">78</span></a>
</span><span id="MMadaConfig.__init__-79"><a href="#MMadaConfig.__init__-79"><span class="linenos">79</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
</span><span id="MMadaConfig.__init__-80"><a href="#MMadaConfig.__init__-80"><span class="linenos">80</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="MMadaConfig.__init__-81"><a href="#MMadaConfig.__init__-81"><span class="linenos">81</span></a>                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="MMadaConfig.model_type" class="classattr">
                                <div class="attr variable">
            <span class="name">model_type</span>        =
<span class="default_value">&#39;mmada&#39;</span>

        
    </div>
    <a class="headerlink" href="#MMadaConfig.model_type"></a>
    
    

                            </div>
                </section>
                <section id="MMadaModelLM">
                            <input id="MMadaModelLM-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MMadaModelLM</span><wbr>(<span class="base"><a href="modeling_llada.html#LLaDAModelLM">divisor.mmada.modeling_llada.LLaDAModelLM</a></span>):

                <label class="view-source-button" for="MMadaModelLM-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM-84"><a href="#MMadaModelLM-84"><span class="linenos"> 84</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MMadaModelLM</span><span class="p">(</span><span class="n">LLaDAModelLM</span><span class="p">):</span>
</span><span id="MMadaModelLM-85"><a href="#MMadaModelLM-85"><span class="linenos"> 85</span></a>    <span class="n">config_class</span> <span class="o">=</span> <span class="n">MMadaConfig</span>
</span><span id="MMadaModelLM-86"><a href="#MMadaModelLM-86"><span class="linenos"> 86</span></a>    <span class="n">base_model_prefix</span> <span class="o">=</span> <span class="s2">&quot;model&quot;</span>
</span><span id="MMadaModelLM-87"><a href="#MMadaModelLM-87"><span class="linenos"> 87</span></a>
</span><span id="MMadaModelLM-88"><a href="#MMadaModelLM-88"><span class="linenos"> 88</span></a>    <span class="nd">@classmethod</span>
</span><span id="MMadaModelLM-89"><a href="#MMadaModelLM-89"><span class="linenos"> 89</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_pretrained</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="o">*</span><span class="n">model_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MMadaModelLM-90"><a href="#MMadaModelLM-90"><span class="linenos"> 90</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Override from_pretrained to inject repo_id into config.&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM-91"><a href="#MMadaModelLM-91"><span class="linenos"> 91</span></a>        <span class="n">repo_id</span> <span class="o">=</span> <span class="n">pretrained_model_name_or_path</span>
</span><span id="MMadaModelLM-92"><a href="#MMadaModelLM-92"><span class="linenos"> 92</span></a>
</span><span id="MMadaModelLM-93"><a href="#MMadaModelLM-93"><span class="linenos"> 93</span></a>        <span class="c1"># Load config first and inject repo_id BEFORE calling super().from_pretrained</span>
</span><span id="MMadaModelLM-94"><a href="#MMadaModelLM-94"><span class="linenos"> 94</span></a>        <span class="c1"># This ensures repo_id is available during __init__</span>
</span><span id="MMadaModelLM-95"><a href="#MMadaModelLM-95"><span class="linenos"> 95</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_class</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config_kwargs&quot;</span><span class="p">,</span> <span class="p">{}))</span>
</span><span id="MMadaModelLM-96"><a href="#MMadaModelLM-96"><span class="linenos"> 96</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;repo_id&quot;</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">)</span>
</span><span id="MMadaModelLM-97"><a href="#MMadaModelLM-97"><span class="linenos"> 97</span></a>
</span><span id="MMadaModelLM-98"><a href="#MMadaModelLM-98"><span class="linenos"> 98</span></a>        <span class="c1"># Update kwargs to pass the modified config</span>
</span><span id="MMadaModelLM-99"><a href="#MMadaModelLM-99"><span class="linenos"> 99</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="MMadaModelLM-100"><a href="#MMadaModelLM-100"><span class="linenos">100</span></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="MMadaModelLM-101"><a href="#MMadaModelLM-101"><span class="linenos">101</span></a>
</span><span id="MMadaModelLM-102"><a href="#MMadaModelLM-102"><span class="linenos">102</span></a>        <span class="c1"># Now call parent&#39;s from_pretrained with the modified config</span>
</span><span id="MMadaModelLM-103"><a href="#MMadaModelLM-103"><span class="linenos">103</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="o">*</span><span class="n">model_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MMadaModelLM-104"><a href="#MMadaModelLM-104"><span class="linenos">104</span></a>
</span><span id="MMadaModelLM-105"><a href="#MMadaModelLM-105"><span class="linenos">105</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="MMadaModelLM-106"><a href="#MMadaModelLM-106"><span class="linenos">106</span></a>
</span><span id="MMadaModelLM-107"><a href="#MMadaModelLM-107"><span class="linenos">107</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">MMadaConfig</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MMadaModelLM-108"><a href="#MMadaModelLM-108"><span class="linenos">108</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing MMadaModelLM with config: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MMadaModelLM-109"><a href="#MMadaModelLM-109"><span class="linenos">109</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MMadaModelLM-110"><a href="#MMadaModelLM-110"><span class="linenos">110</span></a>
</span><span id="MMadaModelLM-111"><a href="#MMadaModelLM-111"><span class="linenos">111</span></a>        <span class="c1"># # resize token embeddings</span>
</span><span id="MMadaModelLM-112"><a href="#MMadaModelLM-112"><span class="linenos">112</span></a>        <span class="c1"># print(f&quot;Resizing token embeddings to {config.new_vocab_size}&quot;)</span>
</span><span id="MMadaModelLM-113"><a href="#MMadaModelLM-113"><span class="linenos">113</span></a>        <span class="c1"># self.resize_token_embeddings(config.new_vocab_size)</span>
</span><span id="MMadaModelLM-114"><a href="#MMadaModelLM-114"><span class="linenos">114</span></a>
</span><span id="MMadaModelLM-115"><a href="#MMadaModelLM-115"><span class="linenos">115</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="MMadaModelLM-116"><a href="#MMadaModelLM-116"><span class="linenos">116</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">t2i_generate</span><span class="p">(</span>
</span><span id="MMadaModelLM-117"><a href="#MMadaModelLM-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM-118"><a href="#MMadaModelLM-118"><span class="linenos">118</span></a>        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-119"><a href="#MMadaModelLM-119"><span class="linenos">119</span></a>        <span class="n">uncond_input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-120"><a href="#MMadaModelLM-120"><span class="linenos">120</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-121"><a href="#MMadaModelLM-121"><span class="linenos">121</span></a>        <span class="n">uncond_attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-122"><a href="#MMadaModelLM-122"><span class="linenos">122</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="MMadaModelLM-123"><a href="#MMadaModelLM-123"><span class="linenos">123</span></a>        <span class="n">timesteps</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>  <span class="c1"># ideal number of steps is 18 in maskgit paper</span>
</span><span id="MMadaModelLM-124"><a href="#MMadaModelLM-124"><span class="linenos">124</span></a>        <span class="n">guidance_scale</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM-125"><a href="#MMadaModelLM-125"><span class="linenos">125</span></a>        <span class="n">noise_schedule</span><span class="o">=</span><span class="n">cosine_schedule</span><span class="p">,</span>
</span><span id="MMadaModelLM-126"><a href="#MMadaModelLM-126"><span class="linenos">126</span></a>        <span class="n">generator</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-127"><a href="#MMadaModelLM-127"><span class="linenos">127</span></a>        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-128"><a href="#MMadaModelLM-128"><span class="linenos">128</span></a>        <span class="n">seq_len</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="MMadaModelLM-129"><a href="#MMadaModelLM-129"><span class="linenos">129</span></a>        <span class="n">mask_token_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="MMadaModelLM-130"><a href="#MMadaModelLM-130"><span class="linenos">130</span></a>        <span class="n">resolution</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span><span id="MMadaModelLM-131"><a href="#MMadaModelLM-131"><span class="linenos">131</span></a>        <span class="n">codebook_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
</span><span id="MMadaModelLM-132"><a href="#MMadaModelLM-132"><span class="linenos">132</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="MMadaModelLM-133"><a href="#MMadaModelLM-133"><span class="linenos">133</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM-134"><a href="#MMadaModelLM-134"><span class="linenos">134</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM-135"><a href="#MMadaModelLM-135"><span class="linenos">135</span></a><span class="sd">        Generate 1:1 similar to the original MaskGit repo</span>
</span><span id="MMadaModelLM-136"><a href="#MMadaModelLM-136"><span class="linenos">136</span></a><span class="sd">        https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79</span>
</span><span id="MMadaModelLM-137"><a href="#MMadaModelLM-137"><span class="linenos">137</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MMadaModelLM-138"><a href="#MMadaModelLM-138"><span class="linenos">138</span></a>
</span><span id="MMadaModelLM-139"><a href="#MMadaModelLM-139"><span class="linenos">139</span></a>        <span class="c1"># begin with all image token ids masked</span>
</span><span id="MMadaModelLM-140"><a href="#MMadaModelLM-140"><span class="linenos">140</span></a>        <span class="c1"># mask token</span>
</span><span id="MMadaModelLM-141"><a href="#MMadaModelLM-141"><span class="linenos">141</span></a>        <span class="n">mask_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_ids</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MMadaModelLM-142"><a href="#MMadaModelLM-142"><span class="linenos">142</span></a>        <span class="n">num_vq_tokens</span> <span class="o">=</span> <span class="n">seq_len</span>
</span><span id="MMadaModelLM-143"><a href="#MMadaModelLM-143"><span class="linenos">143</span></a>        <span class="n">num_new_special_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MMadaModelLM-144"><a href="#MMadaModelLM-144"><span class="linenos">144</span></a>        <span class="n">uni_prompting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uni_prompting&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="MMadaModelLM-145"><a href="#MMadaModelLM-145"><span class="linenos">145</span></a>        <span class="c1"># print(f&quot;config.model.mmada.llm_vocab_size: {config.model.mmada.llm_vocab_size}, {len(uni_prompting.text_tokenizer)}&quot;)</span>
</span><span id="MMadaModelLM-146"><a href="#MMadaModelLM-146"><span class="linenos">146</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM-147"><a href="#MMadaModelLM-147"><span class="linenos">147</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="MMadaModelLM-148"><a href="#MMadaModelLM-148"><span class="linenos">148</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_new_special_tokens</span>
</span><span id="MMadaModelLM-149"><a href="#MMadaModelLM-149"><span class="linenos">149</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM-150"><a href="#MMadaModelLM-150"><span class="linenos">150</span></a>
</span><span id="MMadaModelLM-151"><a href="#MMadaModelLM-151"><span class="linenos">151</span></a>        <span class="c1"># for classifier-free guidance</span>
</span><span id="MMadaModelLM-152"><a href="#MMadaModelLM-152"><span class="linenos">152</span></a>        <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM-153"><a href="#MMadaModelLM-153"><span class="linenos">153</span></a>            <span class="n">uncond_prefix</span> <span class="o">=</span> <span class="n">uncond_input_ids</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM-154"><a href="#MMadaModelLM-154"><span class="linenos">154</span></a>
</span><span id="MMadaModelLM-155"><a href="#MMadaModelLM-155"><span class="linenos">155</span></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span><span class="p">):</span>
</span><span id="MMadaModelLM-156"><a href="#MMadaModelLM-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">guidance_scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MMadaModelLM-157"><a href="#MMadaModelLM-157"><span class="linenos">157</span></a>                <span class="n">uncond_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">uncond_prefix</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-158"><a href="#MMadaModelLM-158"><span class="linenos">158</span></a>                <span class="n">model_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">uncond_input_ids</span><span class="p">])</span>
</span><span id="MMadaModelLM-159"><a href="#MMadaModelLM-159"><span class="linenos">159</span></a>                <span class="n">all_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">uncond_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM-160"><a href="#MMadaModelLM-160"><span class="linenos">160</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">all_attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-161"><a href="#MMadaModelLM-161"><span class="linenos">161</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-162"><a href="#MMadaModelLM-162"><span class="linenos">162</span></a>                <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="MMadaModelLM-163"><a href="#MMadaModelLM-163"><span class="linenos">163</span></a>                <span class="n">cond_logits</span><span class="p">,</span> <span class="n">uncond_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM-164"><a href="#MMadaModelLM-164"><span class="linenos">164</span></a>                <span class="c1"># logits = uncond_logits + guidance_scale * (cond_logits - uncond_logits)</span>
</span><span id="MMadaModelLM-165"><a href="#MMadaModelLM-165"><span class="linenos">165</span></a>                <span class="c1"># it seems that muse has a different cfg setting</span>
</span><span id="MMadaModelLM-166"><a href="#MMadaModelLM-166"><span class="linenos">166</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">guidance_scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond_logits</span> <span class="o">-</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="n">uncond_logits</span>
</span><span id="MMadaModelLM-167"><a href="#MMadaModelLM-167"><span class="linenos">167</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="MMadaModelLM-168"><a href="#MMadaModelLM-168"><span class="linenos">168</span></a>                    <span class="p">:,</span>
</span><span id="MMadaModelLM-169"><a href="#MMadaModelLM-169"><span class="linenos">169</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MMadaModelLM-170"><a href="#MMadaModelLM-170"><span class="linenos">170</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="MMadaModelLM-171"><a href="#MMadaModelLM-171"><span class="linenos">171</span></a>                <span class="p">]</span>
</span><span id="MMadaModelLM-172"><a href="#MMadaModelLM-172"><span class="linenos">172</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-173"><a href="#MMadaModelLM-173"><span class="linenos">173</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-174"><a href="#MMadaModelLM-174"><span class="linenos">174</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-175"><a href="#MMadaModelLM-175"><span class="linenos">175</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="MMadaModelLM-176"><a href="#MMadaModelLM-176"><span class="linenos">176</span></a>                    <span class="p">:,</span>
</span><span id="MMadaModelLM-177"><a href="#MMadaModelLM-177"><span class="linenos">177</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MMadaModelLM-178"><a href="#MMadaModelLM-178"><span class="linenos">178</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="MMadaModelLM-179"><a href="#MMadaModelLM-179"><span class="linenos">179</span></a>                <span class="p">]</span>
</span><span id="MMadaModelLM-180"><a href="#MMadaModelLM-180"><span class="linenos">180</span></a>
</span><span id="MMadaModelLM-181"><a href="#MMadaModelLM-181"><span class="linenos">181</span></a>            <span class="c1"># logits: 1, 1024, 8192</span>
</span><span id="MMadaModelLM-182"><a href="#MMadaModelLM-182"><span class="linenos">182</span></a>            <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="MMadaModelLM-183"><a href="#MMadaModelLM-183"><span class="linenos">183</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-184"><a href="#MMadaModelLM-184"><span class="linenos">184</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="MMadaModelLM-185"><a href="#MMadaModelLM-185"><span class="linenos">185</span></a>            <span class="c1"># print(f&quot;probs: {probs}, probs.shape: {probs.shape}, sampled: {sampled}, sampled.shape: {sampled.shape}&quot;)</span>
</span><span id="MMadaModelLM-186"><a href="#MMadaModelLM-186"><span class="linenos">186</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">sampled</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 1, 1024</span>
</span><span id="MMadaModelLM-187"><a href="#MMadaModelLM-187"><span class="linenos">187</span></a>
</span><span id="MMadaModelLM-188"><a href="#MMadaModelLM-188"><span class="linenos">188</span></a>            <span class="n">unknown_map</span> <span class="o">=</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span>
</span><span id="MMadaModelLM-189"><a href="#MMadaModelLM-189"><span class="linenos">189</span></a>            <span class="c1"># print(f&quot;unknown_map.sum(dim=-1, keepdim=True): {unknown_map.sum(dim=-1, keepdim=True)}&quot;)</span>
</span><span id="MMadaModelLM-190"><a href="#MMadaModelLM-190"><span class="linenos">190</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span><span class="p">)</span>
</span><span id="MMadaModelLM-191"><a href="#MMadaModelLM-191"><span class="linenos">191</span></a>            <span class="c1"># Defines the mask ratio for the next round. The number to mask out is</span>
</span><span id="MMadaModelLM-192"><a href="#MMadaModelLM-192"><span class="linenos">192</span></a>            <span class="c1"># determined by mask_ratio * unknown_number_in_the_beginning.</span>
</span><span id="MMadaModelLM-193"><a href="#MMadaModelLM-193"><span class="linenos">193</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">timesteps</span>
</span><span id="MMadaModelLM-194"><a href="#MMadaModelLM-194"><span class="linenos">194</span></a>            <span class="n">mask_ratio</span> <span class="o">=</span> <span class="n">noise_schedule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>
</span><span id="MMadaModelLM-195"><a href="#MMadaModelLM-195"><span class="linenos">195</span></a>            <span class="c1"># Computes the probabilities of each selected tokens.</span>
</span><span id="MMadaModelLM-196"><a href="#MMadaModelLM-196"><span class="linenos">196</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="o">.</span><span class="n">long</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="MMadaModelLM-197"><a href="#MMadaModelLM-197"><span class="linenos">197</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">selected_probs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-198"><a href="#MMadaModelLM-198"><span class="linenos">198</span></a>
</span><span id="MMadaModelLM-199"><a href="#MMadaModelLM-199"><span class="linenos">199</span></a>            <span class="c1"># Ignores the tokens given in the input by overwriting their confidence.</span>
</span><span id="MMadaModelLM-200"><a href="#MMadaModelLM-200"><span class="linenos">200</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">selected_probs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
</span><span id="MMadaModelLM-201"><a href="#MMadaModelLM-201"><span class="linenos">201</span></a>            <span class="c1"># Gets mask lens for each sample in the batch according to the mask ratio.</span>
</span><span id="MMadaModelLM-202"><a href="#MMadaModelLM-202"><span class="linenos">202</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">*</span> <span class="n">mask_ratio</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-203"><a href="#MMadaModelLM-203"><span class="linenos">203</span></a>            <span class="c1"># Keeps at least one of prediction in this round and also masks out at least</span>
</span><span id="MMadaModelLM-204"><a href="#MMadaModelLM-204"><span class="linenos">204</span></a>            <span class="c1"># one and for the next iteration</span>
</span><span id="MMadaModelLM-205"><a href="#MMadaModelLM-205"><span class="linenos">205</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">unknown_map</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">))</span>
</span><span id="MMadaModelLM-206"><a href="#MMadaModelLM-206"><span class="linenos">206</span></a>            <span class="c1"># print(f&quot;mask_len: {mask_len}, mask_len.shape: {mask_len.shape}&quot;)</span>
</span><span id="MMadaModelLM-207"><a href="#MMadaModelLM-207"><span class="linenos">207</span></a>            <span class="c1"># Adds noise for randomness</span>
</span><span id="MMadaModelLM-208"><a href="#MMadaModelLM-208"><span class="linenos">208</span></a>            <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span>
</span><span id="MMadaModelLM-209"><a href="#MMadaModelLM-209"><span class="linenos">209</span></a>            <span class="n">masking</span> <span class="o">=</span> <span class="n">mask_by_random_topk</span><span class="p">(</span><span class="n">mask_len</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>
</span><span id="MMadaModelLM-210"><a href="#MMadaModelLM-210"><span class="linenos">210</span></a>            <span class="c1"># Masks tokens with lower confidence.</span>
</span><span id="MMadaModelLM-211"><a href="#MMadaModelLM-211"><span class="linenos">211</span></a>            <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span><span class="p">)</span>
</span><span id="MMadaModelLM-212"><a href="#MMadaModelLM-212"><span class="linenos">212</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">)</span>
</span><span id="MMadaModelLM-213"><a href="#MMadaModelLM-213"><span class="linenos">213</span></a>
</span><span id="MMadaModelLM-214"><a href="#MMadaModelLM-214"><span class="linenos">214</span></a>        <span class="k">return</span> <span class="n">sampled_ids</span>
</span><span id="MMadaModelLM-215"><a href="#MMadaModelLM-215"><span class="linenos">215</span></a>
</span><span id="MMadaModelLM-216"><a href="#MMadaModelLM-216"><span class="linenos">216</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_process</span><span class="p">(</span>
</span><span id="MMadaModelLM-217"><a href="#MMadaModelLM-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM-218"><a href="#MMadaModelLM-218"><span class="linenos">218</span></a>        <span class="n">input_ids</span><span class="p">,</span>
</span><span id="MMadaModelLM-219"><a href="#MMadaModelLM-219"><span class="linenos">219</span></a>        <span class="n">labels</span><span class="p">,</span>
</span><span id="MMadaModelLM-220"><a href="#MMadaModelLM-220"><span class="linenos">220</span></a>        <span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM-221"><a href="#MMadaModelLM-221"><span class="linenos">221</span></a>        <span class="n">batch_size_lm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM-222"><a href="#MMadaModelLM-222"><span class="linenos">222</span></a>        <span class="n">batch_size_mmu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM-223"><a href="#MMadaModelLM-223"><span class="linenos">223</span></a>        <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM-224"><a href="#MMadaModelLM-224"><span class="linenos">224</span></a>        <span class="n">p_mask_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-225"><a href="#MMadaModelLM-225"><span class="linenos">225</span></a>        <span class="n">p_mask_mmu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-226"><a href="#MMadaModelLM-226"><span class="linenos">226</span></a>        <span class="n">answer_lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-227"><a href="#MMadaModelLM-227"><span class="linenos">227</span></a>        <span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-228"><a href="#MMadaModelLM-228"><span class="linenos">228</span></a>        <span class="n">answer_lengths_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-229"><a href="#MMadaModelLM-229"><span class="linenos">229</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM-230"><a href="#MMadaModelLM-230"><span class="linenos">230</span></a>        <span class="c1"># attention bias, True for batch_size, 1, seq_len, seq_len</span>
</span><span id="MMadaModelLM-231"><a href="#MMadaModelLM-231"><span class="linenos">231</span></a>        <span class="n">attention_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM-232"><a href="#MMadaModelLM-232"><span class="linenos">232</span></a>        <span class="n">attention_bias_t2i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2i_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">t2i_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-233"><a href="#MMadaModelLM-233"><span class="linenos">233</span></a>        <span class="n">attention_bias</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_bias_t2i</span>
</span><span id="MMadaModelLM-234"><a href="#MMadaModelLM-234"><span class="linenos">234</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-235"><a href="#MMadaModelLM-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM-236"><a href="#MMadaModelLM-236"><span class="linenos">236</span></a>
</span><span id="MMadaModelLM-237"><a href="#MMadaModelLM-237"><span class="linenos">237</span></a>        <span class="k">if</span> <span class="n">batch_size_t2i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MMadaModelLM-238"><a href="#MMadaModelLM-238"><span class="linenos">238</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-239"><a href="#MMadaModelLM-239"><span class="linenos">239</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-240"><a href="#MMadaModelLM-240"><span class="linenos">240</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM-241"><a href="#MMadaModelLM-241"><span class="linenos">241</span></a>                <span class="n">logits</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM-242"><a href="#MMadaModelLM-242"><span class="linenos">242</span></a>                <span class="n">labels</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM-243"><a href="#MMadaModelLM-243"><span class="linenos">243</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM-244"><a href="#MMadaModelLM-244"><span class="linenos">244</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM-245"><a href="#MMadaModelLM-245"><span class="linenos">245</span></a>
</span><span id="MMadaModelLM-246"><a href="#MMadaModelLM-246"><span class="linenos">246</span></a>        <span class="n">masked_indices</span> <span class="o">=</span> <span class="n">input_ids</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mask_token_id</span>
</span><span id="MMadaModelLM-247"><a href="#MMadaModelLM-247"><span class="linenos">247</span></a>        <span class="n">masked_indices_lm</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span>
</span><span id="MMadaModelLM-248"><a href="#MMadaModelLM-248"><span class="linenos">248</span></a>        <span class="n">masked_indices_mmu</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:]</span>
</span><span id="MMadaModelLM-249"><a href="#MMadaModelLM-249"><span class="linenos">249</span></a>        <span class="n">p_mask_lm</span> <span class="o">=</span> <span class="n">p_mask_lm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_lm</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-250"><a href="#MMadaModelLM-250"><span class="linenos">250</span></a>        <span class="n">p_mask_mmu</span> <span class="o">=</span> <span class="n">p_mask_mmu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-251"><a href="#MMadaModelLM-251"><span class="linenos">251</span></a>        <span class="n">answer_lengths</span> <span class="o">=</span> <span class="n">answer_lengths</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-252"><a href="#MMadaModelLM-252"><span class="linenos">252</span></a>        <span class="n">loss_lm</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM-253"><a href="#MMadaModelLM-253"><span class="linenos">253</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM-254"><a href="#MMadaModelLM-254"><span class="linenos">254</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM-255"><a href="#MMadaModelLM-255"><span class="linenos">255</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM-256"><a href="#MMadaModelLM-256"><span class="linenos">256</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM-257"><a href="#MMadaModelLM-257"><span class="linenos">257</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM-258"><a href="#MMadaModelLM-258"><span class="linenos">258</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM-259"><a href="#MMadaModelLM-259"><span class="linenos">259</span></a>            <span class="o">/</span> <span class="n">p_mask_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">]</span>
</span><span id="MMadaModelLM-260"><a href="#MMadaModelLM-260"><span class="linenos">260</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM-261"><a href="#MMadaModelLM-261"><span class="linenos">261</span></a>
</span><span id="MMadaModelLM-262"><a href="#MMadaModelLM-262"><span class="linenos">262</span></a>        <span class="k">if</span> <span class="n">answer_lengths_lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM-263"><a href="#MMadaModelLM-263"><span class="linenos">263</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_lm</span> <span class="o">/</span> <span class="n">answer_lengths_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM-264"><a href="#MMadaModelLM-264"><span class="linenos">264</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-265"><a href="#MMadaModelLM-265"><span class="linenos">265</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">loss_lm</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM-266"><a href="#MMadaModelLM-266"><span class="linenos">266</span></a>
</span><span id="MMadaModelLM-267"><a href="#MMadaModelLM-267"><span class="linenos">267</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM-268"><a href="#MMadaModelLM-268"><span class="linenos">268</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM-269"><a href="#MMadaModelLM-269"><span class="linenos">269</span></a>                <span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM-270"><a href="#MMadaModelLM-270"><span class="linenos">270</span></a>                <span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM-271"><a href="#MMadaModelLM-271"><span class="linenos">271</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM-272"><a href="#MMadaModelLM-272"><span class="linenos">272</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM-273"><a href="#MMadaModelLM-273"><span class="linenos">273</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM-274"><a href="#MMadaModelLM-274"><span class="linenos">274</span></a>            <span class="o">/</span> <span class="n">p_mask_mmu</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">]</span>
</span><span id="MMadaModelLM-275"><a href="#MMadaModelLM-275"><span class="linenos">275</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM-276"><a href="#MMadaModelLM-276"><span class="linenos">276</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_mmu</span> <span class="o">/</span> <span class="n">answer_lengths</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM-277"><a href="#MMadaModelLM-277"><span class="linenos">277</span></a>
</span><span id="MMadaModelLM-278"><a href="#MMadaModelLM-278"><span class="linenos">278</span></a>        <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">loss_t2i</span><span class="p">,</span> <span class="n">loss_lm</span><span class="p">,</span> <span class="n">loss_mmu</span>
</span><span id="MMadaModelLM-279"><a href="#MMadaModelLM-279"><span class="linenos">279</span></a>
</span><span id="MMadaModelLM-280"><a href="#MMadaModelLM-280"><span class="linenos">280</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_process_with_r2i</span><span class="p">(</span>
</span><span id="MMadaModelLM-281"><a href="#MMadaModelLM-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM-282"><a href="#MMadaModelLM-282"><span class="linenos">282</span></a>        <span class="n">input_ids</span><span class="p">,</span>
</span><span id="MMadaModelLM-283"><a href="#MMadaModelLM-283"><span class="linenos">283</span></a>        <span class="n">labels</span><span class="p">,</span>
</span><span id="MMadaModelLM-284"><a href="#MMadaModelLM-284"><span class="linenos">284</span></a>        <span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-285"><a href="#MMadaModelLM-285"><span class="linenos">285</span></a>        <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM-286"><a href="#MMadaModelLM-286"><span class="linenos">286</span></a>        <span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM-287"><a href="#MMadaModelLM-287"><span class="linenos">287</span></a>        <span class="n">batch_size_lm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM-288"><a href="#MMadaModelLM-288"><span class="linenos">288</span></a>        <span class="n">batch_size_mmu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM-289"><a href="#MMadaModelLM-289"><span class="linenos">289</span></a>        <span class="n">batch_size_r2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM-290"><a href="#MMadaModelLM-290"><span class="linenos">290</span></a>        <span class="n">p_mask_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-291"><a href="#MMadaModelLM-291"><span class="linenos">291</span></a>        <span class="n">p_mask_mmu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-292"><a href="#MMadaModelLM-292"><span class="linenos">292</span></a>        <span class="n">p_mask_r2i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-293"><a href="#MMadaModelLM-293"><span class="linenos">293</span></a>        <span class="n">answer_lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-294"><a href="#MMadaModelLM-294"><span class="linenos">294</span></a>        <span class="n">answer_lengths_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-295"><a href="#MMadaModelLM-295"><span class="linenos">295</span></a>        <span class="n">answer_lengths_r2i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-296"><a href="#MMadaModelLM-296"><span class="linenos">296</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM-297"><a href="#MMadaModelLM-297"><span class="linenos">297</span></a>        <span class="c1"># attention bias, True for batch_size, 1, seq_len, seq_len</span>
</span><span id="MMadaModelLM-298"><a href="#MMadaModelLM-298"><span class="linenos">298</span></a>        <span class="n">attention_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM-299"><a href="#MMadaModelLM-299"><span class="linenos">299</span></a>        <span class="n">attention_bias_t2i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2i_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">t2i_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-300"><a href="#MMadaModelLM-300"><span class="linenos">300</span></a>        <span class="n">attention_bias</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_bias_t2i</span>
</span><span id="MMadaModelLM-301"><a href="#MMadaModelLM-301"><span class="linenos">301</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-302"><a href="#MMadaModelLM-302"><span class="linenos">302</span></a>        <span class="c1"># logits = self(input_ids).logits</span>
</span><span id="MMadaModelLM-303"><a href="#MMadaModelLM-303"><span class="linenos">303</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM-304"><a href="#MMadaModelLM-304"><span class="linenos">304</span></a>
</span><span id="MMadaModelLM-305"><a href="#MMadaModelLM-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="n">batch_size_t2i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MMadaModelLM-306"><a href="#MMadaModelLM-306"><span class="linenos">306</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-307"><a href="#MMadaModelLM-307"><span class="linenos">307</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-308"><a href="#MMadaModelLM-308"><span class="linenos">308</span></a>            <span class="c1"># t2i loss</span>
</span><span id="MMadaModelLM-309"><a href="#MMadaModelLM-309"><span class="linenos">309</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM-310"><a href="#MMadaModelLM-310"><span class="linenos">310</span></a>                <span class="n">logits</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM-311"><a href="#MMadaModelLM-311"><span class="linenos">311</span></a>                <span class="n">labels</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM-312"><a href="#MMadaModelLM-312"><span class="linenos">312</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM-313"><a href="#MMadaModelLM-313"><span class="linenos">313</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM-314"><a href="#MMadaModelLM-314"><span class="linenos">314</span></a>
</span><span id="MMadaModelLM-315"><a href="#MMadaModelLM-315"><span class="linenos">315</span></a>        <span class="c1"># llada loss</span>
</span><span id="MMadaModelLM-316"><a href="#MMadaModelLM-316"><span class="linenos">316</span></a>
</span><span id="MMadaModelLM-317"><a href="#MMadaModelLM-317"><span class="linenos">317</span></a>        <span class="n">start_lm</span> <span class="o">=</span> <span class="n">batch_size_t2i</span>
</span><span id="MMadaModelLM-318"><a href="#MMadaModelLM-318"><span class="linenos">318</span></a>        <span class="n">end_lm</span> <span class="o">=</span> <span class="n">start_lm</span> <span class="o">+</span> <span class="n">batch_size_lm</span>
</span><span id="MMadaModelLM-319"><a href="#MMadaModelLM-319"><span class="linenos">319</span></a>        <span class="n">start_mmu</span> <span class="o">=</span> <span class="n">end_lm</span>
</span><span id="MMadaModelLM-320"><a href="#MMadaModelLM-320"><span class="linenos">320</span></a>        <span class="n">end_mmu</span> <span class="o">=</span> <span class="n">start_mmu</span> <span class="o">+</span> <span class="n">batch_size_mmu</span>
</span><span id="MMadaModelLM-321"><a href="#MMadaModelLM-321"><span class="linenos">321</span></a>        <span class="n">start_r2i</span> <span class="o">=</span> <span class="n">end_mmu</span>
</span><span id="MMadaModelLM-322"><a href="#MMadaModelLM-322"><span class="linenos">322</span></a>        <span class="n">end_r2i</span> <span class="o">=</span> <span class="n">start_r2i</span> <span class="o">+</span> <span class="n">batch_size_r2i</span>
</span><span id="MMadaModelLM-323"><a href="#MMadaModelLM-323"><span class="linenos">323</span></a>
</span><span id="MMadaModelLM-324"><a href="#MMadaModelLM-324"><span class="linenos">324</span></a>        <span class="n">masked_indices</span> <span class="o">=</span> <span class="n">input_ids</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mask_token_id</span>
</span><span id="MMadaModelLM-325"><a href="#MMadaModelLM-325"><span class="linenos">325</span></a>        <span class="n">masked_indices_lm</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span>
</span><span id="MMadaModelLM-326"><a href="#MMadaModelLM-326"><span class="linenos">326</span></a>        <span class="n">masked_indices_mmu</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">]</span>
</span><span id="MMadaModelLM-327"><a href="#MMadaModelLM-327"><span class="linenos">327</span></a>        <span class="n">masked_indices_r2i</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">]</span>
</span><span id="MMadaModelLM-328"><a href="#MMadaModelLM-328"><span class="linenos">328</span></a>
</span><span id="MMadaModelLM-329"><a href="#MMadaModelLM-329"><span class="linenos">329</span></a>        <span class="n">p_mask_lm</span> <span class="o">=</span> <span class="n">p_mask_lm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_lm</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-330"><a href="#MMadaModelLM-330"><span class="linenos">330</span></a>        <span class="n">p_mask_mmu</span> <span class="o">=</span> <span class="n">p_mask_mmu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-331"><a href="#MMadaModelLM-331"><span class="linenos">331</span></a>        <span class="n">p_mask_r2i</span> <span class="o">=</span> <span class="n">p_mask_r2i</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_r2i</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-332"><a href="#MMadaModelLM-332"><span class="linenos">332</span></a>
</span><span id="MMadaModelLM-333"><a href="#MMadaModelLM-333"><span class="linenos">333</span></a>        <span class="n">answer_lengths</span> <span class="o">=</span> <span class="n">answer_lengths</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-334"><a href="#MMadaModelLM-334"><span class="linenos">334</span></a>        <span class="n">answer_lengths_lm</span> <span class="o">=</span> <span class="n">answer_lengths_lm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_lm</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-335"><a href="#MMadaModelLM-335"><span class="linenos">335</span></a>        <span class="n">answer_lengths_r2i</span> <span class="o">=</span> <span class="n">answer_lengths_r2i</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_r2i</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-336"><a href="#MMadaModelLM-336"><span class="linenos">336</span></a>
</span><span id="MMadaModelLM-337"><a href="#MMadaModelLM-337"><span class="linenos">337</span></a>        <span class="n">loss_lm</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM-338"><a href="#MMadaModelLM-338"><span class="linenos">338</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM-339"><a href="#MMadaModelLM-339"><span class="linenos">339</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM-340"><a href="#MMadaModelLM-340"><span class="linenos">340</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM-341"><a href="#MMadaModelLM-341"><span class="linenos">341</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM-342"><a href="#MMadaModelLM-342"><span class="linenos">342</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM-343"><a href="#MMadaModelLM-343"><span class="linenos">343</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM-344"><a href="#MMadaModelLM-344"><span class="linenos">344</span></a>            <span class="o">/</span> <span class="n">p_mask_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">]</span>
</span><span id="MMadaModelLM-345"><a href="#MMadaModelLM-345"><span class="linenos">345</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM-346"><a href="#MMadaModelLM-346"><span class="linenos">346</span></a>
</span><span id="MMadaModelLM-347"><a href="#MMadaModelLM-347"><span class="linenos">347</span></a>        <span class="k">if</span> <span class="n">answer_lengths_lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM-348"><a href="#MMadaModelLM-348"><span class="linenos">348</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_lm</span> <span class="o">/</span> <span class="n">answer_lengths_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM-349"><a href="#MMadaModelLM-349"><span class="linenos">349</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-350"><a href="#MMadaModelLM-350"><span class="linenos">350</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">loss_lm</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM-351"><a href="#MMadaModelLM-351"><span class="linenos">351</span></a>
</span><span id="MMadaModelLM-352"><a href="#MMadaModelLM-352"><span class="linenos">352</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM-353"><a href="#MMadaModelLM-353"><span class="linenos">353</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM-354"><a href="#MMadaModelLM-354"><span class="linenos">354</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM-355"><a href="#MMadaModelLM-355"><span class="linenos">355</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM-356"><a href="#MMadaModelLM-356"><span class="linenos">356</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM-357"><a href="#MMadaModelLM-357"><span class="linenos">357</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM-358"><a href="#MMadaModelLM-358"><span class="linenos">358</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM-359"><a href="#MMadaModelLM-359"><span class="linenos">359</span></a>            <span class="o">/</span> <span class="n">p_mask_mmu</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">]</span>
</span><span id="MMadaModelLM-360"><a href="#MMadaModelLM-360"><span class="linenos">360</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM-361"><a href="#MMadaModelLM-361"><span class="linenos">361</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_mmu</span> <span class="o">/</span> <span class="n">answer_lengths</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM-362"><a href="#MMadaModelLM-362"><span class="linenos">362</span></a>
</span><span id="MMadaModelLM-363"><a href="#MMadaModelLM-363"><span class="linenos">363</span></a>        <span class="n">loss_r2i</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM-364"><a href="#MMadaModelLM-364"><span class="linenos">364</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM-365"><a href="#MMadaModelLM-365"><span class="linenos">365</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">][</span><span class="n">masked_indices_r2i</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM-366"><a href="#MMadaModelLM-366"><span class="linenos">366</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">][</span><span class="n">masked_indices_r2i</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM-367"><a href="#MMadaModelLM-367"><span class="linenos">367</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM-368"><a href="#MMadaModelLM-368"><span class="linenos">368</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM-369"><a href="#MMadaModelLM-369"><span class="linenos">369</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM-370"><a href="#MMadaModelLM-370"><span class="linenos">370</span></a>            <span class="o">/</span> <span class="n">p_mask_r2i</span><span class="p">[</span><span class="n">masked_indices_r2i</span><span class="p">]</span>
</span><span id="MMadaModelLM-371"><a href="#MMadaModelLM-371"><span class="linenos">371</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM-372"><a href="#MMadaModelLM-372"><span class="linenos">372</span></a>        <span class="n">loss_r2i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_r2i</span> <span class="o">/</span> <span class="n">answer_lengths_r2i</span><span class="p">[</span><span class="n">masked_indices_r2i</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM-373"><a href="#MMadaModelLM-373"><span class="linenos">373</span></a>
</span><span id="MMadaModelLM-374"><a href="#MMadaModelLM-374"><span class="linenos">374</span></a>        <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">loss_t2i</span><span class="p">,</span> <span class="n">loss_lm</span><span class="p">,</span> <span class="n">loss_mmu</span><span class="p">,</span> <span class="n">loss_r2i</span>
</span><span id="MMadaModelLM-375"><a href="#MMadaModelLM-375"><span class="linenos">375</span></a>
</span><span id="MMadaModelLM-376"><a href="#MMadaModelLM-376"><span class="linenos">376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_t2i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MMadaModelLM-377"><a href="#MMadaModelLM-377"><span class="linenos">377</span></a>        <span class="c1"># attention bias, True for batch_size, 1, seq_len, seq_len</span>
</span><span id="MMadaModelLM-378"><a href="#MMadaModelLM-378"><span class="linenos">378</span></a>        <span class="n">attention_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM-379"><a href="#MMadaModelLM-379"><span class="linenos">379</span></a>        <span class="n">attention_bias_t2i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2i_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">t2i_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-380"><a href="#MMadaModelLM-380"><span class="linenos">380</span></a>        <span class="n">attention_bias</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_bias_t2i</span>
</span><span id="MMadaModelLM-381"><a href="#MMadaModelLM-381"><span class="linenos">381</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-382"><a href="#MMadaModelLM-382"><span class="linenos">382</span></a>        <span class="c1"># logits = self(input_ids).logits</span>
</span><span id="MMadaModelLM-383"><a href="#MMadaModelLM-383"><span class="linenos">383</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM-384"><a href="#MMadaModelLM-384"><span class="linenos">384</span></a>
</span><span id="MMadaModelLM-385"><a href="#MMadaModelLM-385"><span class="linenos">385</span></a>        <span class="c1"># print(f&quot;logits shape: {logits.shape}&quot;) B, 359, vocab_size</span>
</span><span id="MMadaModelLM-386"><a href="#MMadaModelLM-386"><span class="linenos">386</span></a>
</span><span id="MMadaModelLM-387"><a href="#MMadaModelLM-387"><span class="linenos">387</span></a>        <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM-388"><a href="#MMadaModelLM-388"><span class="linenos">388</span></a>            <span class="n">logits</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM-389"><a href="#MMadaModelLM-389"><span class="linenos">389</span></a>            <span class="n">labels</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM-390"><a href="#MMadaModelLM-390"><span class="linenos">390</span></a>            <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM-391"><a href="#MMadaModelLM-391"><span class="linenos">391</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM-392"><a href="#MMadaModelLM-392"><span class="linenos">392</span></a>
</span><span id="MMadaModelLM-393"><a href="#MMadaModelLM-393"><span class="linenos">393</span></a>        <span class="k">return</span> <span class="n">loss_t2i</span>
</span><span id="MMadaModelLM-394"><a href="#MMadaModelLM-394"><span class="linenos">394</span></a>
</span><span id="MMadaModelLM-395"><a href="#MMadaModelLM-395"><span class="linenos">395</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="MMadaModelLM-396"><a href="#MMadaModelLM-396"><span class="linenos">396</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mmu_generate</span><span class="p">(</span>
</span><span id="MMadaModelLM-397"><a href="#MMadaModelLM-397"><span class="linenos">397</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM-398"><a href="#MMadaModelLM-398"><span class="linenos">398</span></a>        <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-399"><a href="#MMadaModelLM-399"><span class="linenos">399</span></a>        <span class="n">input_embeddings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-400"><a href="#MMadaModelLM-400"><span class="linenos">400</span></a>        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM-401"><a href="#MMadaModelLM-401"><span class="linenos">401</span></a>        <span class="n">steps</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM-402"><a href="#MMadaModelLM-402"><span class="linenos">402</span></a>        <span class="n">block_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM-403"><a href="#MMadaModelLM-403"><span class="linenos">403</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="MMadaModelLM-404"><a href="#MMadaModelLM-404"><span class="linenos">404</span></a>        <span class="n">top_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-405"><a href="#MMadaModelLM-405"><span class="linenos">405</span></a>        <span class="n">eot_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-406"><a href="#MMadaModelLM-406"><span class="linenos">406</span></a>        <span class="n">cfg_scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="MMadaModelLM-407"><a href="#MMadaModelLM-407"><span class="linenos">407</span></a>        <span class="n">remasking</span><span class="o">=</span><span class="s2">&quot;low_confidence&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM-408"><a href="#MMadaModelLM-408"><span class="linenos">408</span></a>        <span class="n">mask_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="MMadaModelLM-409"><a href="#MMadaModelLM-409"><span class="linenos">409</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-410"><a href="#MMadaModelLM-410"><span class="linenos">410</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM-411"><a href="#MMadaModelLM-411"><span class="linenos">411</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM-412"><a href="#MMadaModelLM-412"><span class="linenos">412</span></a><span class="sd">        Take a conditioning sequence of indices idx (LongTensor of shape (b,t)) and complete</span>
</span><span id="MMadaModelLM-413"><a href="#MMadaModelLM-413"><span class="linenos">413</span></a><span class="sd">        the sequence max_new_tokens times, feeding the predictions back into the model each time.</span>
</span><span id="MMadaModelLM-414"><a href="#MMadaModelLM-414"><span class="linenos">414</span></a><span class="sd">        Most likely you&#39;ll want to make sure to be in model.eval() mode of operation for this.</span>
</span><span id="MMadaModelLM-415"><a href="#MMadaModelLM-415"><span class="linenos">415</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MMadaModelLM-416"><a href="#MMadaModelLM-416"><span class="linenos">416</span></a>
</span><span id="MMadaModelLM-417"><a href="#MMadaModelLM-417"><span class="linenos">417</span></a>        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="ow">in</span> <span class="n">attention_mask</span><span class="p">:</span>
</span><span id="MMadaModelLM-418"><a href="#MMadaModelLM-418"><span class="linenos">418</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-419"><a href="#MMadaModelLM-419"><span class="linenos">419</span></a>            <span class="c1"># print(f&quot;attention_bias: {attention_bias}&quot;)</span>
</span><span id="MMadaModelLM-420"><a href="#MMadaModelLM-420"><span class="linenos">420</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-421"><a href="#MMadaModelLM-421"><span class="linenos">421</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MMadaModelLM-422"><a href="#MMadaModelLM-422"><span class="linenos">422</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MMadaModelLM-423"><a href="#MMadaModelLM-423"><span class="linenos">423</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">device</span>
</span><span id="MMadaModelLM-424"><a href="#MMadaModelLM-424"><span class="linenos">424</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="MMadaModelLM-425"><a href="#MMadaModelLM-425"><span class="linenos">425</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">input_embeddings</span><span class="o">.</span><span class="n">device</span>
</span><span id="MMadaModelLM-426"><a href="#MMadaModelLM-426"><span class="linenos">426</span></a>
</span><span id="MMadaModelLM-427"><a href="#MMadaModelLM-427"><span class="linenos">427</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MMadaModelLM-428"><a href="#MMadaModelLM-428"><span class="linenos">428</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MMadaModelLM-429"><a href="#MMadaModelLM-429"><span class="linenos">429</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_new_tokens</span><span class="p">),</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-430"><a href="#MMadaModelLM-430"><span class="linenos">430</span></a>        <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM-431"><a href="#MMadaModelLM-431"><span class="linenos">431</span></a>        <span class="n">prompt_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM-432"><a href="#MMadaModelLM-432"><span class="linenos">432</span></a>
</span><span id="MMadaModelLM-433"><a href="#MMadaModelLM-433"><span class="linenos">433</span></a>        <span class="k">assert</span> <span class="n">max_new_tokens</span> <span class="o">%</span> <span class="n">block_length</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MMadaModelLM-434"><a href="#MMadaModelLM-434"><span class="linenos">434</span></a>        <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">max_new_tokens</span> <span class="o">//</span> <span class="n">block_length</span>
</span><span id="MMadaModelLM-435"><a href="#MMadaModelLM-435"><span class="linenos">435</span></a>
</span><span id="MMadaModelLM-436"><a href="#MMadaModelLM-436"><span class="linenos">436</span></a>        <span class="k">assert</span> <span class="n">steps</span> <span class="o">%</span> <span class="n">num_blocks</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MMadaModelLM-437"><a href="#MMadaModelLM-437"><span class="linenos">437</span></a>        <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">//</span> <span class="n">num_blocks</span>
</span><span id="MMadaModelLM-438"><a href="#MMadaModelLM-438"><span class="linenos">438</span></a>
</span><span id="MMadaModelLM-439"><a href="#MMadaModelLM-439"><span class="linenos">439</span></a>        <span class="c1"># print(f&quot;num_blocks: {num_blocks}, steps: {steps}&quot;)</span>
</span><span id="MMadaModelLM-440"><a href="#MMadaModelLM-440"><span class="linenos">440</span></a>        <span class="c1"># num_transfer_tokens = get_num_transfer_tokens(prompt_index, steps)</span>
</span><span id="MMadaModelLM-441"><a href="#MMadaModelLM-441"><span class="linenos">441</span></a>        <span class="k">for</span> <span class="n">num_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="MMadaModelLM-442"><a href="#MMadaModelLM-442"><span class="linenos">442</span></a>            <span class="n">block_mask_index</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_block</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM-443"><a href="#MMadaModelLM-443"><span class="linenos">443</span></a>            <span class="n">num_transfer_tokens</span> <span class="o">=</span> <span class="n">get_num_transfer_tokens</span><span class="p">(</span><span class="n">block_mask_index</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="MMadaModelLM-444"><a href="#MMadaModelLM-444"><span class="linenos">444</span></a>            <span class="c1"># num_transfer_tokens = get_num_transfer_tokens(prompt_index, steps)</span>
</span><span id="MMadaModelLM-445"><a href="#MMadaModelLM-445"><span class="linenos">445</span></a>            <span class="c1"># print(f&quot;num_transfer_tokens: {num_transfer_tokens}, num_transfer_tokens.shape: {num_transfer_tokens.shape}&quot;)</span>
</span><span id="MMadaModelLM-446"><a href="#MMadaModelLM-446"><span class="linenos">446</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
</span><span id="MMadaModelLM-447"><a href="#MMadaModelLM-447"><span class="linenos">447</span></a>                <span class="n">mask_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM-448"><a href="#MMadaModelLM-448"><span class="linenos">448</span></a>                <span class="k">if</span> <span class="n">cfg_scale</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="MMadaModelLM-449"><a href="#MMadaModelLM-449"><span class="linenos">449</span></a>                    <span class="n">un_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM-450"><a href="#MMadaModelLM-450"><span class="linenos">450</span></a>                    <span class="n">un_x</span><span class="p">[</span><span class="n">prompt_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM-451"><a href="#MMadaModelLM-451"><span class="linenos">451</span></a>                    <span class="n">x_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">un_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM-452"><a href="#MMadaModelLM-452"><span class="linenos">452</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-453"><a href="#MMadaModelLM-453"><span class="linenos">453</span></a>                    <span class="n">logits</span><span class="p">,</span> <span class="n">un_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM-454"><a href="#MMadaModelLM-454"><span class="linenos">454</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="n">un_logits</span> <span class="o">+</span> <span class="p">(</span><span class="n">cfg_scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="n">un_logits</span><span class="p">)</span>
</span><span id="MMadaModelLM-455"><a href="#MMadaModelLM-455"><span class="linenos">455</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-456"><a href="#MMadaModelLM-456"><span class="linenos">456</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-457"><a href="#MMadaModelLM-457"><span class="linenos">457</span></a>
</span><span id="MMadaModelLM-458"><a href="#MMadaModelLM-458"><span class="linenos">458</span></a>                <span class="n">logits_with_noise</span> <span class="o">=</span> <span class="n">add_gumbel_noise</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
</span><span id="MMadaModelLM-459"><a href="#MMadaModelLM-459"><span class="linenos">459</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits_with_noise</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="MMadaModelLM-460"><a href="#MMadaModelLM-460"><span class="linenos">460</span></a>                <span class="k">if</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;low_confidence&quot;</span><span class="p">:</span>
</span><span id="MMadaModelLM-461"><a href="#MMadaModelLM-461"><span class="linenos">461</span></a>                    <span class="n">p</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device_dtype</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-462"><a href="#MMadaModelLM-462"><span class="linenos">462</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="MMadaModelLM-463"><a href="#MMadaModelLM-463"><span class="linenos">463</span></a>                <span class="k">elif</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="MMadaModelLM-464"><a href="#MMadaModelLM-464"><span class="linenos">464</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-465"><a href="#MMadaModelLM-465"><span class="linenos">465</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-466"><a href="#MMadaModelLM-466"><span class="linenos">466</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">remasking</span><span class="p">)</span>
</span><span id="MMadaModelLM-467"><a href="#MMadaModelLM-467"><span class="linenos">467</span></a>
</span><span id="MMadaModelLM-468"><a href="#MMadaModelLM-468"><span class="linenos">468</span></a>                <span class="n">x0_p</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="MMadaModelLM-469"><a href="#MMadaModelLM-469"><span class="linenos">469</span></a>
</span><span id="MMadaModelLM-470"><a href="#MMadaModelLM-470"><span class="linenos">470</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="MMadaModelLM-471"><a href="#MMadaModelLM-471"><span class="linenos">471</span></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0_p</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</span><span id="MMadaModelLM-472"><a href="#MMadaModelLM-472"><span class="linenos">472</span></a>
</span><span id="MMadaModelLM-473"><a href="#MMadaModelLM-473"><span class="linenos">473</span></a>                <span class="n">transfer_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-474"><a href="#MMadaModelLM-474"><span class="linenos">474</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">confidence</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="MMadaModelLM-475"><a href="#MMadaModelLM-475"><span class="linenos">475</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">select_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">confidence</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">num_transfer_tokens</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="MMadaModelLM-476"><a href="#MMadaModelLM-476"><span class="linenos">476</span></a>                    <span class="n">transfer_index</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">select_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MMadaModelLM-477"><a href="#MMadaModelLM-477"><span class="linenos">477</span></a>                <span class="n">x</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span>
</span><span id="MMadaModelLM-478"><a href="#MMadaModelLM-478"><span class="linenos">478</span></a>
</span><span id="MMadaModelLM-479"><a href="#MMadaModelLM-479"><span class="linenos">479</span></a>            <span class="c1"># logits = logits[:, -1, :] / temperature</span>
</span><span id="MMadaModelLM-480"><a href="#MMadaModelLM-480"><span class="linenos">480</span></a>            <span class="c1"># # optionally crop the logits to only the top k options</span>
</span><span id="MMadaModelLM-481"><a href="#MMadaModelLM-481"><span class="linenos">481</span></a>            <span class="c1"># if top_k is not None:</span>
</span><span id="MMadaModelLM-482"><a href="#MMadaModelLM-482"><span class="linenos">482</span></a>            <span class="c1">#     v, _ = torch.topk(logits, min(top_k, logits.size(-1)))</span>
</span><span id="MMadaModelLM-483"><a href="#MMadaModelLM-483"><span class="linenos">483</span></a>            <span class="c1">#     logits[logits &lt; v[:, [-1]]] = -float(&#39;Inf&#39;)</span>
</span><span id="MMadaModelLM-484"><a href="#MMadaModelLM-484"><span class="linenos">484</span></a>            <span class="c1"># # apply softmax to convert logits to (normalized) probabilities</span>
</span><span id="MMadaModelLM-485"><a href="#MMadaModelLM-485"><span class="linenos">485</span></a>            <span class="c1"># probs = F.softmax(logits, dim=-1)</span>
</span><span id="MMadaModelLM-486"><a href="#MMadaModelLM-486"><span class="linenos">486</span></a>            <span class="c1"># # sample from the distribution</span>
</span><span id="MMadaModelLM-487"><a href="#MMadaModelLM-487"><span class="linenos">487</span></a>            <span class="c1"># idx_next = torch.multinomial(probs, num_samples=1)</span>
</span><span id="MMadaModelLM-488"><a href="#MMadaModelLM-488"><span class="linenos">488</span></a>            <span class="c1"># result.append(idx_next[0][0])</span>
</span><span id="MMadaModelLM-489"><a href="#MMadaModelLM-489"><span class="linenos">489</span></a>            <span class="c1"># # append sampled index to the running sequence and continue</span>
</span><span id="MMadaModelLM-490"><a href="#MMadaModelLM-490"><span class="linenos">490</span></a>            <span class="c1"># if self.config.w_clip_vit:</span>
</span><span id="MMadaModelLM-491"><a href="#MMadaModelLM-491"><span class="linenos">491</span></a>            <span class="c1">#     idx_next_embeddings = self.mmada.model.embed_tokens(idx_next)</span>
</span><span id="MMadaModelLM-492"><a href="#MMadaModelLM-492"><span class="linenos">492</span></a>            <span class="c1">#     input_embeddings = torch.cat([input_embeddings, idx_next_embeddings], dim=1)</span>
</span><span id="MMadaModelLM-493"><a href="#MMadaModelLM-493"><span class="linenos">493</span></a>            <span class="c1"># else:</span>
</span><span id="MMadaModelLM-494"><a href="#MMadaModelLM-494"><span class="linenos">494</span></a>            <span class="c1">#     idx = torch.cat((idx, idx_next), dim=1)</span>
</span><span id="MMadaModelLM-495"><a href="#MMadaModelLM-495"><span class="linenos">495</span></a>
</span><span id="MMadaModelLM-496"><a href="#MMadaModelLM-496"><span class="linenos">496</span></a>            <span class="c1"># if eot_token is not None and idx_next.cpu() == eot_token:</span>
</span><span id="MMadaModelLM-497"><a href="#MMadaModelLM-497"><span class="linenos">497</span></a>            <span class="c1">#     break</span>
</span><span id="MMadaModelLM-498"><a href="#MMadaModelLM-498"><span class="linenos">498</span></a>
</span><span id="MMadaModelLM-499"><a href="#MMadaModelLM-499"><span class="linenos">499</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="MMadaModelLM-500"><a href="#MMadaModelLM-500"><span class="linenos">500</span></a>
</span><span id="MMadaModelLM-501"><a href="#MMadaModelLM-501"><span class="linenos">501</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="MMadaModelLM-502"><a href="#MMadaModelLM-502"><span class="linenos">502</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mmu_generate_fast</span><span class="p">(</span>
</span><span id="MMadaModelLM-503"><a href="#MMadaModelLM-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM-504"><a href="#MMadaModelLM-504"><span class="linenos">504</span></a>        <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-505"><a href="#MMadaModelLM-505"><span class="linenos">505</span></a>        <span class="n">input_embeddings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-506"><a href="#MMadaModelLM-506"><span class="linenos">506</span></a>        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM-507"><a href="#MMadaModelLM-507"><span class="linenos">507</span></a>        <span class="n">steps</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM-508"><a href="#MMadaModelLM-508"><span class="linenos">508</span></a>        <span class="n">block_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM-509"><a href="#MMadaModelLM-509"><span class="linenos">509</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="MMadaModelLM-510"><a href="#MMadaModelLM-510"><span class="linenos">510</span></a>        <span class="n">top_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-511"><a href="#MMadaModelLM-511"><span class="linenos">511</span></a>        <span class="n">eot_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-512"><a href="#MMadaModelLM-512"><span class="linenos">512</span></a>        <span class="n">cfg_scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="MMadaModelLM-513"><a href="#MMadaModelLM-513"><span class="linenos">513</span></a>        <span class="n">remasking</span><span class="o">=</span><span class="s2">&quot;low_confidence&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM-514"><a href="#MMadaModelLM-514"><span class="linenos">514</span></a>        <span class="n">mask_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="MMadaModelLM-515"><a href="#MMadaModelLM-515"><span class="linenos">515</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-516"><a href="#MMadaModelLM-516"><span class="linenos">516</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM-517"><a href="#MMadaModelLM-517"><span class="linenos">517</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM-518"><a href="#MMadaModelLM-518"><span class="linenos">518</span></a><span class="sd">        Take a conditioning sequence of indices idx (LongTensor of shape (b,t)) and complete</span>
</span><span id="MMadaModelLM-519"><a href="#MMadaModelLM-519"><span class="linenos">519</span></a><span class="sd">        the sequence max_new_tokens times, feeding the predictions back into the model each time.</span>
</span><span id="MMadaModelLM-520"><a href="#MMadaModelLM-520"><span class="linenos">520</span></a><span class="sd">        Most likely you&#39;ll want to make sure to be in model.eval() mode of operation for this.</span>
</span><span id="MMadaModelLM-521"><a href="#MMadaModelLM-521"><span class="linenos">521</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MMadaModelLM-522"><a href="#MMadaModelLM-522"><span class="linenos">522</span></a>
</span><span id="MMadaModelLM-523"><a href="#MMadaModelLM-523"><span class="linenos">523</span></a>        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="ow">in</span> <span class="n">attention_mask</span><span class="p">:</span>
</span><span id="MMadaModelLM-524"><a href="#MMadaModelLM-524"><span class="linenos">524</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-525"><a href="#MMadaModelLM-525"><span class="linenos">525</span></a>            <span class="c1"># print(f&quot;attention_bias: {attention_bias}&quot;)</span>
</span><span id="MMadaModelLM-526"><a href="#MMadaModelLM-526"><span class="linenos">526</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-527"><a href="#MMadaModelLM-527"><span class="linenos">527</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MMadaModelLM-528"><a href="#MMadaModelLM-528"><span class="linenos">528</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MMadaModelLM-529"><a href="#MMadaModelLM-529"><span class="linenos">529</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">device</span>
</span><span id="MMadaModelLM-530"><a href="#MMadaModelLM-530"><span class="linenos">530</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="MMadaModelLM-531"><a href="#MMadaModelLM-531"><span class="linenos">531</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">input_embeddings</span><span class="o">.</span><span class="n">device</span>
</span><span id="MMadaModelLM-532"><a href="#MMadaModelLM-532"><span class="linenos">532</span></a>
</span><span id="MMadaModelLM-533"><a href="#MMadaModelLM-533"><span class="linenos">533</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MMadaModelLM-534"><a href="#MMadaModelLM-534"><span class="linenos">534</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MMadaModelLM-535"><a href="#MMadaModelLM-535"><span class="linenos">535</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_new_tokens</span><span class="p">),</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-536"><a href="#MMadaModelLM-536"><span class="linenos">536</span></a>        <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM-537"><a href="#MMadaModelLM-537"><span class="linenos">537</span></a>        <span class="n">prompt_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM-538"><a href="#MMadaModelLM-538"><span class="linenos">538</span></a>
</span><span id="MMadaModelLM-539"><a href="#MMadaModelLM-539"><span class="linenos">539</span></a>        <span class="k">assert</span> <span class="n">max_new_tokens</span> <span class="o">%</span> <span class="n">block_length</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MMadaModelLM-540"><a href="#MMadaModelLM-540"><span class="linenos">540</span></a>        <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">max_new_tokens</span> <span class="o">//</span> <span class="n">block_length</span>
</span><span id="MMadaModelLM-541"><a href="#MMadaModelLM-541"><span class="linenos">541</span></a>
</span><span id="MMadaModelLM-542"><a href="#MMadaModelLM-542"><span class="linenos">542</span></a>        <span class="k">assert</span> <span class="n">steps</span> <span class="o">%</span> <span class="n">num_blocks</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MMadaModelLM-543"><a href="#MMadaModelLM-543"><span class="linenos">543</span></a>        <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">//</span> <span class="n">num_blocks</span>
</span><span id="MMadaModelLM-544"><a href="#MMadaModelLM-544"><span class="linenos">544</span></a>
</span><span id="MMadaModelLM-545"><a href="#MMadaModelLM-545"><span class="linenos">545</span></a>        <span class="k">for</span> <span class="n">num_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="MMadaModelLM-546"><a href="#MMadaModelLM-546"><span class="linenos">546</span></a>            <span class="n">block_mask_index</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_block</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM-547"><a href="#MMadaModelLM-547"><span class="linenos">547</span></a>            <span class="n">num_transfer_tokens</span> <span class="o">=</span> <span class="n">get_num_transfer_tokens</span><span class="p">(</span><span class="n">block_mask_index</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="MMadaModelLM-548"><a href="#MMadaModelLM-548"><span class="linenos">548</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
</span><span id="MMadaModelLM-549"><a href="#MMadaModelLM-549"><span class="linenos">549</span></a>                <span class="n">mask_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM-550"><a href="#MMadaModelLM-550"><span class="linenos">550</span></a>                <span class="k">if</span> <span class="n">cfg_scale</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="MMadaModelLM-551"><a href="#MMadaModelLM-551"><span class="linenos">551</span></a>                    <span class="n">un_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM-552"><a href="#MMadaModelLM-552"><span class="linenos">552</span></a>                    <span class="n">un_x</span><span class="p">[</span><span class="n">prompt_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM-553"><a href="#MMadaModelLM-553"><span class="linenos">553</span></a>                    <span class="n">x_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">un_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM-554"><a href="#MMadaModelLM-554"><span class="linenos">554</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-555"><a href="#MMadaModelLM-555"><span class="linenos">555</span></a>                    <span class="n">logits</span><span class="p">,</span> <span class="n">un_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM-556"><a href="#MMadaModelLM-556"><span class="linenos">556</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="n">un_logits</span> <span class="o">+</span> <span class="p">(</span><span class="n">cfg_scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="n">un_logits</span><span class="p">)</span>
</span><span id="MMadaModelLM-557"><a href="#MMadaModelLM-557"><span class="linenos">557</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-558"><a href="#MMadaModelLM-558"><span class="linenos">558</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-559"><a href="#MMadaModelLM-559"><span class="linenos">559</span></a>
</span><span id="MMadaModelLM-560"><a href="#MMadaModelLM-560"><span class="linenos">560</span></a>                <span class="n">logits_with_noise</span> <span class="o">=</span> <span class="n">add_gumbel_noise</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
</span><span id="MMadaModelLM-561"><a href="#MMadaModelLM-561"><span class="linenos">561</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits_with_noise</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="MMadaModelLM-562"><a href="#MMadaModelLM-562"><span class="linenos">562</span></a>                <span class="k">if</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;low_confidence&quot;</span><span class="p">:</span>
</span><span id="MMadaModelLM-563"><a href="#MMadaModelLM-563"><span class="linenos">563</span></a>                    <span class="n">p</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device_dtype</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-564"><a href="#MMadaModelLM-564"><span class="linenos">564</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="MMadaModelLM-565"><a href="#MMadaModelLM-565"><span class="linenos">565</span></a>                <span class="k">elif</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="MMadaModelLM-566"><a href="#MMadaModelLM-566"><span class="linenos">566</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-567"><a href="#MMadaModelLM-567"><span class="linenos">567</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-568"><a href="#MMadaModelLM-568"><span class="linenos">568</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">remasking</span><span class="p">)</span>
</span><span id="MMadaModelLM-569"><a href="#MMadaModelLM-569"><span class="linenos">569</span></a>
</span><span id="MMadaModelLM-570"><a href="#MMadaModelLM-570"><span class="linenos">570</span></a>                <span class="n">x0_p</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="MMadaModelLM-571"><a href="#MMadaModelLM-571"><span class="linenos">571</span></a>
</span><span id="MMadaModelLM-572"><a href="#MMadaModelLM-572"><span class="linenos">572</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="MMadaModelLM-573"><a href="#MMadaModelLM-573"><span class="linenos">573</span></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0_p</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</span><span id="MMadaModelLM-574"><a href="#MMadaModelLM-574"><span class="linenos">574</span></a>
</span><span id="MMadaModelLM-575"><a href="#MMadaModelLM-575"><span class="linenos">575</span></a>                <span class="n">transfer_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-576"><a href="#MMadaModelLM-576"><span class="linenos">576</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">confidence</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="MMadaModelLM-577"><a href="#MMadaModelLM-577"><span class="linenos">577</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">select_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">confidence</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">num_transfer_tokens</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="MMadaModelLM-578"><a href="#MMadaModelLM-578"><span class="linenos">578</span></a>                    <span class="n">transfer_index</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">select_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MMadaModelLM-579"><a href="#MMadaModelLM-579"><span class="linenos">579</span></a>                <span class="n">x</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span>
</span><span id="MMadaModelLM-580"><a href="#MMadaModelLM-580"><span class="linenos">580</span></a>            <span class="k">if</span> <span class="n">eot_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM-581"><a href="#MMadaModelLM-581"><span class="linenos">581</span></a>                <span class="n">last_token_index_in_current_block</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="MMadaModelLM-582"><a href="#MMadaModelLM-582"><span class="linenos">582</span></a>                <span class="k">if</span> <span class="n">last_token_index_in_current_block</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="MMadaModelLM-583"><a href="#MMadaModelLM-583"><span class="linenos">583</span></a>                    <span class="n">tokens_at_block_end</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">last_token_index_in_current_block</span><span class="p">]</span>
</span><span id="MMadaModelLM-584"><a href="#MMadaModelLM-584"><span class="linenos">584</span></a>                    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">tokens_at_block_end</span> <span class="o">==</span> <span class="n">eot_token</span><span class="p">):</span>
</span><span id="MMadaModelLM-585"><a href="#MMadaModelLM-585"><span class="linenos">585</span></a>                        <span class="k">break</span>
</span><span id="MMadaModelLM-586"><a href="#MMadaModelLM-586"><span class="linenos">586</span></a>        <span class="k">return</span> <span class="n">x</span>
</span><span id="MMadaModelLM-587"><a href="#MMadaModelLM-587"><span class="linenos">587</span></a>
</span><span id="MMadaModelLM-588"><a href="#MMadaModelLM-588"><span class="linenos">588</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="MMadaModelLM-589"><a href="#MMadaModelLM-589"><span class="linenos">589</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">t2i_generate_decoding_stepwise</span><span class="p">(</span>
</span><span id="MMadaModelLM-590"><a href="#MMadaModelLM-590"><span class="linenos">590</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM-591"><a href="#MMadaModelLM-591"><span class="linenos">591</span></a>        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-592"><a href="#MMadaModelLM-592"><span class="linenos">592</span></a>        <span class="n">uncond_input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-593"><a href="#MMadaModelLM-593"><span class="linenos">593</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-594"><a href="#MMadaModelLM-594"><span class="linenos">594</span></a>        <span class="n">uncond_attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-595"><a href="#MMadaModelLM-595"><span class="linenos">595</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="MMadaModelLM-596"><a href="#MMadaModelLM-596"><span class="linenos">596</span></a>        <span class="n">timesteps</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>  <span class="c1"># ideal number of steps is 18 in maskgit paper</span>
</span><span id="MMadaModelLM-597"><a href="#MMadaModelLM-597"><span class="linenos">597</span></a>        <span class="n">guidance_scale</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM-598"><a href="#MMadaModelLM-598"><span class="linenos">598</span></a>        <span class="n">noise_schedule</span><span class="o">=</span><span class="n">cosine_schedule</span><span class="p">,</span>
</span><span id="MMadaModelLM-599"><a href="#MMadaModelLM-599"><span class="linenos">599</span></a>        <span class="n">generator</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-600"><a href="#MMadaModelLM-600"><span class="linenos">600</span></a>        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-601"><a href="#MMadaModelLM-601"><span class="linenos">601</span></a>        <span class="n">seq_len</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="MMadaModelLM-602"><a href="#MMadaModelLM-602"><span class="linenos">602</span></a>        <span class="n">mask_token_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="MMadaModelLM-603"><a href="#MMadaModelLM-603"><span class="linenos">603</span></a>        <span class="n">resolution</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span><span id="MMadaModelLM-604"><a href="#MMadaModelLM-604"><span class="linenos">604</span></a>        <span class="n">codebook_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
</span><span id="MMadaModelLM-605"><a href="#MMadaModelLM-605"><span class="linenos">605</span></a>        <span class="n">vq_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM-606"><a href="#MMadaModelLM-606"><span class="linenos">606</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="MMadaModelLM-607"><a href="#MMadaModelLM-607"><span class="linenos">607</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM-608"><a href="#MMadaModelLM-608"><span class="linenos">608</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM-609"><a href="#MMadaModelLM-609"><span class="linenos">609</span></a><span class="sd">        Generate 1:1 similar to the original MaskGit repo</span>
</span><span id="MMadaModelLM-610"><a href="#MMadaModelLM-610"><span class="linenos">610</span></a><span class="sd">        https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79</span>
</span><span id="MMadaModelLM-611"><a href="#MMadaModelLM-611"><span class="linenos">611</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MMadaModelLM-612"><a href="#MMadaModelLM-612"><span class="linenos">612</span></a>
</span><span id="MMadaModelLM-613"><a href="#MMadaModelLM-613"><span class="linenos">613</span></a>        <span class="c1"># begin with all image token ids masked</span>
</span><span id="MMadaModelLM-614"><a href="#MMadaModelLM-614"><span class="linenos">614</span></a>        <span class="c1"># mask token</span>
</span><span id="MMadaModelLM-615"><a href="#MMadaModelLM-615"><span class="linenos">615</span></a>        <span class="n">mask_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_ids</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MMadaModelLM-616"><a href="#MMadaModelLM-616"><span class="linenos">616</span></a>        <span class="n">num_vq_tokens</span> <span class="o">=</span> <span class="n">seq_len</span>
</span><span id="MMadaModelLM-617"><a href="#MMadaModelLM-617"><span class="linenos">617</span></a>        <span class="n">num_new_special_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MMadaModelLM-618"><a href="#MMadaModelLM-618"><span class="linenos">618</span></a>        <span class="n">uni_prompting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uni_prompting&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="MMadaModelLM-619"><a href="#MMadaModelLM-619"><span class="linenos">619</span></a>        <span class="c1"># print(f&quot;config.model.mmada.llm_vocab_size: {config.model.mmada.llm_vocab_size}, {len(uni_prompting.text_tokenizer)}&quot;)</span>
</span><span id="MMadaModelLM-620"><a href="#MMadaModelLM-620"><span class="linenos">620</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM-621"><a href="#MMadaModelLM-621"><span class="linenos">621</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="MMadaModelLM-622"><a href="#MMadaModelLM-622"><span class="linenos">622</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_new_special_tokens</span>
</span><span id="MMadaModelLM-623"><a href="#MMadaModelLM-623"><span class="linenos">623</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM-624"><a href="#MMadaModelLM-624"><span class="linenos">624</span></a>
</span><span id="MMadaModelLM-625"><a href="#MMadaModelLM-625"><span class="linenos">625</span></a>        <span class="c1"># for classifier-free guidance</span>
</span><span id="MMadaModelLM-626"><a href="#MMadaModelLM-626"><span class="linenos">626</span></a>        <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM-627"><a href="#MMadaModelLM-627"><span class="linenos">627</span></a>            <span class="n">uncond_prefix</span> <span class="o">=</span> <span class="n">uncond_input_ids</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM-628"><a href="#MMadaModelLM-628"><span class="linenos">628</span></a>
</span><span id="MMadaModelLM-629"><a href="#MMadaModelLM-629"><span class="linenos">629</span></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span><span class="p">):</span>
</span><span id="MMadaModelLM-630"><a href="#MMadaModelLM-630"><span class="linenos">630</span></a>            <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">guidance_scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MMadaModelLM-631"><a href="#MMadaModelLM-631"><span class="linenos">631</span></a>                <span class="n">uncond_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">uncond_prefix</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-632"><a href="#MMadaModelLM-632"><span class="linenos">632</span></a>                <span class="n">model_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">uncond_input_ids</span><span class="p">])</span>
</span><span id="MMadaModelLM-633"><a href="#MMadaModelLM-633"><span class="linenos">633</span></a>                <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">uncond_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM-634"><a href="#MMadaModelLM-634"><span class="linenos">634</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-635"><a href="#MMadaModelLM-635"><span class="linenos">635</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-636"><a href="#MMadaModelLM-636"><span class="linenos">636</span></a>                <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="MMadaModelLM-637"><a href="#MMadaModelLM-637"><span class="linenos">637</span></a>                <span class="n">cond_logits</span><span class="p">,</span> <span class="n">uncond_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM-638"><a href="#MMadaModelLM-638"><span class="linenos">638</span></a>                <span class="c1"># logits = uncond_logits + guidance_scale * (cond_logits - uncond_logits)</span>
</span><span id="MMadaModelLM-639"><a href="#MMadaModelLM-639"><span class="linenos">639</span></a>                <span class="c1"># it seems that muse has a different cfg setting</span>
</span><span id="MMadaModelLM-640"><a href="#MMadaModelLM-640"><span class="linenos">640</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">guidance_scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond_logits</span> <span class="o">-</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="n">uncond_logits</span>
</span><span id="MMadaModelLM-641"><a href="#MMadaModelLM-641"><span class="linenos">641</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="MMadaModelLM-642"><a href="#MMadaModelLM-642"><span class="linenos">642</span></a>                    <span class="p">:,</span>
</span><span id="MMadaModelLM-643"><a href="#MMadaModelLM-643"><span class="linenos">643</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MMadaModelLM-644"><a href="#MMadaModelLM-644"><span class="linenos">644</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="MMadaModelLM-645"><a href="#MMadaModelLM-645"><span class="linenos">645</span></a>                <span class="p">]</span>
</span><span id="MMadaModelLM-646"><a href="#MMadaModelLM-646"><span class="linenos">646</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM-647"><a href="#MMadaModelLM-647"><span class="linenos">647</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-648"><a href="#MMadaModelLM-648"><span class="linenos">648</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM-649"><a href="#MMadaModelLM-649"><span class="linenos">649</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="MMadaModelLM-650"><a href="#MMadaModelLM-650"><span class="linenos">650</span></a>                    <span class="p">:,</span>
</span><span id="MMadaModelLM-651"><a href="#MMadaModelLM-651"><span class="linenos">651</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MMadaModelLM-652"><a href="#MMadaModelLM-652"><span class="linenos">652</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="MMadaModelLM-653"><a href="#MMadaModelLM-653"><span class="linenos">653</span></a>                <span class="p">]</span>
</span><span id="MMadaModelLM-654"><a href="#MMadaModelLM-654"><span class="linenos">654</span></a>
</span><span id="MMadaModelLM-655"><a href="#MMadaModelLM-655"><span class="linenos">655</span></a>            <span class="c1"># logits: 1, 1024, 8192</span>
</span><span id="MMadaModelLM-656"><a href="#MMadaModelLM-656"><span class="linenos">656</span></a>            <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="MMadaModelLM-657"><a href="#MMadaModelLM-657"><span class="linenos">657</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-658"><a href="#MMadaModelLM-658"><span class="linenos">658</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="MMadaModelLM-659"><a href="#MMadaModelLM-659"><span class="linenos">659</span></a>            <span class="c1"># print(f&quot;probs: {probs}, probs.shape: {probs.shape}, sampled: {sampled}, sampled.shape: {sampled.shape}&quot;)</span>
</span><span id="MMadaModelLM-660"><a href="#MMadaModelLM-660"><span class="linenos">660</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">sampled</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 1, 1024</span>
</span><span id="MMadaModelLM-661"><a href="#MMadaModelLM-661"><span class="linenos">661</span></a>
</span><span id="MMadaModelLM-662"><a href="#MMadaModelLM-662"><span class="linenos">662</span></a>            <span class="n">unknown_map</span> <span class="o">=</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span>
</span><span id="MMadaModelLM-663"><a href="#MMadaModelLM-663"><span class="linenos">663</span></a>            <span class="c1"># print(f&quot;unknown_map.sum(dim=-1, keepdim=True): {unknown_map.sum(dim=-1, keepdim=True)}&quot;)</span>
</span><span id="MMadaModelLM-664"><a href="#MMadaModelLM-664"><span class="linenos">664</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span><span class="p">)</span>
</span><span id="MMadaModelLM-665"><a href="#MMadaModelLM-665"><span class="linenos">665</span></a>            <span class="c1"># Defines the mask ratio for the next round. The number to mask out is</span>
</span><span id="MMadaModelLM-666"><a href="#MMadaModelLM-666"><span class="linenos">666</span></a>            <span class="n">current_image_vq_indices</span> <span class="o">=</span> <span class="n">sampled_ids</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM-667"><a href="#MMadaModelLM-667"><span class="linenos">667</span></a>            <span class="c1"># print(f&quot;current_image_vq_indices: {current_image_vq_indices}&quot;)</span>
</span><span id="MMadaModelLM-668"><a href="#MMadaModelLM-668"><span class="linenos">668</span></a>            <span class="n">current_image_vq_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">current_image_vq_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8192</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-669"><a href="#MMadaModelLM-669"><span class="linenos">669</span></a>            <span class="n">current_image</span> <span class="o">=</span> <span class="n">vq_model</span><span class="o">.</span><span class="n">decode_code</span><span class="p">(</span><span class="n">current_image_vq_indices</span><span class="p">)</span>
</span><span id="MMadaModelLM-670"><a href="#MMadaModelLM-670"><span class="linenos">670</span></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">current_image</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="MMadaModelLM-671"><a href="#MMadaModelLM-671"><span class="linenos">671</span></a>            <span class="n">images</span> <span class="o">*=</span> <span class="mf">255.0</span>
</span><span id="MMadaModelLM-672"><a href="#MMadaModelLM-672"><span class="linenos">672</span></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="MMadaModelLM-673"><a href="#MMadaModelLM-673"><span class="linenos">673</span></a>            <span class="n">pil_images</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM-674"><a href="#MMadaModelLM-674"><span class="linenos">674</span></a>            <span class="k">yield</span> <span class="n">pil_images</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">timesteps</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="MMadaModelLM-675"><a href="#MMadaModelLM-675"><span class="linenos">675</span></a>            <span class="c1"># determined by mask_ratio * unknown_number_in_the_beginning.</span>
</span><span id="MMadaModelLM-676"><a href="#MMadaModelLM-676"><span class="linenos">676</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">timesteps</span>
</span><span id="MMadaModelLM-677"><a href="#MMadaModelLM-677"><span class="linenos">677</span></a>            <span class="n">mask_ratio</span> <span class="o">=</span> <span class="n">noise_schedule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>
</span><span id="MMadaModelLM-678"><a href="#MMadaModelLM-678"><span class="linenos">678</span></a>            <span class="c1"># Computes the probabilities of each selected tokens.</span>
</span><span id="MMadaModelLM-679"><a href="#MMadaModelLM-679"><span class="linenos">679</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="o">.</span><span class="n">long</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="MMadaModelLM-680"><a href="#MMadaModelLM-680"><span class="linenos">680</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">selected_probs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM-681"><a href="#MMadaModelLM-681"><span class="linenos">681</span></a>
</span><span id="MMadaModelLM-682"><a href="#MMadaModelLM-682"><span class="linenos">682</span></a>            <span class="c1"># Ignores the tokens given in the input by overwriting their confidence.</span>
</span><span id="MMadaModelLM-683"><a href="#MMadaModelLM-683"><span class="linenos">683</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">selected_probs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
</span><span id="MMadaModelLM-684"><a href="#MMadaModelLM-684"><span class="linenos">684</span></a>            <span class="c1"># Gets mask lens for each sample in the batch according to the mask ratio.</span>
</span><span id="MMadaModelLM-685"><a href="#MMadaModelLM-685"><span class="linenos">685</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">*</span> <span class="n">mask_ratio</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM-686"><a href="#MMadaModelLM-686"><span class="linenos">686</span></a>            <span class="c1"># Keeps at least one of prediction in this round and also masks out at least</span>
</span><span id="MMadaModelLM-687"><a href="#MMadaModelLM-687"><span class="linenos">687</span></a>            <span class="c1"># one and for the next iteration</span>
</span><span id="MMadaModelLM-688"><a href="#MMadaModelLM-688"><span class="linenos">688</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">unknown_map</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">))</span>
</span><span id="MMadaModelLM-689"><a href="#MMadaModelLM-689"><span class="linenos">689</span></a>            <span class="c1"># print(f&quot;mask_len: {mask_len}, mask_len.shape: {mask_len.shape}&quot;)</span>
</span><span id="MMadaModelLM-690"><a href="#MMadaModelLM-690"><span class="linenos">690</span></a>            <span class="c1"># Adds noise for randomness</span>
</span><span id="MMadaModelLM-691"><a href="#MMadaModelLM-691"><span class="linenos">691</span></a>            <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span>
</span><span id="MMadaModelLM-692"><a href="#MMadaModelLM-692"><span class="linenos">692</span></a>            <span class="n">masking</span> <span class="o">=</span> <span class="n">mask_by_random_topk</span><span class="p">(</span><span class="n">mask_len</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>
</span><span id="MMadaModelLM-693"><a href="#MMadaModelLM-693"><span class="linenos">693</span></a>            <span class="c1"># Masks tokens with lower confidence.</span>
</span><span id="MMadaModelLM-694"><a href="#MMadaModelLM-694"><span class="linenos">694</span></a>            <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span><span class="p">)</span>
</span><span id="MMadaModelLM-695"><a href="#MMadaModelLM-695"><span class="linenos">695</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">)</span>
</span><span id="MMadaModelLM-696"><a href="#MMadaModelLM-696"><span class="linenos">696</span></a>
</span><span id="MMadaModelLM-697"><a href="#MMadaModelLM-697"><span class="linenos">697</span></a>        <span class="k">return</span> <span class="n">sampled_ids</span>
</span></pre></div>


            <div class="docstring"><p>Extremely barebones HF model wrapper.</p>
</div>


                            <div id="MMadaModelLM.__init__" class="classattr">
                                        <input id="MMadaModelLM.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MMadaModelLM</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config</span><span class="p">:</span> <span class="n"><a href="#MMadaConfig">MMadaConfig</a></span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="MMadaModelLM.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM.__init__-107"><a href="#MMadaModelLM.__init__-107"><span class="linenos">107</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">MMadaConfig</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MMadaModelLM.__init__-108"><a href="#MMadaModelLM.__init__-108"><span class="linenos">108</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing MMadaModelLM with config: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="MMadaModelLM.__init__-109"><a href="#MMadaModelLM.__init__-109"><span class="linenos">109</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MMadaModelLM.__init__-110"><a href="#MMadaModelLM.__init__-110"><span class="linenos">110</span></a>
</span><span id="MMadaModelLM.__init__-111"><a href="#MMadaModelLM.__init__-111"><span class="linenos">111</span></a>        <span class="c1"># # resize token embeddings</span>
</span><span id="MMadaModelLM.__init__-112"><a href="#MMadaModelLM.__init__-112"><span class="linenos">112</span></a>        <span class="c1"># print(f&quot;Resizing token embeddings to {config.new_vocab_size}&quot;)</span>
</span><span id="MMadaModelLM.__init__-113"><a href="#MMadaModelLM.__init__-113"><span class="linenos">113</span></a>        <span class="c1"># self.resize_token_embeddings(config.new_vocab_size)</span>
</span></pre></div>


            <div class="docstring"><p>Args:
config ([<code>PretrainedConfig</code>]):
    Model configuration class with all the parameters of the model. Initializing with a config file does not
    load the weights associated with the model, only the configuration. Check out the
    [<code>~PreTrainedModel.from_pretrained</code>] method to load the model weights.</p>
</div>


                            </div>
                            <div id="MMadaModelLM.config_class" class="classattr">
                                <div class="attr variable">
            <span class="name">config_class</span>        =
<span class="default_value">&lt;class &#39;<a href="#MMadaConfig">MMadaConfig</a>&#39;&gt;</span>

        
    </div>
    <a class="headerlink" href="#MMadaModelLM.config_class"></a>
    
    

                            </div>
                            <div id="MMadaModelLM.base_model_prefix" class="classattr">
                                <div class="attr variable">
            <span class="name">base_model_prefix</span>        =
<span class="default_value">&#39;model&#39;</span>

        
    </div>
    <a class="headerlink" href="#MMadaModelLM.base_model_prefix"></a>
    
    

                            </div>
                            <div id="MMadaModelLM.from_pretrained" class="classattr">
                                        <input id="MMadaModelLM.from_pretrained-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_pretrained</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">pretrained_model_name_or_path</span>, </span><span class="param"><span class="o">*</span><span class="n">model_args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MMadaModelLM.from_pretrained-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM.from_pretrained"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM.from_pretrained-88"><a href="#MMadaModelLM.from_pretrained-88"><span class="linenos"> 88</span></a>    <span class="nd">@classmethod</span>
</span><span id="MMadaModelLM.from_pretrained-89"><a href="#MMadaModelLM.from_pretrained-89"><span class="linenos"> 89</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_pretrained</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="o">*</span><span class="n">model_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MMadaModelLM.from_pretrained-90"><a href="#MMadaModelLM.from_pretrained-90"><span class="linenos"> 90</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Override from_pretrained to inject repo_id into config.&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM.from_pretrained-91"><a href="#MMadaModelLM.from_pretrained-91"><span class="linenos"> 91</span></a>        <span class="n">repo_id</span> <span class="o">=</span> <span class="n">pretrained_model_name_or_path</span>
</span><span id="MMadaModelLM.from_pretrained-92"><a href="#MMadaModelLM.from_pretrained-92"><span class="linenos"> 92</span></a>
</span><span id="MMadaModelLM.from_pretrained-93"><a href="#MMadaModelLM.from_pretrained-93"><span class="linenos"> 93</span></a>        <span class="c1"># Load config first and inject repo_id BEFORE calling super().from_pretrained</span>
</span><span id="MMadaModelLM.from_pretrained-94"><a href="#MMadaModelLM.from_pretrained-94"><span class="linenos"> 94</span></a>        <span class="c1"># This ensures repo_id is available during __init__</span>
</span><span id="MMadaModelLM.from_pretrained-95"><a href="#MMadaModelLM.from_pretrained-95"><span class="linenos"> 95</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_class</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config_kwargs&quot;</span><span class="p">,</span> <span class="p">{}))</span>
</span><span id="MMadaModelLM.from_pretrained-96"><a href="#MMadaModelLM.from_pretrained-96"><span class="linenos"> 96</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;repo_id&quot;</span><span class="p">,</span> <span class="n">repo_id</span><span class="p">)</span>
</span><span id="MMadaModelLM.from_pretrained-97"><a href="#MMadaModelLM.from_pretrained-97"><span class="linenos"> 97</span></a>
</span><span id="MMadaModelLM.from_pretrained-98"><a href="#MMadaModelLM.from_pretrained-98"><span class="linenos"> 98</span></a>        <span class="c1"># Update kwargs to pass the modified config</span>
</span><span id="MMadaModelLM.from_pretrained-99"><a href="#MMadaModelLM.from_pretrained-99"><span class="linenos"> 99</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="MMadaModelLM.from_pretrained-100"><a href="#MMadaModelLM.from_pretrained-100"><span class="linenos">100</span></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="MMadaModelLM.from_pretrained-101"><a href="#MMadaModelLM.from_pretrained-101"><span class="linenos">101</span></a>
</span><span id="MMadaModelLM.from_pretrained-102"><a href="#MMadaModelLM.from_pretrained-102"><span class="linenos">102</span></a>        <span class="c1"># Now call parent&#39;s from_pretrained with the modified config</span>
</span><span id="MMadaModelLM.from_pretrained-103"><a href="#MMadaModelLM.from_pretrained-103"><span class="linenos">103</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name_or_path</span><span class="p">,</span> <span class="o">*</span><span class="n">model_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MMadaModelLM.from_pretrained-104"><a href="#MMadaModelLM.from_pretrained-104"><span class="linenos">104</span></a>
</span><span id="MMadaModelLM.from_pretrained-105"><a href="#MMadaModelLM.from_pretrained-105"><span class="linenos">105</span></a>        <span class="k">return</span> <span class="n">model</span>
</span></pre></div>


            <div class="docstring"><p>Override from_pretrained to inject repo_id into config.</p>
</div>


                            </div>
                            <div id="MMadaModelLM.t2i_generate" class="classattr">
                                        <input id="MMadaModelLM.t2i_generate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-torch.no_grad">@torch.no_grad()</div>

        <span class="def">def</span>
        <span class="name">t2i_generate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">uncond_input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">uncond_attention_mask</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">timesteps</span><span class="o">=</span><span class="mi">18</span>,</span><span class="param">	<span class="n">guidance_scale</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">noise_schedule</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">cosine_schedule</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">generator</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">config</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">seq_len</span><span class="o">=</span><span class="mi">1024</span>,</span><span class="param">	<span class="n">mask_token_id</span><span class="o">=</span><span class="mi">126336</span>,</span><span class="param">	<span class="n">resolution</span><span class="o">=</span><span class="mi">512</span>,</span><span class="param">	<span class="n">codebook_size</span><span class="o">=</span><span class="mi">8192</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MMadaModelLM.t2i_generate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM.t2i_generate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM.t2i_generate-115"><a href="#MMadaModelLM.t2i_generate-115"><span class="linenos">115</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="MMadaModelLM.t2i_generate-116"><a href="#MMadaModelLM.t2i_generate-116"><span class="linenos">116</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">t2i_generate</span><span class="p">(</span>
</span><span id="MMadaModelLM.t2i_generate-117"><a href="#MMadaModelLM.t2i_generate-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-118"><a href="#MMadaModelLM.t2i_generate-118"><span class="linenos">118</span></a>        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-119"><a href="#MMadaModelLM.t2i_generate-119"><span class="linenos">119</span></a>        <span class="n">uncond_input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-120"><a href="#MMadaModelLM.t2i_generate-120"><span class="linenos">120</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-121"><a href="#MMadaModelLM.t2i_generate-121"><span class="linenos">121</span></a>        <span class="n">uncond_attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-122"><a href="#MMadaModelLM.t2i_generate-122"><span class="linenos">122</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-123"><a href="#MMadaModelLM.t2i_generate-123"><span class="linenos">123</span></a>        <span class="n">timesteps</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>  <span class="c1"># ideal number of steps is 18 in maskgit paper</span>
</span><span id="MMadaModelLM.t2i_generate-124"><a href="#MMadaModelLM.t2i_generate-124"><span class="linenos">124</span></a>        <span class="n">guidance_scale</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-125"><a href="#MMadaModelLM.t2i_generate-125"><span class="linenos">125</span></a>        <span class="n">noise_schedule</span><span class="o">=</span><span class="n">cosine_schedule</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-126"><a href="#MMadaModelLM.t2i_generate-126"><span class="linenos">126</span></a>        <span class="n">generator</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-127"><a href="#MMadaModelLM.t2i_generate-127"><span class="linenos">127</span></a>        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-128"><a href="#MMadaModelLM.t2i_generate-128"><span class="linenos">128</span></a>        <span class="n">seq_len</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-129"><a href="#MMadaModelLM.t2i_generate-129"><span class="linenos">129</span></a>        <span class="n">mask_token_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-130"><a href="#MMadaModelLM.t2i_generate-130"><span class="linenos">130</span></a>        <span class="n">resolution</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-131"><a href="#MMadaModelLM.t2i_generate-131"><span class="linenos">131</span></a>        <span class="n">codebook_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-132"><a href="#MMadaModelLM.t2i_generate-132"><span class="linenos">132</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-133"><a href="#MMadaModelLM.t2i_generate-133"><span class="linenos">133</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM.t2i_generate-134"><a href="#MMadaModelLM.t2i_generate-134"><span class="linenos">134</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM.t2i_generate-135"><a href="#MMadaModelLM.t2i_generate-135"><span class="linenos">135</span></a><span class="sd">        Generate 1:1 similar to the original MaskGit repo</span>
</span><span id="MMadaModelLM.t2i_generate-136"><a href="#MMadaModelLM.t2i_generate-136"><span class="linenos">136</span></a><span class="sd">        https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79</span>
</span><span id="MMadaModelLM.t2i_generate-137"><a href="#MMadaModelLM.t2i_generate-137"><span class="linenos">137</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MMadaModelLM.t2i_generate-138"><a href="#MMadaModelLM.t2i_generate-138"><span class="linenos">138</span></a>
</span><span id="MMadaModelLM.t2i_generate-139"><a href="#MMadaModelLM.t2i_generate-139"><span class="linenos">139</span></a>        <span class="c1"># begin with all image token ids masked</span>
</span><span id="MMadaModelLM.t2i_generate-140"><a href="#MMadaModelLM.t2i_generate-140"><span class="linenos">140</span></a>        <span class="c1"># mask token</span>
</span><span id="MMadaModelLM.t2i_generate-141"><a href="#MMadaModelLM.t2i_generate-141"><span class="linenos">141</span></a>        <span class="n">mask_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_ids</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MMadaModelLM.t2i_generate-142"><a href="#MMadaModelLM.t2i_generate-142"><span class="linenos">142</span></a>        <span class="n">num_vq_tokens</span> <span class="o">=</span> <span class="n">seq_len</span>
</span><span id="MMadaModelLM.t2i_generate-143"><a href="#MMadaModelLM.t2i_generate-143"><span class="linenos">143</span></a>        <span class="n">num_new_special_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MMadaModelLM.t2i_generate-144"><a href="#MMadaModelLM.t2i_generate-144"><span class="linenos">144</span></a>        <span class="n">uni_prompting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uni_prompting&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-145"><a href="#MMadaModelLM.t2i_generate-145"><span class="linenos">145</span></a>        <span class="c1"># print(f&quot;config.model.mmada.llm_vocab_size: {config.model.mmada.llm_vocab_size}, {len(uni_prompting.text_tokenizer)}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate-146"><a href="#MMadaModelLM.t2i_generate-146"><span class="linenos">146</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM.t2i_generate-147"><a href="#MMadaModelLM.t2i_generate-147"><span class="linenos">147</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="MMadaModelLM.t2i_generate-148"><a href="#MMadaModelLM.t2i_generate-148"><span class="linenos">148</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_new_special_tokens</span>
</span><span id="MMadaModelLM.t2i_generate-149"><a href="#MMadaModelLM.t2i_generate-149"><span class="linenos">149</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-150"><a href="#MMadaModelLM.t2i_generate-150"><span class="linenos">150</span></a>
</span><span id="MMadaModelLM.t2i_generate-151"><a href="#MMadaModelLM.t2i_generate-151"><span class="linenos">151</span></a>        <span class="c1"># for classifier-free guidance</span>
</span><span id="MMadaModelLM.t2i_generate-152"><a href="#MMadaModelLM.t2i_generate-152"><span class="linenos">152</span></a>        <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM.t2i_generate-153"><a href="#MMadaModelLM.t2i_generate-153"><span class="linenos">153</span></a>            <span class="n">uncond_prefix</span> <span class="o">=</span> <span class="n">uncond_input_ids</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM.t2i_generate-154"><a href="#MMadaModelLM.t2i_generate-154"><span class="linenos">154</span></a>
</span><span id="MMadaModelLM.t2i_generate-155"><a href="#MMadaModelLM.t2i_generate-155"><span class="linenos">155</span></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span><span class="p">):</span>
</span><span id="MMadaModelLM.t2i_generate-156"><a href="#MMadaModelLM.t2i_generate-156"><span class="linenos">156</span></a>            <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">guidance_scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MMadaModelLM.t2i_generate-157"><a href="#MMadaModelLM.t2i_generate-157"><span class="linenos">157</span></a>                <span class="n">uncond_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">uncond_prefix</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-158"><a href="#MMadaModelLM.t2i_generate-158"><span class="linenos">158</span></a>                <span class="n">model_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">uncond_input_ids</span><span class="p">])</span>
</span><span id="MMadaModelLM.t2i_generate-159"><a href="#MMadaModelLM.t2i_generate-159"><span class="linenos">159</span></a>                <span class="n">all_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">uncond_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-160"><a href="#MMadaModelLM.t2i_generate-160"><span class="linenos">160</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">all_attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-161"><a href="#MMadaModelLM.t2i_generate-161"><span class="linenos">161</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.t2i_generate-162"><a href="#MMadaModelLM.t2i_generate-162"><span class="linenos">162</span></a>                <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate-163"><a href="#MMadaModelLM.t2i_generate-163"><span class="linenos">163</span></a>                <span class="n">cond_logits</span><span class="p">,</span> <span class="n">uncond_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-164"><a href="#MMadaModelLM.t2i_generate-164"><span class="linenos">164</span></a>                <span class="c1"># logits = uncond_logits + guidance_scale * (cond_logits - uncond_logits)</span>
</span><span id="MMadaModelLM.t2i_generate-165"><a href="#MMadaModelLM.t2i_generate-165"><span class="linenos">165</span></a>                <span class="c1"># it seems that muse has a different cfg setting</span>
</span><span id="MMadaModelLM.t2i_generate-166"><a href="#MMadaModelLM.t2i_generate-166"><span class="linenos">166</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">guidance_scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond_logits</span> <span class="o">-</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="n">uncond_logits</span>
</span><span id="MMadaModelLM.t2i_generate-167"><a href="#MMadaModelLM.t2i_generate-167"><span class="linenos">167</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="MMadaModelLM.t2i_generate-168"><a href="#MMadaModelLM.t2i_generate-168"><span class="linenos">168</span></a>                    <span class="p">:,</span>
</span><span id="MMadaModelLM.t2i_generate-169"><a href="#MMadaModelLM.t2i_generate-169"><span class="linenos">169</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-170"><a href="#MMadaModelLM.t2i_generate-170"><span class="linenos">170</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-171"><a href="#MMadaModelLM.t2i_generate-171"><span class="linenos">171</span></a>                <span class="p">]</span>
</span><span id="MMadaModelLM.t2i_generate-172"><a href="#MMadaModelLM.t2i_generate-172"><span class="linenos">172</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.t2i_generate-173"><a href="#MMadaModelLM.t2i_generate-173"><span class="linenos">173</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-174"><a href="#MMadaModelLM.t2i_generate-174"><span class="linenos">174</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.t2i_generate-175"><a href="#MMadaModelLM.t2i_generate-175"><span class="linenos">175</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="MMadaModelLM.t2i_generate-176"><a href="#MMadaModelLM.t2i_generate-176"><span class="linenos">176</span></a>                    <span class="p">:,</span>
</span><span id="MMadaModelLM.t2i_generate-177"><a href="#MMadaModelLM.t2i_generate-177"><span class="linenos">177</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-178"><a href="#MMadaModelLM.t2i_generate-178"><span class="linenos">178</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate-179"><a href="#MMadaModelLM.t2i_generate-179"><span class="linenos">179</span></a>                <span class="p">]</span>
</span><span id="MMadaModelLM.t2i_generate-180"><a href="#MMadaModelLM.t2i_generate-180"><span class="linenos">180</span></a>
</span><span id="MMadaModelLM.t2i_generate-181"><a href="#MMadaModelLM.t2i_generate-181"><span class="linenos">181</span></a>            <span class="c1"># logits: 1, 1024, 8192</span>
</span><span id="MMadaModelLM.t2i_generate-182"><a href="#MMadaModelLM.t2i_generate-182"><span class="linenos">182</span></a>            <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate-183"><a href="#MMadaModelLM.t2i_generate-183"><span class="linenos">183</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-184"><a href="#MMadaModelLM.t2i_generate-184"><span class="linenos">184</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="MMadaModelLM.t2i_generate-185"><a href="#MMadaModelLM.t2i_generate-185"><span class="linenos">185</span></a>            <span class="c1"># print(f&quot;probs: {probs}, probs.shape: {probs.shape}, sampled: {sampled}, sampled.shape: {sampled.shape}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate-186"><a href="#MMadaModelLM.t2i_generate-186"><span class="linenos">186</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">sampled</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 1, 1024</span>
</span><span id="MMadaModelLM.t2i_generate-187"><a href="#MMadaModelLM.t2i_generate-187"><span class="linenos">187</span></a>
</span><span id="MMadaModelLM.t2i_generate-188"><a href="#MMadaModelLM.t2i_generate-188"><span class="linenos">188</span></a>            <span class="n">unknown_map</span> <span class="o">=</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span>
</span><span id="MMadaModelLM.t2i_generate-189"><a href="#MMadaModelLM.t2i_generate-189"><span class="linenos">189</span></a>            <span class="c1"># print(f&quot;unknown_map.sum(dim=-1, keepdim=True): {unknown_map.sum(dim=-1, keepdim=True)}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate-190"><a href="#MMadaModelLM.t2i_generate-190"><span class="linenos">190</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-191"><a href="#MMadaModelLM.t2i_generate-191"><span class="linenos">191</span></a>            <span class="c1"># Defines the mask ratio for the next round. The number to mask out is</span>
</span><span id="MMadaModelLM.t2i_generate-192"><a href="#MMadaModelLM.t2i_generate-192"><span class="linenos">192</span></a>            <span class="c1"># determined by mask_ratio * unknown_number_in_the_beginning.</span>
</span><span id="MMadaModelLM.t2i_generate-193"><a href="#MMadaModelLM.t2i_generate-193"><span class="linenos">193</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">timesteps</span>
</span><span id="MMadaModelLM.t2i_generate-194"><a href="#MMadaModelLM.t2i_generate-194"><span class="linenos">194</span></a>            <span class="n">mask_ratio</span> <span class="o">=</span> <span class="n">noise_schedule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>
</span><span id="MMadaModelLM.t2i_generate-195"><a href="#MMadaModelLM.t2i_generate-195"><span class="linenos">195</span></a>            <span class="c1"># Computes the probabilities of each selected tokens.</span>
</span><span id="MMadaModelLM.t2i_generate-196"><a href="#MMadaModelLM.t2i_generate-196"><span class="linenos">196</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="o">.</span><span class="n">long</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="MMadaModelLM.t2i_generate-197"><a href="#MMadaModelLM.t2i_generate-197"><span class="linenos">197</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">selected_probs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-198"><a href="#MMadaModelLM.t2i_generate-198"><span class="linenos">198</span></a>
</span><span id="MMadaModelLM.t2i_generate-199"><a href="#MMadaModelLM.t2i_generate-199"><span class="linenos">199</span></a>            <span class="c1"># Ignores the tokens given in the input by overwriting their confidence.</span>
</span><span id="MMadaModelLM.t2i_generate-200"><a href="#MMadaModelLM.t2i_generate-200"><span class="linenos">200</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">selected_probs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-201"><a href="#MMadaModelLM.t2i_generate-201"><span class="linenos">201</span></a>            <span class="c1"># Gets mask lens for each sample in the batch according to the mask ratio.</span>
</span><span id="MMadaModelLM.t2i_generate-202"><a href="#MMadaModelLM.t2i_generate-202"><span class="linenos">202</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">*</span> <span class="n">mask_ratio</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-203"><a href="#MMadaModelLM.t2i_generate-203"><span class="linenos">203</span></a>            <span class="c1"># Keeps at least one of prediction in this round and also masks out at least</span>
</span><span id="MMadaModelLM.t2i_generate-204"><a href="#MMadaModelLM.t2i_generate-204"><span class="linenos">204</span></a>            <span class="c1"># one and for the next iteration</span>
</span><span id="MMadaModelLM.t2i_generate-205"><a href="#MMadaModelLM.t2i_generate-205"><span class="linenos">205</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">unknown_map</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">))</span>
</span><span id="MMadaModelLM.t2i_generate-206"><a href="#MMadaModelLM.t2i_generate-206"><span class="linenos">206</span></a>            <span class="c1"># print(f&quot;mask_len: {mask_len}, mask_len.shape: {mask_len.shape}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate-207"><a href="#MMadaModelLM.t2i_generate-207"><span class="linenos">207</span></a>            <span class="c1"># Adds noise for randomness</span>
</span><span id="MMadaModelLM.t2i_generate-208"><a href="#MMadaModelLM.t2i_generate-208"><span class="linenos">208</span></a>            <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-209"><a href="#MMadaModelLM.t2i_generate-209"><span class="linenos">209</span></a>            <span class="n">masking</span> <span class="o">=</span> <span class="n">mask_by_random_topk</span><span class="p">(</span><span class="n">mask_len</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-210"><a href="#MMadaModelLM.t2i_generate-210"><span class="linenos">210</span></a>            <span class="c1"># Masks tokens with lower confidence.</span>
</span><span id="MMadaModelLM.t2i_generate-211"><a href="#MMadaModelLM.t2i_generate-211"><span class="linenos">211</span></a>            <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-212"><a href="#MMadaModelLM.t2i_generate-212"><span class="linenos">212</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate-213"><a href="#MMadaModelLM.t2i_generate-213"><span class="linenos">213</span></a>
</span><span id="MMadaModelLM.t2i_generate-214"><a href="#MMadaModelLM.t2i_generate-214"><span class="linenos">214</span></a>        <span class="k">return</span> <span class="n">sampled_ids</span>
</span></pre></div>


            <div class="docstring"><p>Generate 1:1 similar to the original MaskGit repo
<a href="https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79">https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79</a></p>
</div>


                            </div>
                            <div id="MMadaModelLM.forward_process" class="classattr">
                                        <input id="MMadaModelLM.forward_process-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward_process</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">input_ids</span>,</span><span class="param">	<span class="n">labels</span>,</span><span class="param">	<span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">batch_size_lm</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">batch_size_mmu</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">p_mask_lm</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">p_mask_mmu</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">answer_lengths</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">answer_lengths_lm</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MMadaModelLM.forward_process-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM.forward_process"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM.forward_process-216"><a href="#MMadaModelLM.forward_process-216"><span class="linenos">216</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_process</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_process-217"><a href="#MMadaModelLM.forward_process-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-218"><a href="#MMadaModelLM.forward_process-218"><span class="linenos">218</span></a>        <span class="n">input_ids</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-219"><a href="#MMadaModelLM.forward_process-219"><span class="linenos">219</span></a>        <span class="n">labels</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-220"><a href="#MMadaModelLM.forward_process-220"><span class="linenos">220</span></a>        <span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-221"><a href="#MMadaModelLM.forward_process-221"><span class="linenos">221</span></a>        <span class="n">batch_size_lm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-222"><a href="#MMadaModelLM.forward_process-222"><span class="linenos">222</span></a>        <span class="n">batch_size_mmu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-223"><a href="#MMadaModelLM.forward_process-223"><span class="linenos">223</span></a>        <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-224"><a href="#MMadaModelLM.forward_process-224"><span class="linenos">224</span></a>        <span class="n">p_mask_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-225"><a href="#MMadaModelLM.forward_process-225"><span class="linenos">225</span></a>        <span class="n">p_mask_mmu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-226"><a href="#MMadaModelLM.forward_process-226"><span class="linenos">226</span></a>        <span class="n">answer_lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-227"><a href="#MMadaModelLM.forward_process-227"><span class="linenos">227</span></a>        <span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-228"><a href="#MMadaModelLM.forward_process-228"><span class="linenos">228</span></a>        <span class="n">answer_lengths_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-229"><a href="#MMadaModelLM.forward_process-229"><span class="linenos">229</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM.forward_process-230"><a href="#MMadaModelLM.forward_process-230"><span class="linenos">230</span></a>        <span class="c1"># attention bias, True for batch_size, 1, seq_len, seq_len</span>
</span><span id="MMadaModelLM.forward_process-231"><a href="#MMadaModelLM.forward_process-231"><span class="linenos">231</span></a>        <span class="n">attention_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_process-232"><a href="#MMadaModelLM.forward_process-232"><span class="linenos">232</span></a>        <span class="n">attention_bias_t2i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2i_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">t2i_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-233"><a href="#MMadaModelLM.forward_process-233"><span class="linenos">233</span></a>        <span class="n">attention_bias</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_bias_t2i</span>
</span><span id="MMadaModelLM.forward_process-234"><a href="#MMadaModelLM.forward_process-234"><span class="linenos">234</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.forward_process-235"><a href="#MMadaModelLM.forward_process-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process-236"><a href="#MMadaModelLM.forward_process-236"><span class="linenos">236</span></a>
</span><span id="MMadaModelLM.forward_process-237"><a href="#MMadaModelLM.forward_process-237"><span class="linenos">237</span></a>        <span class="k">if</span> <span class="n">batch_size_t2i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MMadaModelLM.forward_process-238"><a href="#MMadaModelLM.forward_process-238"><span class="linenos">238</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-239"><a href="#MMadaModelLM.forward_process-239"><span class="linenos">239</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.forward_process-240"><a href="#MMadaModelLM.forward_process-240"><span class="linenos">240</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_process-241"><a href="#MMadaModelLM.forward_process-241"><span class="linenos">241</span></a>                <span class="n">logits</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process-242"><a href="#MMadaModelLM.forward_process-242"><span class="linenos">242</span></a>                <span class="n">labels</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process-243"><a href="#MMadaModelLM.forward_process-243"><span class="linenos">243</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-244"><a href="#MMadaModelLM.forward_process-244"><span class="linenos">244</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-245"><a href="#MMadaModelLM.forward_process-245"><span class="linenos">245</span></a>
</span><span id="MMadaModelLM.forward_process-246"><a href="#MMadaModelLM.forward_process-246"><span class="linenos">246</span></a>        <span class="n">masked_indices</span> <span class="o">=</span> <span class="n">input_ids</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mask_token_id</span>
</span><span id="MMadaModelLM.forward_process-247"><a href="#MMadaModelLM.forward_process-247"><span class="linenos">247</span></a>        <span class="n">masked_indices_lm</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process-248"><a href="#MMadaModelLM.forward_process-248"><span class="linenos">248</span></a>        <span class="n">masked_indices_mmu</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:]</span>
</span><span id="MMadaModelLM.forward_process-249"><a href="#MMadaModelLM.forward_process-249"><span class="linenos">249</span></a>        <span class="n">p_mask_lm</span> <span class="o">=</span> <span class="n">p_mask_lm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_lm</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-250"><a href="#MMadaModelLM.forward_process-250"><span class="linenos">250</span></a>        <span class="n">p_mask_mmu</span> <span class="o">=</span> <span class="n">p_mask_mmu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-251"><a href="#MMadaModelLM.forward_process-251"><span class="linenos">251</span></a>        <span class="n">answer_lengths</span> <span class="o">=</span> <span class="n">answer_lengths</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-252"><a href="#MMadaModelLM.forward_process-252"><span class="linenos">252</span></a>        <span class="n">loss_lm</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM.forward_process-253"><a href="#MMadaModelLM.forward_process-253"><span class="linenos">253</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_process-254"><a href="#MMadaModelLM.forward_process-254"><span class="linenos">254</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process-255"><a href="#MMadaModelLM.forward_process-255"><span class="linenos">255</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process-256"><a href="#MMadaModelLM.forward_process-256"><span class="linenos">256</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-257"><a href="#MMadaModelLM.forward_process-257"><span class="linenos">257</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-258"><a href="#MMadaModelLM.forward_process-258"><span class="linenos">258</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-259"><a href="#MMadaModelLM.forward_process-259"><span class="linenos">259</span></a>            <span class="o">/</span> <span class="n">p_mask_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process-260"><a href="#MMadaModelLM.forward_process-260"><span class="linenos">260</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-261"><a href="#MMadaModelLM.forward_process-261"><span class="linenos">261</span></a>
</span><span id="MMadaModelLM.forward_process-262"><a href="#MMadaModelLM.forward_process-262"><span class="linenos">262</span></a>        <span class="k">if</span> <span class="n">answer_lengths_lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM.forward_process-263"><a href="#MMadaModelLM.forward_process-263"><span class="linenos">263</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_lm</span> <span class="o">/</span> <span class="n">answer_lengths_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_process-264"><a href="#MMadaModelLM.forward_process-264"><span class="linenos">264</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.forward_process-265"><a href="#MMadaModelLM.forward_process-265"><span class="linenos">265</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">loss_lm</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">logits</span><span class="p">[</span><span class="n">batch_size_t2i</span> <span class="p">:</span> <span class="n">batch_size_t2i</span> <span class="o">+</span> <span class="n">batch_size_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_process-266"><a href="#MMadaModelLM.forward_process-266"><span class="linenos">266</span></a>
</span><span id="MMadaModelLM.forward_process-267"><a href="#MMadaModelLM.forward_process-267"><span class="linenos">267</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM.forward_process-268"><a href="#MMadaModelLM.forward_process-268"><span class="linenos">268</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_process-269"><a href="#MMadaModelLM.forward_process-269"><span class="linenos">269</span></a>                <span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process-270"><a href="#MMadaModelLM.forward_process-270"><span class="linenos">270</span></a>                <span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process-271"><a href="#MMadaModelLM.forward_process-271"><span class="linenos">271</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-272"><a href="#MMadaModelLM.forward_process-272"><span class="linenos">272</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process-273"><a href="#MMadaModelLM.forward_process-273"><span class="linenos">273</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-274"><a href="#MMadaModelLM.forward_process-274"><span class="linenos">274</span></a>            <span class="o">/</span> <span class="n">p_mask_mmu</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process-275"><a href="#MMadaModelLM.forward_process-275"><span class="linenos">275</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process-276"><a href="#MMadaModelLM.forward_process-276"><span class="linenos">276</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_mmu</span> <span class="o">/</span> <span class="n">answer_lengths</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="n">batch_size_mmu</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_process-277"><a href="#MMadaModelLM.forward_process-277"><span class="linenos">277</span></a>
</span><span id="MMadaModelLM.forward_process-278"><a href="#MMadaModelLM.forward_process-278"><span class="linenos">278</span></a>        <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">loss_t2i</span><span class="p">,</span> <span class="n">loss_lm</span><span class="p">,</span> <span class="n">loss_mmu</span>
</span></pre></div>


    

                            </div>
                            <div id="MMadaModelLM.forward_process_with_r2i" class="classattr">
                                        <input id="MMadaModelLM.forward_process_with_r2i-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward_process_with_r2i</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">input_ids</span>,</span><span class="param">	<span class="n">labels</span>,</span><span class="param">	<span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">batch_size_lm</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">batch_size_mmu</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">batch_size_r2i</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">p_mask_lm</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">p_mask_mmu</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">p_mask_r2i</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">answer_lengths</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">answer_lengths_lm</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">answer_lengths_r2i</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MMadaModelLM.forward_process_with_r2i-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM.forward_process_with_r2i"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM.forward_process_with_r2i-280"><a href="#MMadaModelLM.forward_process_with_r2i-280"><span class="linenos">280</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_process_with_r2i</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-281"><a href="#MMadaModelLM.forward_process_with_r2i-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-282"><a href="#MMadaModelLM.forward_process_with_r2i-282"><span class="linenos">282</span></a>        <span class="n">input_ids</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-283"><a href="#MMadaModelLM.forward_process_with_r2i-283"><span class="linenos">283</span></a>        <span class="n">labels</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-284"><a href="#MMadaModelLM.forward_process_with_r2i-284"><span class="linenos">284</span></a>        <span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-285"><a href="#MMadaModelLM.forward_process_with_r2i-285"><span class="linenos">285</span></a>        <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-286"><a href="#MMadaModelLM.forward_process_with_r2i-286"><span class="linenos">286</span></a>        <span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-287"><a href="#MMadaModelLM.forward_process_with_r2i-287"><span class="linenos">287</span></a>        <span class="n">batch_size_lm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-288"><a href="#MMadaModelLM.forward_process_with_r2i-288"><span class="linenos">288</span></a>        <span class="n">batch_size_mmu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-289"><a href="#MMadaModelLM.forward_process_with_r2i-289"><span class="linenos">289</span></a>        <span class="n">batch_size_r2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-290"><a href="#MMadaModelLM.forward_process_with_r2i-290"><span class="linenos">290</span></a>        <span class="n">p_mask_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-291"><a href="#MMadaModelLM.forward_process_with_r2i-291"><span class="linenos">291</span></a>        <span class="n">p_mask_mmu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-292"><a href="#MMadaModelLM.forward_process_with_r2i-292"><span class="linenos">292</span></a>        <span class="n">p_mask_r2i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-293"><a href="#MMadaModelLM.forward_process_with_r2i-293"><span class="linenos">293</span></a>        <span class="n">answer_lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-294"><a href="#MMadaModelLM.forward_process_with_r2i-294"><span class="linenos">294</span></a>        <span class="n">answer_lengths_lm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-295"><a href="#MMadaModelLM.forward_process_with_r2i-295"><span class="linenos">295</span></a>        <span class="n">answer_lengths_r2i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-296"><a href="#MMadaModelLM.forward_process_with_r2i-296"><span class="linenos">296</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-297"><a href="#MMadaModelLM.forward_process_with_r2i-297"><span class="linenos">297</span></a>        <span class="c1"># attention bias, True for batch_size, 1, seq_len, seq_len</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-298"><a href="#MMadaModelLM.forward_process_with_r2i-298"><span class="linenos">298</span></a>        <span class="n">attention_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-299"><a href="#MMadaModelLM.forward_process_with_r2i-299"><span class="linenos">299</span></a>        <span class="n">attention_bias_t2i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2i_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">t2i_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-300"><a href="#MMadaModelLM.forward_process_with_r2i-300"><span class="linenos">300</span></a>        <span class="n">attention_bias</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_bias_t2i</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-301"><a href="#MMadaModelLM.forward_process_with_r2i-301"><span class="linenos">301</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-302"><a href="#MMadaModelLM.forward_process_with_r2i-302"><span class="linenos">302</span></a>        <span class="c1"># logits = self(input_ids).logits</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-303"><a href="#MMadaModelLM.forward_process_with_r2i-303"><span class="linenos">303</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-304"><a href="#MMadaModelLM.forward_process_with_r2i-304"><span class="linenos">304</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-305"><a href="#MMadaModelLM.forward_process_with_r2i-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="n">batch_size_t2i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-306"><a href="#MMadaModelLM.forward_process_with_r2i-306"><span class="linenos">306</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-307"><a href="#MMadaModelLM.forward_process_with_r2i-307"><span class="linenos">307</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-308"><a href="#MMadaModelLM.forward_process_with_r2i-308"><span class="linenos">308</span></a>            <span class="c1"># t2i loss</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-309"><a href="#MMadaModelLM.forward_process_with_r2i-309"><span class="linenos">309</span></a>            <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-310"><a href="#MMadaModelLM.forward_process_with_r2i-310"><span class="linenos">310</span></a>                <span class="n">logits</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-311"><a href="#MMadaModelLM.forward_process_with_r2i-311"><span class="linenos">311</span></a>                <span class="n">labels</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-312"><a href="#MMadaModelLM.forward_process_with_r2i-312"><span class="linenos">312</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-313"><a href="#MMadaModelLM.forward_process_with_r2i-313"><span class="linenos">313</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-314"><a href="#MMadaModelLM.forward_process_with_r2i-314"><span class="linenos">314</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-315"><a href="#MMadaModelLM.forward_process_with_r2i-315"><span class="linenos">315</span></a>        <span class="c1"># llada loss</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-316"><a href="#MMadaModelLM.forward_process_with_r2i-316"><span class="linenos">316</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-317"><a href="#MMadaModelLM.forward_process_with_r2i-317"><span class="linenos">317</span></a>        <span class="n">start_lm</span> <span class="o">=</span> <span class="n">batch_size_t2i</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-318"><a href="#MMadaModelLM.forward_process_with_r2i-318"><span class="linenos">318</span></a>        <span class="n">end_lm</span> <span class="o">=</span> <span class="n">start_lm</span> <span class="o">+</span> <span class="n">batch_size_lm</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-319"><a href="#MMadaModelLM.forward_process_with_r2i-319"><span class="linenos">319</span></a>        <span class="n">start_mmu</span> <span class="o">=</span> <span class="n">end_lm</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-320"><a href="#MMadaModelLM.forward_process_with_r2i-320"><span class="linenos">320</span></a>        <span class="n">end_mmu</span> <span class="o">=</span> <span class="n">start_mmu</span> <span class="o">+</span> <span class="n">batch_size_mmu</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-321"><a href="#MMadaModelLM.forward_process_with_r2i-321"><span class="linenos">321</span></a>        <span class="n">start_r2i</span> <span class="o">=</span> <span class="n">end_mmu</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-322"><a href="#MMadaModelLM.forward_process_with_r2i-322"><span class="linenos">322</span></a>        <span class="n">end_r2i</span> <span class="o">=</span> <span class="n">start_r2i</span> <span class="o">+</span> <span class="n">batch_size_r2i</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-323"><a href="#MMadaModelLM.forward_process_with_r2i-323"><span class="linenos">323</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-324"><a href="#MMadaModelLM.forward_process_with_r2i-324"><span class="linenos">324</span></a>        <span class="n">masked_indices</span> <span class="o">=</span> <span class="n">input_ids</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mask_token_id</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-325"><a href="#MMadaModelLM.forward_process_with_r2i-325"><span class="linenos">325</span></a>        <span class="n">masked_indices_lm</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-326"><a href="#MMadaModelLM.forward_process_with_r2i-326"><span class="linenos">326</span></a>        <span class="n">masked_indices_mmu</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-327"><a href="#MMadaModelLM.forward_process_with_r2i-327"><span class="linenos">327</span></a>        <span class="n">masked_indices_r2i</span> <span class="o">=</span> <span class="n">masked_indices</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-328"><a href="#MMadaModelLM.forward_process_with_r2i-328"><span class="linenos">328</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-329"><a href="#MMadaModelLM.forward_process_with_r2i-329"><span class="linenos">329</span></a>        <span class="n">p_mask_lm</span> <span class="o">=</span> <span class="n">p_mask_lm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_lm</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-330"><a href="#MMadaModelLM.forward_process_with_r2i-330"><span class="linenos">330</span></a>        <span class="n">p_mask_mmu</span> <span class="o">=</span> <span class="n">p_mask_mmu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-331"><a href="#MMadaModelLM.forward_process_with_r2i-331"><span class="linenos">331</span></a>        <span class="n">p_mask_r2i</span> <span class="o">=</span> <span class="n">p_mask_r2i</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_r2i</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-332"><a href="#MMadaModelLM.forward_process_with_r2i-332"><span class="linenos">332</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-333"><a href="#MMadaModelLM.forward_process_with_r2i-333"><span class="linenos">333</span></a>        <span class="n">answer_lengths</span> <span class="o">=</span> <span class="n">answer_lengths</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_mmu</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-334"><a href="#MMadaModelLM.forward_process_with_r2i-334"><span class="linenos">334</span></a>        <span class="n">answer_lengths_lm</span> <span class="o">=</span> <span class="n">answer_lengths_lm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_lm</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-335"><a href="#MMadaModelLM.forward_process_with_r2i-335"><span class="linenos">335</span></a>        <span class="n">answer_lengths_r2i</span> <span class="o">=</span> <span class="n">answer_lengths_r2i</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">masked_indices_r2i</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-336"><a href="#MMadaModelLM.forward_process_with_r2i-336"><span class="linenos">336</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-337"><a href="#MMadaModelLM.forward_process_with_r2i-337"><span class="linenos">337</span></a>        <span class="n">loss_lm</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-338"><a href="#MMadaModelLM.forward_process_with_r2i-338"><span class="linenos">338</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-339"><a href="#MMadaModelLM.forward_process_with_r2i-339"><span class="linenos">339</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-340"><a href="#MMadaModelLM.forward_process_with_r2i-340"><span class="linenos">340</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">][</span><span class="n">masked_indices_lm</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-341"><a href="#MMadaModelLM.forward_process_with_r2i-341"><span class="linenos">341</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-342"><a href="#MMadaModelLM.forward_process_with_r2i-342"><span class="linenos">342</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-343"><a href="#MMadaModelLM.forward_process_with_r2i-343"><span class="linenos">343</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-344"><a href="#MMadaModelLM.forward_process_with_r2i-344"><span class="linenos">344</span></a>            <span class="o">/</span> <span class="n">p_mask_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-345"><a href="#MMadaModelLM.forward_process_with_r2i-345"><span class="linenos">345</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-346"><a href="#MMadaModelLM.forward_process_with_r2i-346"><span class="linenos">346</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-347"><a href="#MMadaModelLM.forward_process_with_r2i-347"><span class="linenos">347</span></a>        <span class="k">if</span> <span class="n">answer_lengths_lm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-348"><a href="#MMadaModelLM.forward_process_with_r2i-348"><span class="linenos">348</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_lm</span> <span class="o">/</span> <span class="n">answer_lengths_lm</span><span class="p">[</span><span class="n">masked_indices_lm</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-349"><a href="#MMadaModelLM.forward_process_with_r2i-349"><span class="linenos">349</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-350"><a href="#MMadaModelLM.forward_process_with_r2i-350"><span class="linenos">350</span></a>            <span class="n">loss_lm</span> <span class="o">=</span> <span class="n">loss_lm</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">logits</span><span class="p">[</span><span class="n">start_lm</span><span class="p">:</span><span class="n">end_lm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-351"><a href="#MMadaModelLM.forward_process_with_r2i-351"><span class="linenos">351</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-352"><a href="#MMadaModelLM.forward_process_with_r2i-352"><span class="linenos">352</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-353"><a href="#MMadaModelLM.forward_process_with_r2i-353"><span class="linenos">353</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-354"><a href="#MMadaModelLM.forward_process_with_r2i-354"><span class="linenos">354</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-355"><a href="#MMadaModelLM.forward_process_with_r2i-355"><span class="linenos">355</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">][</span><span class="n">masked_indices_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-356"><a href="#MMadaModelLM.forward_process_with_r2i-356"><span class="linenos">356</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-357"><a href="#MMadaModelLM.forward_process_with_r2i-357"><span class="linenos">357</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-358"><a href="#MMadaModelLM.forward_process_with_r2i-358"><span class="linenos">358</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-359"><a href="#MMadaModelLM.forward_process_with_r2i-359"><span class="linenos">359</span></a>            <span class="o">/</span> <span class="n">p_mask_mmu</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-360"><a href="#MMadaModelLM.forward_process_with_r2i-360"><span class="linenos">360</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-361"><a href="#MMadaModelLM.forward_process_with_r2i-361"><span class="linenos">361</span></a>        <span class="n">loss_mmu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_mmu</span> <span class="o">/</span> <span class="n">answer_lengths</span><span class="p">[</span><span class="n">masked_indices_mmu</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_mmu</span><span class="p">:</span><span class="n">end_mmu</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-362"><a href="#MMadaModelLM.forward_process_with_r2i-362"><span class="linenos">362</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-363"><a href="#MMadaModelLM.forward_process_with_r2i-363"><span class="linenos">363</span></a>        <span class="n">loss_r2i</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-364"><a href="#MMadaModelLM.forward_process_with_r2i-364"><span class="linenos">364</span></a>            <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-365"><a href="#MMadaModelLM.forward_process_with_r2i-365"><span class="linenos">365</span></a>                <span class="n">logits</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">][</span><span class="n">masked_indices_r2i</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-366"><a href="#MMadaModelLM.forward_process_with_r2i-366"><span class="linenos">366</span></a>                <span class="n">labels</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">][</span><span class="n">masked_indices_r2i</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-367"><a href="#MMadaModelLM.forward_process_with_r2i-367"><span class="linenos">367</span></a>                <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-368"><a href="#MMadaModelLM.forward_process_with_r2i-368"><span class="linenos">368</span></a>                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-369"><a href="#MMadaModelLM.forward_process_with_r2i-369"><span class="linenos">369</span></a>            <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-370"><a href="#MMadaModelLM.forward_process_with_r2i-370"><span class="linenos">370</span></a>            <span class="o">/</span> <span class="n">p_mask_r2i</span><span class="p">[</span><span class="n">masked_indices_r2i</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-371"><a href="#MMadaModelLM.forward_process_with_r2i-371"><span class="linenos">371</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-372"><a href="#MMadaModelLM.forward_process_with_r2i-372"><span class="linenos">372</span></a>        <span class="n">loss_r2i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_r2i</span> <span class="o">/</span> <span class="n">answer_lengths_r2i</span><span class="p">[</span><span class="n">masked_indices_r2i</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="n">start_r2i</span><span class="p">:</span><span class="n">end_r2i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_process_with_r2i-373"><a href="#MMadaModelLM.forward_process_with_r2i-373"><span class="linenos">373</span></a>
</span><span id="MMadaModelLM.forward_process_with_r2i-374"><a href="#MMadaModelLM.forward_process_with_r2i-374"><span class="linenos">374</span></a>        <span class="k">return</span> <span class="n">logits</span><span class="p">,</span> <span class="n">loss_t2i</span><span class="p">,</span> <span class="n">loss_lm</span><span class="p">,</span> <span class="n">loss_mmu</span><span class="p">,</span> <span class="n">loss_r2i</span>
</span></pre></div>


    

                            </div>
                            <div id="MMadaModelLM.forward_t2i" class="classattr">
                                        <input id="MMadaModelLM.forward_t2i-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward_t2i</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">input_ids</span>,</span><span class="param">	<span class="n">labels</span>,</span><span class="param">	<span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MMadaModelLM.forward_t2i-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM.forward_t2i"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM.forward_t2i-376"><a href="#MMadaModelLM.forward_t2i-376"><span class="linenos">376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward_t2i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">batch_size_t2i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">t2i_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="MMadaModelLM.forward_t2i-377"><a href="#MMadaModelLM.forward_t2i-377"><span class="linenos">377</span></a>        <span class="c1"># attention bias, True for batch_size, 1, seq_len, seq_len</span>
</span><span id="MMadaModelLM.forward_t2i-378"><a href="#MMadaModelLM.forward_t2i-378"><span class="linenos">378</span></a>        <span class="n">attention_bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MMadaModelLM.forward_t2i-379"><a href="#MMadaModelLM.forward_t2i-379"><span class="linenos">379</span></a>        <span class="n">attention_bias_t2i</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2i_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">t2i_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.forward_t2i-380"><a href="#MMadaModelLM.forward_t2i-380"><span class="linenos">380</span></a>        <span class="n">attention_bias</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_bias_t2i</span>
</span><span id="MMadaModelLM.forward_t2i-381"><a href="#MMadaModelLM.forward_t2i-381"><span class="linenos">381</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.forward_t2i-382"><a href="#MMadaModelLM.forward_t2i-382"><span class="linenos">382</span></a>        <span class="c1"># logits = self(input_ids).logits</span>
</span><span id="MMadaModelLM.forward_t2i-383"><a href="#MMadaModelLM.forward_t2i-383"><span class="linenos">383</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM.forward_t2i-384"><a href="#MMadaModelLM.forward_t2i-384"><span class="linenos">384</span></a>
</span><span id="MMadaModelLM.forward_t2i-385"><a href="#MMadaModelLM.forward_t2i-385"><span class="linenos">385</span></a>        <span class="c1"># print(f&quot;logits shape: {logits.shape}&quot;) B, 359, vocab_size</span>
</span><span id="MMadaModelLM.forward_t2i-386"><a href="#MMadaModelLM.forward_t2i-386"><span class="linenos">386</span></a>
</span><span id="MMadaModelLM.forward_t2i-387"><a href="#MMadaModelLM.forward_t2i-387"><span class="linenos">387</span></a>        <span class="n">loss_t2i</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span><span id="MMadaModelLM.forward_t2i-388"><a href="#MMadaModelLM.forward_t2i-388"><span class="linenos">388</span></a>            <span class="n">logits</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_t2i-389"><a href="#MMadaModelLM.forward_t2i-389"><span class="linenos">389</span></a>            <span class="n">labels</span><span class="p">[:</span><span class="n">batch_size_t2i</span><span class="p">,</span> <span class="n">max_seq_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="MMadaModelLM.forward_t2i-390"><a href="#MMadaModelLM.forward_t2i-390"><span class="linenos">390</span></a>            <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
</span><span id="MMadaModelLM.forward_t2i-391"><a href="#MMadaModelLM.forward_t2i-391"><span class="linenos">391</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM.forward_t2i-392"><a href="#MMadaModelLM.forward_t2i-392"><span class="linenos">392</span></a>
</span><span id="MMadaModelLM.forward_t2i-393"><a href="#MMadaModelLM.forward_t2i-393"><span class="linenos">393</span></a>        <span class="k">return</span> <span class="n">loss_t2i</span>
</span></pre></div>


    

                            </div>
                            <div id="MMadaModelLM.mmu_generate" class="classattr">
                                        <input id="MMadaModelLM.mmu_generate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-torch.no_grad">@torch.no_grad()</div>

        <span class="def">def</span>
        <span class="name">mmu_generate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">idx</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">input_embeddings</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">steps</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">block_length</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">top_k</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">eot_token</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">cfg_scale</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">remasking</span><span class="o">=</span><span class="s1">&#39;low_confidence&#39;</span>,</span><span class="param">	<span class="n">mask_id</span><span class="o">=</span><span class="mi">126336</span>,</span><span class="param">	<span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MMadaModelLM.mmu_generate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM.mmu_generate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM.mmu_generate-395"><a href="#MMadaModelLM.mmu_generate-395"><span class="linenos">395</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="MMadaModelLM.mmu_generate-396"><a href="#MMadaModelLM.mmu_generate-396"><span class="linenos">396</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mmu_generate</span><span class="p">(</span>
</span><span id="MMadaModelLM.mmu_generate-397"><a href="#MMadaModelLM.mmu_generate-397"><span class="linenos">397</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-398"><a href="#MMadaModelLM.mmu_generate-398"><span class="linenos">398</span></a>        <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-399"><a href="#MMadaModelLM.mmu_generate-399"><span class="linenos">399</span></a>        <span class="n">input_embeddings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-400"><a href="#MMadaModelLM.mmu_generate-400"><span class="linenos">400</span></a>        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-401"><a href="#MMadaModelLM.mmu_generate-401"><span class="linenos">401</span></a>        <span class="n">steps</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-402"><a href="#MMadaModelLM.mmu_generate-402"><span class="linenos">402</span></a>        <span class="n">block_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-403"><a href="#MMadaModelLM.mmu_generate-403"><span class="linenos">403</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-404"><a href="#MMadaModelLM.mmu_generate-404"><span class="linenos">404</span></a>        <span class="n">top_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-405"><a href="#MMadaModelLM.mmu_generate-405"><span class="linenos">405</span></a>        <span class="n">eot_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-406"><a href="#MMadaModelLM.mmu_generate-406"><span class="linenos">406</span></a>        <span class="n">cfg_scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-407"><a href="#MMadaModelLM.mmu_generate-407"><span class="linenos">407</span></a>        <span class="n">remasking</span><span class="o">=</span><span class="s2">&quot;low_confidence&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-408"><a href="#MMadaModelLM.mmu_generate-408"><span class="linenos">408</span></a>        <span class="n">mask_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-409"><a href="#MMadaModelLM.mmu_generate-409"><span class="linenos">409</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate-410"><a href="#MMadaModelLM.mmu_generate-410"><span class="linenos">410</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM.mmu_generate-411"><a href="#MMadaModelLM.mmu_generate-411"><span class="linenos">411</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM.mmu_generate-412"><a href="#MMadaModelLM.mmu_generate-412"><span class="linenos">412</span></a><span class="sd">        Take a conditioning sequence of indices idx (LongTensor of shape (b,t)) and complete</span>
</span><span id="MMadaModelLM.mmu_generate-413"><a href="#MMadaModelLM.mmu_generate-413"><span class="linenos">413</span></a><span class="sd">        the sequence max_new_tokens times, feeding the predictions back into the model each time.</span>
</span><span id="MMadaModelLM.mmu_generate-414"><a href="#MMadaModelLM.mmu_generate-414"><span class="linenos">414</span></a><span class="sd">        Most likely you&#39;ll want to make sure to be in model.eval() mode of operation for this.</span>
</span><span id="MMadaModelLM.mmu_generate-415"><a href="#MMadaModelLM.mmu_generate-415"><span class="linenos">415</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MMadaModelLM.mmu_generate-416"><a href="#MMadaModelLM.mmu_generate-416"><span class="linenos">416</span></a>
</span><span id="MMadaModelLM.mmu_generate-417"><a href="#MMadaModelLM.mmu_generate-417"><span class="linenos">417</span></a>        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="ow">in</span> <span class="n">attention_mask</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate-418"><a href="#MMadaModelLM.mmu_generate-418"><span class="linenos">418</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-419"><a href="#MMadaModelLM.mmu_generate-419"><span class="linenos">419</span></a>            <span class="c1"># print(f&quot;attention_bias: {attention_bias}&quot;)</span>
</span><span id="MMadaModelLM.mmu_generate-420"><a href="#MMadaModelLM.mmu_generate-420"><span class="linenos">420</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate-421"><a href="#MMadaModelLM.mmu_generate-421"><span class="linenos">421</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MMadaModelLM.mmu_generate-422"><a href="#MMadaModelLM.mmu_generate-422"><span class="linenos">422</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate-423"><a href="#MMadaModelLM.mmu_generate-423"><span class="linenos">423</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">device</span>
</span><span id="MMadaModelLM.mmu_generate-424"><a href="#MMadaModelLM.mmu_generate-424"><span class="linenos">424</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate-425"><a href="#MMadaModelLM.mmu_generate-425"><span class="linenos">425</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">input_embeddings</span><span class="o">.</span><span class="n">device</span>
</span><span id="MMadaModelLM.mmu_generate-426"><a href="#MMadaModelLM.mmu_generate-426"><span class="linenos">426</span></a>
</span><span id="MMadaModelLM.mmu_generate-427"><a href="#MMadaModelLM.mmu_generate-427"><span class="linenos">427</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MMadaModelLM.mmu_generate-428"><a href="#MMadaModelLM.mmu_generate-428"><span class="linenos">428</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MMadaModelLM.mmu_generate-429"><a href="#MMadaModelLM.mmu_generate-429"><span class="linenos">429</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_new_tokens</span><span class="p">),</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-430"><a href="#MMadaModelLM.mmu_generate-430"><span class="linenos">430</span></a>        <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM.mmu_generate-431"><a href="#MMadaModelLM.mmu_generate-431"><span class="linenos">431</span></a>        <span class="n">prompt_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM.mmu_generate-432"><a href="#MMadaModelLM.mmu_generate-432"><span class="linenos">432</span></a>
</span><span id="MMadaModelLM.mmu_generate-433"><a href="#MMadaModelLM.mmu_generate-433"><span class="linenos">433</span></a>        <span class="k">assert</span> <span class="n">max_new_tokens</span> <span class="o">%</span> <span class="n">block_length</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MMadaModelLM.mmu_generate-434"><a href="#MMadaModelLM.mmu_generate-434"><span class="linenos">434</span></a>        <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">max_new_tokens</span> <span class="o">//</span> <span class="n">block_length</span>
</span><span id="MMadaModelLM.mmu_generate-435"><a href="#MMadaModelLM.mmu_generate-435"><span class="linenos">435</span></a>
</span><span id="MMadaModelLM.mmu_generate-436"><a href="#MMadaModelLM.mmu_generate-436"><span class="linenos">436</span></a>        <span class="k">assert</span> <span class="n">steps</span> <span class="o">%</span> <span class="n">num_blocks</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MMadaModelLM.mmu_generate-437"><a href="#MMadaModelLM.mmu_generate-437"><span class="linenos">437</span></a>        <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">//</span> <span class="n">num_blocks</span>
</span><span id="MMadaModelLM.mmu_generate-438"><a href="#MMadaModelLM.mmu_generate-438"><span class="linenos">438</span></a>
</span><span id="MMadaModelLM.mmu_generate-439"><a href="#MMadaModelLM.mmu_generate-439"><span class="linenos">439</span></a>        <span class="c1"># print(f&quot;num_blocks: {num_blocks}, steps: {steps}&quot;)</span>
</span><span id="MMadaModelLM.mmu_generate-440"><a href="#MMadaModelLM.mmu_generate-440"><span class="linenos">440</span></a>        <span class="c1"># num_transfer_tokens = get_num_transfer_tokens(prompt_index, steps)</span>
</span><span id="MMadaModelLM.mmu_generate-441"><a href="#MMadaModelLM.mmu_generate-441"><span class="linenos">441</span></a>        <span class="k">for</span> <span class="n">num_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="MMadaModelLM.mmu_generate-442"><a href="#MMadaModelLM.mmu_generate-442"><span class="linenos">442</span></a>            <span class="n">block_mask_index</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_block</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM.mmu_generate-443"><a href="#MMadaModelLM.mmu_generate-443"><span class="linenos">443</span></a>            <span class="n">num_transfer_tokens</span> <span class="o">=</span> <span class="n">get_num_transfer_tokens</span><span class="p">(</span><span class="n">block_mask_index</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-444"><a href="#MMadaModelLM.mmu_generate-444"><span class="linenos">444</span></a>            <span class="c1"># num_transfer_tokens = get_num_transfer_tokens(prompt_index, steps)</span>
</span><span id="MMadaModelLM.mmu_generate-445"><a href="#MMadaModelLM.mmu_generate-445"><span class="linenos">445</span></a>            <span class="c1"># print(f&quot;num_transfer_tokens: {num_transfer_tokens}, num_transfer_tokens.shape: {num_transfer_tokens.shape}&quot;)</span>
</span><span id="MMadaModelLM.mmu_generate-446"><a href="#MMadaModelLM.mmu_generate-446"><span class="linenos">446</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
</span><span id="MMadaModelLM.mmu_generate-447"><a href="#MMadaModelLM.mmu_generate-447"><span class="linenos">447</span></a>                <span class="n">mask_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM.mmu_generate-448"><a href="#MMadaModelLM.mmu_generate-448"><span class="linenos">448</span></a>                <span class="k">if</span> <span class="n">cfg_scale</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate-449"><a href="#MMadaModelLM.mmu_generate-449"><span class="linenos">449</span></a>                    <span class="n">un_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM.mmu_generate-450"><a href="#MMadaModelLM.mmu_generate-450"><span class="linenos">450</span></a>                    <span class="n">un_x</span><span class="p">[</span><span class="n">prompt_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM.mmu_generate-451"><a href="#MMadaModelLM.mmu_generate-451"><span class="linenos">451</span></a>                    <span class="n">x_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">un_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-452"><a href="#MMadaModelLM.mmu_generate-452"><span class="linenos">452</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.mmu_generate-453"><a href="#MMadaModelLM.mmu_generate-453"><span class="linenos">453</span></a>                    <span class="n">logits</span><span class="p">,</span> <span class="n">un_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-454"><a href="#MMadaModelLM.mmu_generate-454"><span class="linenos">454</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="n">un_logits</span> <span class="o">+</span> <span class="p">(</span><span class="n">cfg_scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="n">un_logits</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-455"><a href="#MMadaModelLM.mmu_generate-455"><span class="linenos">455</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate-456"><a href="#MMadaModelLM.mmu_generate-456"><span class="linenos">456</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.mmu_generate-457"><a href="#MMadaModelLM.mmu_generate-457"><span class="linenos">457</span></a>
</span><span id="MMadaModelLM.mmu_generate-458"><a href="#MMadaModelLM.mmu_generate-458"><span class="linenos">458</span></a>                <span class="n">logits_with_noise</span> <span class="o">=</span> <span class="n">add_gumbel_noise</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-459"><a href="#MMadaModelLM.mmu_generate-459"><span class="linenos">459</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits_with_noise</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="MMadaModelLM.mmu_generate-460"><a href="#MMadaModelLM.mmu_generate-460"><span class="linenos">460</span></a>                <span class="k">if</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;low_confidence&quot;</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate-461"><a href="#MMadaModelLM.mmu_generate-461"><span class="linenos">461</span></a>                    <span class="n">p</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device_dtype</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-462"><a href="#MMadaModelLM.mmu_generate-462"><span class="linenos">462</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="MMadaModelLM.mmu_generate-463"><a href="#MMadaModelLM.mmu_generate-463"><span class="linenos">463</span></a>                <span class="k">elif</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate-464"><a href="#MMadaModelLM.mmu_generate-464"><span class="linenos">464</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-465"><a href="#MMadaModelLM.mmu_generate-465"><span class="linenos">465</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate-466"><a href="#MMadaModelLM.mmu_generate-466"><span class="linenos">466</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">remasking</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-467"><a href="#MMadaModelLM.mmu_generate-467"><span class="linenos">467</span></a>
</span><span id="MMadaModelLM.mmu_generate-468"><a href="#MMadaModelLM.mmu_generate-468"><span class="linenos">468</span></a>                <span class="n">x0_p</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="MMadaModelLM.mmu_generate-469"><a href="#MMadaModelLM.mmu_generate-469"><span class="linenos">469</span></a>
</span><span id="MMadaModelLM.mmu_generate-470"><a href="#MMadaModelLM.mmu_generate-470"><span class="linenos">470</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-471"><a href="#MMadaModelLM.mmu_generate-471"><span class="linenos">471</span></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0_p</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-472"><a href="#MMadaModelLM.mmu_generate-472"><span class="linenos">472</span></a>
</span><span id="MMadaModelLM.mmu_generate-473"><a href="#MMadaModelLM.mmu_generate-473"><span class="linenos">473</span></a>                <span class="n">transfer_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate-474"><a href="#MMadaModelLM.mmu_generate-474"><span class="linenos">474</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">confidence</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="MMadaModelLM.mmu_generate-475"><a href="#MMadaModelLM.mmu_generate-475"><span class="linenos">475</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">select_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">confidence</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">num_transfer_tokens</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="MMadaModelLM.mmu_generate-476"><a href="#MMadaModelLM.mmu_generate-476"><span class="linenos">476</span></a>                    <span class="n">transfer_index</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">select_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MMadaModelLM.mmu_generate-477"><a href="#MMadaModelLM.mmu_generate-477"><span class="linenos">477</span></a>                <span class="n">x</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span>
</span><span id="MMadaModelLM.mmu_generate-478"><a href="#MMadaModelLM.mmu_generate-478"><span class="linenos">478</span></a>
</span><span id="MMadaModelLM.mmu_generate-479"><a href="#MMadaModelLM.mmu_generate-479"><span class="linenos">479</span></a>            <span class="c1"># logits = logits[:, -1, :] / temperature</span>
</span><span id="MMadaModelLM.mmu_generate-480"><a href="#MMadaModelLM.mmu_generate-480"><span class="linenos">480</span></a>            <span class="c1"># # optionally crop the logits to only the top k options</span>
</span><span id="MMadaModelLM.mmu_generate-481"><a href="#MMadaModelLM.mmu_generate-481"><span class="linenos">481</span></a>            <span class="c1"># if top_k is not None:</span>
</span><span id="MMadaModelLM.mmu_generate-482"><a href="#MMadaModelLM.mmu_generate-482"><span class="linenos">482</span></a>            <span class="c1">#     v, _ = torch.topk(logits, min(top_k, logits.size(-1)))</span>
</span><span id="MMadaModelLM.mmu_generate-483"><a href="#MMadaModelLM.mmu_generate-483"><span class="linenos">483</span></a>            <span class="c1">#     logits[logits &lt; v[:, [-1]]] = -float(&#39;Inf&#39;)</span>
</span><span id="MMadaModelLM.mmu_generate-484"><a href="#MMadaModelLM.mmu_generate-484"><span class="linenos">484</span></a>            <span class="c1"># # apply softmax to convert logits to (normalized) probabilities</span>
</span><span id="MMadaModelLM.mmu_generate-485"><a href="#MMadaModelLM.mmu_generate-485"><span class="linenos">485</span></a>            <span class="c1"># probs = F.softmax(logits, dim=-1)</span>
</span><span id="MMadaModelLM.mmu_generate-486"><a href="#MMadaModelLM.mmu_generate-486"><span class="linenos">486</span></a>            <span class="c1"># # sample from the distribution</span>
</span><span id="MMadaModelLM.mmu_generate-487"><a href="#MMadaModelLM.mmu_generate-487"><span class="linenos">487</span></a>            <span class="c1"># idx_next = torch.multinomial(probs, num_samples=1)</span>
</span><span id="MMadaModelLM.mmu_generate-488"><a href="#MMadaModelLM.mmu_generate-488"><span class="linenos">488</span></a>            <span class="c1"># result.append(idx_next[0][0])</span>
</span><span id="MMadaModelLM.mmu_generate-489"><a href="#MMadaModelLM.mmu_generate-489"><span class="linenos">489</span></a>            <span class="c1"># # append sampled index to the running sequence and continue</span>
</span><span id="MMadaModelLM.mmu_generate-490"><a href="#MMadaModelLM.mmu_generate-490"><span class="linenos">490</span></a>            <span class="c1"># if self.config.w_clip_vit:</span>
</span><span id="MMadaModelLM.mmu_generate-491"><a href="#MMadaModelLM.mmu_generate-491"><span class="linenos">491</span></a>            <span class="c1">#     idx_next_embeddings = self.mmada.model.embed_tokens(idx_next)</span>
</span><span id="MMadaModelLM.mmu_generate-492"><a href="#MMadaModelLM.mmu_generate-492"><span class="linenos">492</span></a>            <span class="c1">#     input_embeddings = torch.cat([input_embeddings, idx_next_embeddings], dim=1)</span>
</span><span id="MMadaModelLM.mmu_generate-493"><a href="#MMadaModelLM.mmu_generate-493"><span class="linenos">493</span></a>            <span class="c1"># else:</span>
</span><span id="MMadaModelLM.mmu_generate-494"><a href="#MMadaModelLM.mmu_generate-494"><span class="linenos">494</span></a>            <span class="c1">#     idx = torch.cat((idx, idx_next), dim=1)</span>
</span><span id="MMadaModelLM.mmu_generate-495"><a href="#MMadaModelLM.mmu_generate-495"><span class="linenos">495</span></a>
</span><span id="MMadaModelLM.mmu_generate-496"><a href="#MMadaModelLM.mmu_generate-496"><span class="linenos">496</span></a>            <span class="c1"># if eot_token is not None and idx_next.cpu() == eot_token:</span>
</span><span id="MMadaModelLM.mmu_generate-497"><a href="#MMadaModelLM.mmu_generate-497"><span class="linenos">497</span></a>            <span class="c1">#     break</span>
</span><span id="MMadaModelLM.mmu_generate-498"><a href="#MMadaModelLM.mmu_generate-498"><span class="linenos">498</span></a>
</span><span id="MMadaModelLM.mmu_generate-499"><a href="#MMadaModelLM.mmu_generate-499"><span class="linenos">499</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>Take a conditioning sequence of indices idx (LongTensor of shape (b,t)) and complete
the sequence max_new_tokens times, feeding the predictions back into the model each time.
Most likely you'll want to make sure to be in model.eval() mode of operation for this.</p>
</div>


                            </div>
                            <div id="MMadaModelLM.mmu_generate_fast" class="classattr">
                                        <input id="MMadaModelLM.mmu_generate_fast-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-torch.no_grad">@torch.no_grad()</div>

        <span class="def">def</span>
        <span class="name">mmu_generate_fast</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">idx</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">input_embeddings</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">steps</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">block_length</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">top_k</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">eot_token</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">cfg_scale</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">remasking</span><span class="o">=</span><span class="s1">&#39;low_confidence&#39;</span>,</span><span class="param">	<span class="n">mask_id</span><span class="o">=</span><span class="mi">126336</span>,</span><span class="param">	<span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MMadaModelLM.mmu_generate_fast-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM.mmu_generate_fast"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM.mmu_generate_fast-501"><a href="#MMadaModelLM.mmu_generate_fast-501"><span class="linenos">501</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="MMadaModelLM.mmu_generate_fast-502"><a href="#MMadaModelLM.mmu_generate_fast-502"><span class="linenos">502</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mmu_generate_fast</span><span class="p">(</span>
</span><span id="MMadaModelLM.mmu_generate_fast-503"><a href="#MMadaModelLM.mmu_generate_fast-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-504"><a href="#MMadaModelLM.mmu_generate_fast-504"><span class="linenos">504</span></a>        <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-505"><a href="#MMadaModelLM.mmu_generate_fast-505"><span class="linenos">505</span></a>        <span class="n">input_embeddings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-506"><a href="#MMadaModelLM.mmu_generate_fast-506"><span class="linenos">506</span></a>        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-507"><a href="#MMadaModelLM.mmu_generate_fast-507"><span class="linenos">507</span></a>        <span class="n">steps</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-508"><a href="#MMadaModelLM.mmu_generate_fast-508"><span class="linenos">508</span></a>        <span class="n">block_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-509"><a href="#MMadaModelLM.mmu_generate_fast-509"><span class="linenos">509</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-510"><a href="#MMadaModelLM.mmu_generate_fast-510"><span class="linenos">510</span></a>        <span class="n">top_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-511"><a href="#MMadaModelLM.mmu_generate_fast-511"><span class="linenos">511</span></a>        <span class="n">eot_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-512"><a href="#MMadaModelLM.mmu_generate_fast-512"><span class="linenos">512</span></a>        <span class="n">cfg_scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-513"><a href="#MMadaModelLM.mmu_generate_fast-513"><span class="linenos">513</span></a>        <span class="n">remasking</span><span class="o">=</span><span class="s2">&quot;low_confidence&quot;</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-514"><a href="#MMadaModelLM.mmu_generate_fast-514"><span class="linenos">514</span></a>        <span class="n">mask_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-515"><a href="#MMadaModelLM.mmu_generate_fast-515"><span class="linenos">515</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.mmu_generate_fast-516"><a href="#MMadaModelLM.mmu_generate_fast-516"><span class="linenos">516</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM.mmu_generate_fast-517"><a href="#MMadaModelLM.mmu_generate_fast-517"><span class="linenos">517</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM.mmu_generate_fast-518"><a href="#MMadaModelLM.mmu_generate_fast-518"><span class="linenos">518</span></a><span class="sd">        Take a conditioning sequence of indices idx (LongTensor of shape (b,t)) and complete</span>
</span><span id="MMadaModelLM.mmu_generate_fast-519"><a href="#MMadaModelLM.mmu_generate_fast-519"><span class="linenos">519</span></a><span class="sd">        the sequence max_new_tokens times, feeding the predictions back into the model each time.</span>
</span><span id="MMadaModelLM.mmu_generate_fast-520"><a href="#MMadaModelLM.mmu_generate_fast-520"><span class="linenos">520</span></a><span class="sd">        Most likely you&#39;ll want to make sure to be in model.eval() mode of operation for this.</span>
</span><span id="MMadaModelLM.mmu_generate_fast-521"><a href="#MMadaModelLM.mmu_generate_fast-521"><span class="linenos">521</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MMadaModelLM.mmu_generate_fast-522"><a href="#MMadaModelLM.mmu_generate_fast-522"><span class="linenos">522</span></a>
</span><span id="MMadaModelLM.mmu_generate_fast-523"><a href="#MMadaModelLM.mmu_generate_fast-523"><span class="linenos">523</span></a>        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="ow">in</span> <span class="n">attention_mask</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-524"><a href="#MMadaModelLM.mmu_generate_fast-524"><span class="linenos">524</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-525"><a href="#MMadaModelLM.mmu_generate_fast-525"><span class="linenos">525</span></a>            <span class="c1"># print(f&quot;attention_bias: {attention_bias}&quot;)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-526"><a href="#MMadaModelLM.mmu_generate_fast-526"><span class="linenos">526</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-527"><a href="#MMadaModelLM.mmu_generate_fast-527"><span class="linenos">527</span></a>            <span class="n">attention_bias</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MMadaModelLM.mmu_generate_fast-528"><a href="#MMadaModelLM.mmu_generate_fast-528"><span class="linenos">528</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-529"><a href="#MMadaModelLM.mmu_generate_fast-529"><span class="linenos">529</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">device</span>
</span><span id="MMadaModelLM.mmu_generate_fast-530"><a href="#MMadaModelLM.mmu_generate_fast-530"><span class="linenos">530</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-531"><a href="#MMadaModelLM.mmu_generate_fast-531"><span class="linenos">531</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">input_embeddings</span><span class="o">.</span><span class="n">device</span>
</span><span id="MMadaModelLM.mmu_generate_fast-532"><a href="#MMadaModelLM.mmu_generate_fast-532"><span class="linenos">532</span></a>
</span><span id="MMadaModelLM.mmu_generate_fast-533"><a href="#MMadaModelLM.mmu_generate_fast-533"><span class="linenos">533</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="MMadaModelLM.mmu_generate_fast-534"><a href="#MMadaModelLM.mmu_generate_fast-534"><span class="linenos">534</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MMadaModelLM.mmu_generate_fast-535"><a href="#MMadaModelLM.mmu_generate_fast-535"><span class="linenos">535</span></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_new_tokens</span><span class="p">),</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-536"><a href="#MMadaModelLM.mmu_generate_fast-536"><span class="linenos">536</span></a>        <span class="n">x</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM.mmu_generate_fast-537"><a href="#MMadaModelLM.mmu_generate_fast-537"><span class="linenos">537</span></a>        <span class="n">prompt_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM.mmu_generate_fast-538"><a href="#MMadaModelLM.mmu_generate_fast-538"><span class="linenos">538</span></a>
</span><span id="MMadaModelLM.mmu_generate_fast-539"><a href="#MMadaModelLM.mmu_generate_fast-539"><span class="linenos">539</span></a>        <span class="k">assert</span> <span class="n">max_new_tokens</span> <span class="o">%</span> <span class="n">block_length</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MMadaModelLM.mmu_generate_fast-540"><a href="#MMadaModelLM.mmu_generate_fast-540"><span class="linenos">540</span></a>        <span class="n">num_blocks</span> <span class="o">=</span> <span class="n">max_new_tokens</span> <span class="o">//</span> <span class="n">block_length</span>
</span><span id="MMadaModelLM.mmu_generate_fast-541"><a href="#MMadaModelLM.mmu_generate_fast-541"><span class="linenos">541</span></a>
</span><span id="MMadaModelLM.mmu_generate_fast-542"><a href="#MMadaModelLM.mmu_generate_fast-542"><span class="linenos">542</span></a>        <span class="k">assert</span> <span class="n">steps</span> <span class="o">%</span> <span class="n">num_blocks</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MMadaModelLM.mmu_generate_fast-543"><a href="#MMadaModelLM.mmu_generate_fast-543"><span class="linenos">543</span></a>        <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">//</span> <span class="n">num_blocks</span>
</span><span id="MMadaModelLM.mmu_generate_fast-544"><a href="#MMadaModelLM.mmu_generate_fast-544"><span class="linenos">544</span></a>
</span><span id="MMadaModelLM.mmu_generate_fast-545"><a href="#MMadaModelLM.mmu_generate_fast-545"><span class="linenos">545</span></a>        <span class="k">for</span> <span class="n">num_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
</span><span id="MMadaModelLM.mmu_generate_fast-546"><a href="#MMadaModelLM.mmu_generate_fast-546"><span class="linenos">546</span></a>            <span class="n">block_mask_index</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_block</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM.mmu_generate_fast-547"><a href="#MMadaModelLM.mmu_generate_fast-547"><span class="linenos">547</span></a>            <span class="n">num_transfer_tokens</span> <span class="o">=</span> <span class="n">get_num_transfer_tokens</span><span class="p">(</span><span class="n">block_mask_index</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-548"><a href="#MMadaModelLM.mmu_generate_fast-548"><span class="linenos">548</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
</span><span id="MMadaModelLM.mmu_generate_fast-549"><a href="#MMadaModelLM.mmu_generate_fast-549"><span class="linenos">549</span></a>                <span class="n">mask_index</span> <span class="o">=</span> <span class="n">x</span> <span class="o">==</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM.mmu_generate_fast-550"><a href="#MMadaModelLM.mmu_generate_fast-550"><span class="linenos">550</span></a>                <span class="k">if</span> <span class="n">cfg_scale</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-551"><a href="#MMadaModelLM.mmu_generate_fast-551"><span class="linenos">551</span></a>                    <span class="n">un_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM.mmu_generate_fast-552"><a href="#MMadaModelLM.mmu_generate_fast-552"><span class="linenos">552</span></a>                    <span class="n">un_x</span><span class="p">[</span><span class="n">prompt_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_id</span>
</span><span id="MMadaModelLM.mmu_generate_fast-553"><a href="#MMadaModelLM.mmu_generate_fast-553"><span class="linenos">553</span></a>                    <span class="n">x_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">un_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-554"><a href="#MMadaModelLM.mmu_generate_fast-554"><span class="linenos">554</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.mmu_generate_fast-555"><a href="#MMadaModelLM.mmu_generate_fast-555"><span class="linenos">555</span></a>                    <span class="n">logits</span><span class="p">,</span> <span class="n">un_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-556"><a href="#MMadaModelLM.mmu_generate_fast-556"><span class="linenos">556</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="n">un_logits</span> <span class="o">+</span> <span class="p">(</span><span class="n">cfg_scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="n">un_logits</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-557"><a href="#MMadaModelLM.mmu_generate_fast-557"><span class="linenos">557</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-558"><a href="#MMadaModelLM.mmu_generate_fast-558"><span class="linenos">558</span></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.mmu_generate_fast-559"><a href="#MMadaModelLM.mmu_generate_fast-559"><span class="linenos">559</span></a>
</span><span id="MMadaModelLM.mmu_generate_fast-560"><a href="#MMadaModelLM.mmu_generate_fast-560"><span class="linenos">560</span></a>                <span class="n">logits_with_noise</span> <span class="o">=</span> <span class="n">add_gumbel_noise</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-561"><a href="#MMadaModelLM.mmu_generate_fast-561"><span class="linenos">561</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits_with_noise</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="MMadaModelLM.mmu_generate_fast-562"><a href="#MMadaModelLM.mmu_generate_fast-562"><span class="linenos">562</span></a>                <span class="k">if</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;low_confidence&quot;</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-563"><a href="#MMadaModelLM.mmu_generate_fast-563"><span class="linenos">563</span></a>                    <span class="n">p</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device_dtype</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-564"><a href="#MMadaModelLM.mmu_generate_fast-564"><span class="linenos">564</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># b, l</span>
</span><span id="MMadaModelLM.mmu_generate_fast-565"><a href="#MMadaModelLM.mmu_generate_fast-565"><span class="linenos">565</span></a>                <span class="k">elif</span> <span class="n">remasking</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-566"><a href="#MMadaModelLM.mmu_generate_fast-566"><span class="linenos">566</span></a>                    <span class="n">x0_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-567"><a href="#MMadaModelLM.mmu_generate_fast-567"><span class="linenos">567</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-568"><a href="#MMadaModelLM.mmu_generate_fast-568"><span class="linenos">568</span></a>                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">remasking</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-569"><a href="#MMadaModelLM.mmu_generate_fast-569"><span class="linenos">569</span></a>
</span><span id="MMadaModelLM.mmu_generate_fast-570"><a href="#MMadaModelLM.mmu_generate_fast-570"><span class="linenos">570</span></a>                <span class="n">x0_p</span><span class="p">[:,</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="MMadaModelLM.mmu_generate_fast-571"><a href="#MMadaModelLM.mmu_generate_fast-571"><span class="linenos">571</span></a>
</span><span id="MMadaModelLM.mmu_generate_fast-572"><a href="#MMadaModelLM.mmu_generate_fast-572"><span class="linenos">572</span></a>                <span class="n">x0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-573"><a href="#MMadaModelLM.mmu_generate_fast-573"><span class="linenos">573</span></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_index</span><span class="p">,</span> <span class="n">x0_p</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-574"><a href="#MMadaModelLM.mmu_generate_fast-574"><span class="linenos">574</span></a>
</span><span id="MMadaModelLM.mmu_generate_fast-575"><a href="#MMadaModelLM.mmu_generate_fast-575"><span class="linenos">575</span></a>                <span class="n">transfer_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x0</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.mmu_generate_fast-576"><a href="#MMadaModelLM.mmu_generate_fast-576"><span class="linenos">576</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">confidence</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="MMadaModelLM.mmu_generate_fast-577"><a href="#MMadaModelLM.mmu_generate_fast-577"><span class="linenos">577</span></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">select_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">confidence</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">num_transfer_tokens</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="MMadaModelLM.mmu_generate_fast-578"><a href="#MMadaModelLM.mmu_generate_fast-578"><span class="linenos">578</span></a>                    <span class="n">transfer_index</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">select_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MMadaModelLM.mmu_generate_fast-579"><a href="#MMadaModelLM.mmu_generate_fast-579"><span class="linenos">579</span></a>                <span class="n">x</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">transfer_index</span><span class="p">]</span>
</span><span id="MMadaModelLM.mmu_generate_fast-580"><a href="#MMadaModelLM.mmu_generate_fast-580"><span class="linenos">580</span></a>            <span class="k">if</span> <span class="n">eot_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-581"><a href="#MMadaModelLM.mmu_generate_fast-581"><span class="linenos">581</span></a>                <span class="n">last_token_index_in_current_block</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_block</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_length</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="MMadaModelLM.mmu_generate_fast-582"><a href="#MMadaModelLM.mmu_generate_fast-582"><span class="linenos">582</span></a>                <span class="k">if</span> <span class="n">last_token_index_in_current_block</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="MMadaModelLM.mmu_generate_fast-583"><a href="#MMadaModelLM.mmu_generate_fast-583"><span class="linenos">583</span></a>                    <span class="n">tokens_at_block_end</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">last_token_index_in_current_block</span><span class="p">]</span>
</span><span id="MMadaModelLM.mmu_generate_fast-584"><a href="#MMadaModelLM.mmu_generate_fast-584"><span class="linenos">584</span></a>                    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">tokens_at_block_end</span> <span class="o">==</span> <span class="n">eot_token</span><span class="p">):</span>
</span><span id="MMadaModelLM.mmu_generate_fast-585"><a href="#MMadaModelLM.mmu_generate_fast-585"><span class="linenos">585</span></a>                        <span class="k">break</span>
</span><span id="MMadaModelLM.mmu_generate_fast-586"><a href="#MMadaModelLM.mmu_generate_fast-586"><span class="linenos">586</span></a>        <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>Take a conditioning sequence of indices idx (LongTensor of shape (b,t)) and complete
the sequence max_new_tokens times, feeding the predictions back into the model each time.
Most likely you'll want to make sure to be in model.eval() mode of operation for this.</p>
</div>


                            </div>
                            <div id="MMadaModelLM.t2i_generate_decoding_stepwise" class="classattr">
                                        <input id="MMadaModelLM.t2i_generate_decoding_stepwise-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-torch.no_grad">@torch.no_grad()</div>

        <span class="def">def</span>
        <span class="name">t2i_generate_decoding_stepwise</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">uncond_input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">uncond_attention_mask</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">timesteps</span><span class="o">=</span><span class="mi">18</span>,</span><span class="param">	<span class="n">guidance_scale</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">noise_schedule</span><span class="o">=&lt;</span><span class="n">function</span> <span class="n">cosine_schedule</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">generator</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">config</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">seq_len</span><span class="o">=</span><span class="mi">1024</span>,</span><span class="param">	<span class="n">mask_token_id</span><span class="o">=</span><span class="mi">126336</span>,</span><span class="param">	<span class="n">resolution</span><span class="o">=</span><span class="mi">512</span>,</span><span class="param">	<span class="n">codebook_size</span><span class="o">=</span><span class="mi">8192</span>,</span><span class="param">	<span class="n">vq_model</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MMadaModelLM.t2i_generate_decoding_stepwise-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MMadaModelLM.t2i_generate_decoding_stepwise"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-588"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-588"><span class="linenos">588</span></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-589"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-589"><span class="linenos">589</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">t2i_generate_decoding_stepwise</span><span class="p">(</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-590"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-590"><span class="linenos">590</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-591"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-591"><span class="linenos">591</span></a>        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-592"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-592"><span class="linenos">592</span></a>        <span class="n">uncond_input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-593"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-593"><span class="linenos">593</span></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-594"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-594"><span class="linenos">594</span></a>        <span class="n">uncond_attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-595"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-595"><span class="linenos">595</span></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-596"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-596"><span class="linenos">596</span></a>        <span class="n">timesteps</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>  <span class="c1"># ideal number of steps is 18 in maskgit paper</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-597"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-597"><span class="linenos">597</span></a>        <span class="n">guidance_scale</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-598"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-598"><span class="linenos">598</span></a>        <span class="n">noise_schedule</span><span class="o">=</span><span class="n">cosine_schedule</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-599"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-599"><span class="linenos">599</span></a>        <span class="n">generator</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-600"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-600"><span class="linenos">600</span></a>        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-601"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-601"><span class="linenos">601</span></a>        <span class="n">seq_len</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-602"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-602"><span class="linenos">602</span></a>        <span class="n">mask_token_id</span><span class="o">=</span><span class="mi">126336</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-603"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-603"><span class="linenos">603</span></a>        <span class="n">resolution</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-604"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-604"><span class="linenos">604</span></a>        <span class="n">codebook_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-605"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-605"><span class="linenos">605</span></a>        <span class="n">vq_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-606"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-606"><span class="linenos">606</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-607"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-607"><span class="linenos">607</span></a>    <span class="p">):</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-608"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-608"><span class="linenos">608</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-609"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-609"><span class="linenos">609</span></a><span class="sd">        Generate 1:1 similar to the original MaskGit repo</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-610"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-610"><span class="linenos">610</span></a><span class="sd">        https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-611"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-611"><span class="linenos">611</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-612"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-612"><span class="linenos">612</span></a>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-613"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-613"><span class="linenos">613</span></a>        <span class="c1"># begin with all image token ids masked</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-614"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-614"><span class="linenos">614</span></a>        <span class="c1"># mask token</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-615"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-615"><span class="linenos">615</span></a>        <span class="n">mask_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_ids</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-616"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-616"><span class="linenos">616</span></a>        <span class="n">num_vq_tokens</span> <span class="o">=</span> <span class="n">seq_len</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-617"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-617"><span class="linenos">617</span></a>        <span class="n">num_new_special_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-618"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-618"><span class="linenos">618</span></a>        <span class="n">uni_prompting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uni_prompting&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-619"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-619"><span class="linenos">619</span></a>        <span class="c1"># print(f&quot;config.model.mmada.llm_vocab_size: {config.model.mmada.llm_vocab_size}, {len(uni_prompting.text_tokenizer)}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-620"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-620"><span class="linenos">620</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-621"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-621"><span class="linenos">621</span></a>        <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-622"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-622"><span class="linenos">622</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_new_special_tokens</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-623"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-623"><span class="linenos">623</span></a>        <span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-624"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-624"><span class="linenos">624</span></a>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-625"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-625"><span class="linenos">625</span></a>        <span class="c1"># for classifier-free guidance</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-626"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-626"><span class="linenos">626</span></a>        <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-627"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-627"><span class="linenos">627</span></a>            <span class="n">uncond_prefix</span> <span class="o">=</span> <span class="n">uncond_input_ids</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-628"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-628"><span class="linenos">628</span></a>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-629"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-629"><span class="linenos">629</span></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timesteps</span><span class="p">):</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-630"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-630"><span class="linenos">630</span></a>            <span class="k">if</span> <span class="n">uncond_input_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">guidance_scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-631"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-631"><span class="linenos">631</span></a>                <span class="n">uncond_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">uncond_prefix</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="n">resolution</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-632"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-632"><span class="linenos">632</span></a>                <span class="n">model_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">uncond_input_ids</span><span class="p">])</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-633"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-633"><span class="linenos">633</span></a>                <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">uncond_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-634"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-634"><span class="linenos">634</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-635"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-635"><span class="linenos">635</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-636"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-636"><span class="linenos">636</span></a>                <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-637"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-637"><span class="linenos">637</span></a>                <span class="n">cond_logits</span><span class="p">,</span> <span class="n">uncond_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-638"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-638"><span class="linenos">638</span></a>                <span class="c1"># logits = uncond_logits + guidance_scale * (cond_logits - uncond_logits)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-639"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-639"><span class="linenos">639</span></a>                <span class="c1"># it seems that muse has a different cfg setting</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-640"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-640"><span class="linenos">640</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">guidance_scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond_logits</span> <span class="o">-</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="n">uncond_logits</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-641"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-641"><span class="linenos">641</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-642"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-642"><span class="linenos">642</span></a>                    <span class="p">:,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-643"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-643"><span class="linenos">643</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-644"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-644"><span class="linenos">644</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-645"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-645"><span class="linenos">645</span></a>                <span class="p">]</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-646"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-646"><span class="linenos">646</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-647"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-647"><span class="linenos">647</span></a>                <span class="n">attention_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">attention_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">attention_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-648"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-648"><span class="linenos">648</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_bias</span><span class="o">=</span><span class="n">attention_bias</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-649"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-649"><span class="linenos">649</span></a>                <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-650"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-650"><span class="linenos">650</span></a>                    <span class="p">:,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-651"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-651"><span class="linenos">651</span></a>                    <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-652"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-652"><span class="linenos">652</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span> <span class="o">+</span> <span class="n">codebook_size</span><span class="p">,</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-653"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-653"><span class="linenos">653</span></a>                <span class="p">]</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-654"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-654"><span class="linenos">654</span></a>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-655"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-655"><span class="linenos">655</span></a>            <span class="c1"># logits: 1, 1024, 8192</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-656"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-656"><span class="linenos">656</span></a>            <span class="c1"># print(f&quot;logits.shape: {logits.shape}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-657"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-657"><span class="linenos">657</span></a>            <span class="n">probs</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-658"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-658"><span class="linenos">658</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-659"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-659"><span class="linenos">659</span></a>            <span class="c1"># print(f&quot;probs: {probs}, probs.shape: {probs.shape}, sampled: {sampled}, sampled.shape: {sampled.shape}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-660"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-660"><span class="linenos">660</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">sampled</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 1, 1024</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-661"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-661"><span class="linenos">661</span></a>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-662"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-662"><span class="linenos">662</span></a>            <span class="n">unknown_map</span> <span class="o">=</span> <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">==</span> <span class="n">mask_token_id</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-663"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-663"><span class="linenos">663</span></a>            <span class="c1"># print(f&quot;unknown_map.sum(dim=-1, keepdim=True): {unknown_map.sum(dim=-1, keepdim=True)}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-664"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-664"><span class="linenos">664</span></a>            <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">,</span> <span class="n">input_ids_minus_lm_vocab_size</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-665"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-665"><span class="linenos">665</span></a>            <span class="c1"># Defines the mask ratio for the next round. The number to mask out is</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-666"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-666"><span class="linenos">666</span></a>            <span class="n">current_image_vq_indices</span> <span class="o">=</span> <span class="n">sampled_ids</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-667"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-667"><span class="linenos">667</span></a>            <span class="c1"># print(f&quot;current_image_vq_indices: {current_image_vq_indices}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-668"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-668"><span class="linenos">668</span></a>            <span class="n">current_image_vq_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">current_image_vq_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8192</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-669"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-669"><span class="linenos">669</span></a>            <span class="n">current_image</span> <span class="o">=</span> <span class="n">vq_model</span><span class="o">.</span><span class="n">decode_code</span><span class="p">(</span><span class="n">current_image_vq_indices</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-670"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-670"><span class="linenos">670</span></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">current_image</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-671"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-671"><span class="linenos">671</span></a>            <span class="n">images</span> <span class="o">*=</span> <span class="mf">255.0</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-672"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-672"><span class="linenos">672</span></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-673"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-673"><span class="linenos">673</span></a>            <span class="n">pil_images</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-674"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-674"><span class="linenos">674</span></a>            <span class="k">yield</span> <span class="n">pil_images</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">timesteps</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-675"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-675"><span class="linenos">675</span></a>            <span class="c1"># determined by mask_ratio * unknown_number_in_the_beginning.</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-676"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-676"><span class="linenos">676</span></a>            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">timesteps</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-677"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-677"><span class="linenos">677</span></a>            <span class="n">mask_ratio</span> <span class="o">=</span> <span class="n">noise_schedule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-678"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-678"><span class="linenos">678</span></a>            <span class="c1"># Computes the probabilities of each selected tokens.</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-679"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-679"><span class="linenos">679</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="o">.</span><span class="n">long</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-680"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-680"><span class="linenos">680</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">selected_probs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-681"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-681"><span class="linenos">681</span></a>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-682"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-682"><span class="linenos">682</span></a>            <span class="c1"># Ignores the tokens given in the input by overwriting their confidence.</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-683"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-683"><span class="linenos">683</span></a>            <span class="n">selected_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unknown_map</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">selected_probs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-684"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-684"><span class="linenos">684</span></a>            <span class="c1"># Gets mask lens for each sample in the batch according to the mask ratio.</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-685"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-685"><span class="linenos">685</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">*</span> <span class="n">mask_ratio</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-686"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-686"><span class="linenos">686</span></a>            <span class="c1"># Keeps at least one of prediction in this round and also masks out at least</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-687"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-687"><span class="linenos">687</span></a>            <span class="c1"># one and for the next iteration</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-688"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-688"><span class="linenos">688</span></a>            <span class="n">mask_len</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">unknown_map</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">))</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-689"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-689"><span class="linenos">689</span></a>            <span class="c1"># print(f&quot;mask_len: {mask_len}, mask_len.shape: {mask_len.shape}&quot;)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-690"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-690"><span class="linenos">690</span></a>            <span class="c1"># Adds noise for randomness</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-691"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-691"><span class="linenos">691</span></a>            <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-692"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-692"><span class="linenos">692</span></a>            <span class="n">masking</span> <span class="o">=</span> <span class="n">mask_by_random_topk</span><span class="p">(</span><span class="n">mask_len</span><span class="p">,</span> <span class="n">selected_probs</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-693"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-693"><span class="linenos">693</span></a>            <span class="c1"># Masks tokens with lower confidence.</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-694"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-694"><span class="linenos">694</span></a>            <span class="n">input_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="p">(</span><span class="n">num_vq_tokens</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">uni_prompting</span><span class="o">.</span><span class="n">text_tokenizer</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_new_special_tokens</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-695"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-695"><span class="linenos">695</span></a>            <span class="n">input_ids_minus_lm_vocab_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masking</span><span class="p">,</span> <span class="n">mask_token_id</span><span class="p">,</span> <span class="n">sampled_ids</span><span class="p">)</span>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-696"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-696"><span class="linenos">696</span></a>
</span><span id="MMadaModelLM.t2i_generate_decoding_stepwise-697"><a href="#MMadaModelLM.t2i_generate_decoding_stepwise-697"><span class="linenos">697</span></a>        <span class="k">return</span> <span class="n">sampled_ids</span>
</span></pre></div>


            <div class="docstring"><p>Generate 1:1 similar to the original MaskGit repo
<a href="https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79">https://github.com/google-research/maskgit/blob/main/maskgit/libml/parallel_decode.py#L79</a></p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="modeling_llada.html#LLaDAModelLM">divisor.mmada.modeling_llada.LLaDAModelLM</a></dt>
                                <dd id="MMadaModelLM.forward" class="function"><a href="modeling_llada.html#LLaDAModelLM.forward">forward</a></dd>
                <dd id="MMadaModelLM.can_generate" class="function"><a href="modeling_llada.html#LLaDAModelLM.can_generate">can_generate</a></dd>
                <dd id="MMadaModelLM.prepare_inputs_for_generation" class="function"><a href="modeling_llada.html#LLaDAModelLM.prepare_inputs_for_generation">prepare_inputs_for_generation</a></dd>
                <dd id="MMadaModelLM.get_input_embeddings" class="function"><a href="modeling_llada.html#LLaDAModelLM.get_input_embeddings">get_input_embeddings</a></dd>
                <dd id="MMadaModelLM.set_input_embeddings" class="function"><a href="modeling_llada.html#LLaDAModelLM.set_input_embeddings">set_input_embeddings</a></dd>
                <dd id="MMadaModelLM.get_output_embeddings" class="function"><a href="modeling_llada.html#LLaDAModelLM.get_output_embeddings">get_output_embeddings</a></dd>
                <dd id="MMadaModelLM.set_output_embeddings" class="function"><a href="modeling_llada.html#LLaDAModelLM.set_output_embeddings">set_output_embeddings</a></dd>
                <dd id="MMadaModelLM.tie_weights" class="function"><a href="modeling_llada.html#LLaDAModelLM.tie_weights">tie_weights</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>